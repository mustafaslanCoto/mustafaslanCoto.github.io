<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.24">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Add date features to data – MUSTAFA ASLAN</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js" integrity="sha384-ZvpUoO/+PpLXR1lu4jmpXWu80pZlYUAfxl5NsBMWOEPSjUn/6Z/hRTt8+pR6L4N2" crossorigin="anonymous"></script><script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../../site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-dc55a5b9e770e841cd82e46aadbfb9b0.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap-1713c1db1ad41a796903378fc9ac7b2b.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdn.jsdelivr.net/npm/requirejs@2.3.6/require.min.js" integrity="sha384-c9c+LnTbwQ3aujuU7ULEPVvgLs+Fn6fJUvIGTsuu1ZcCf11fiEubah0ttpca4ntM sha384-6V1/AdqZRWk1KAlWbKBlGhN7VG4iE/yAZcO6NZPMF8od0vukrvr0tg4qY6NSrItx" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


<link rel="stylesheet" href="../../styles.css">
<meta property="og:title" content="Add date features to data – MUSTAFA ASLAN">
<meta property="og:image" content="https://mustafaslanCoto.github.io/talks/wgsss/occupancy_nb_files/figure-html/cell-10-output-1.png">
<meta property="og:site_name" content="MUSTAFA ASLAN">
<meta property="og:image:height" content="766">
<meta property="og:image:width" content="1966">
</head>

<body class="nav-fixed quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="../../index.html" class="navbar-brand navbar-brand-logo">
    </a>
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">MUSTAFA ASLAN</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../learn/index.html"> 
<span class="menu-text">LEARN</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../workshops/index.html"> 
<span class="menu-text">WORKSHOPS</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../talks/index.html"> 
<span class="menu-text">TALKS</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../CV/CV.html"> 
<span class="menu-text">CV</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools tools-wide">
    <a href="mailto:aslanm@cardiff.ac.uk" title="" class="quarto-navigation-tool px-1" aria-label=""><i class="bi bi-envelope"></i></a>
    <a href="https://github.com/mustafaslanCoto" title="" class="quarto-navigation-tool px-1" aria-label=""><i class="bi bi-github"></i></a>
    <a href="https://www.linkedin.com/in/aslanmu/" title="" class="quarto-navigation-tool px-1" aria-label=""><i class="bi bi-linkedin"></i></a>
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#analysis-on-the-effect-of-weekdays-month-days-etc-on-occupancy-data" id="toc-analysis-on-the-effect-of-weekdays-month-days-etc-on-occupancy-data" class="nav-link active" data-scroll-target="#analysis-on-the-effect-of-weekdays-month-days-etc-on-occupancy-data">Analysis on the effect of weekdays, month days etc on occupancy data</a></li>
  <li><a href="#weekly-occupancy-for-each-ward" id="toc-weekly-occupancy-for-each-ward" class="nav-link" data-scroll-target="#weekly-occupancy-for-each-ward">Weekly Occupancy for Each Ward</a></li>
  <li><a href="#occupancy-by-day-of-month-for-each-month" id="toc-occupancy-by-day-of-month-for-each-month" class="nav-link" data-scroll-target="#occupancy-by-day-of-month-for-each-month">Occupancy by day of month for each month</a></li>
  <li><a href="#occupancy-by-each-month-for-eaxh-year" id="toc-occupancy-by-each-month-for-eaxh-year" class="nav-link" data-scroll-target="#occupancy-by-each-month-for-eaxh-year">Occupancy by each month for eaxh year</a></li>
  <li><a href="#occupancy-by-weekends" id="toc-occupancy-by-weekends" class="nav-link" data-scroll-target="#occupancy-by-weekends">Occupancy by weekends</a></li>
  <li><a href="#occupancy-by-the-week-of-year" id="toc-occupancy-by-the-week-of-year" class="nav-link" data-scroll-target="#occupancy-by-the-week-of-year">Occupancy by the week of year</a></li>
  <li><a href="#change-point-and-outlier-detection-methods" id="toc-change-point-and-outlier-detection-methods" class="nav-link" data-scroll-target="#change-point-and-outlier-detection-methods">Change point and outlier detection methods</a></li>
  <li><a href="#ward-0---change-point-detection-and-imputation" id="toc-ward-0---change-point-detection-and-imputation" class="nav-link" data-scroll-target="#ward-0---change-point-detection-and-imputation">Ward 0 - Change point detection and imputation</a></li>
  <li><a href="#ward-1---change-point-detection-and-imputation" id="toc-ward-1---change-point-detection-and-imputation" class="nav-link" data-scroll-target="#ward-1---change-point-detection-and-imputation">Ward 1 - Change point detection and imputation</a></li>
  <li><a href="#ward-2---change-point-detection-and-imputation" id="toc-ward-2---change-point-detection-and-imputation" class="nav-link" data-scroll-target="#ward-2---change-point-detection-and-imputation">Ward 2 - Change point detection and imputation</a></li>
  <li><a href="#ward-3---change-point-detection-and-imputation" id="toc-ward-3---change-point-detection-and-imputation" class="nav-link" data-scroll-target="#ward-3---change-point-detection-and-imputation">Ward 3 - Change point detection and imputation</a></li>
  <li><a href="#ward-4---change-point-detection-and-imputation" id="toc-ward-4---change-point-detection-and-imputation" class="nav-link" data-scroll-target="#ward-4---change-point-detection-and-imputation">Ward 4 - Change point detection and imputation</a></li>
  <li><a href="#ward-5---change-point-detection-and-imputation" id="toc-ward-5---change-point-detection-and-imputation" class="nav-link" data-scroll-target="#ward-5---change-point-detection-and-imputation">Ward 5 - Change point detection and imputation</a></li>
  <li><a href="#ward-6---change-point-detection-and-imputation" id="toc-ward-6---change-point-detection-and-imputation" class="nav-link" data-scroll-target="#ward-6---change-point-detection-and-imputation">Ward 6 - Change point detection and imputation</a></li>
  <li><a href="#guerrero-transformation" id="toc-guerrero-transformation" class="nav-link" data-scroll-target="#guerrero-transformation">guerrero transformation</a></li>
  <li><a href="#acf-test-and-pacf-test" id="toc-acf-test-and-pacf-test" class="nav-link" data-scroll-target="#acf-test-and-pacf-test">ACF test and PACF test</a></li>
  <li><a href="#ets-results" id="toc-ets-results" class="nav-link" data-scroll-target="#ets-results">ETS results</a></li>
  <li><a href="#lr-cv-results" id="toc-lr-cv-results" class="nav-link" data-scroll-target="#lr-cv-results">LR CV results</a></li>
  <li><a href="#ml-ressults" id="toc-ml-ressults" class="nav-link" data-scroll-target="#ml-ressults">ML ressults</a></li>
  <li><a href="#hmm-results" id="toc-hmm-results" class="nav-link" data-scroll-target="#hmm-results">HMM results</a></li>
  <li><a href="#all-results" id="toc-all-results" class="nav-link" data-scroll-target="#all-results">all results</a></li>
  <li><a href="#decomposition" id="toc-decomposition" class="nav-link" data-scroll-target="#decomposition">Decomposition</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Add date features to data</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<div id="ad145e36" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># import libraries</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> plotly.express <span class="im">as</span> px</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="co"># allow max rows to be displayed</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>pd.set_option(<span class="st">'display.max_columns'</span>, <span class="va">None</span>)</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>pd.set_option(<span class="st">'display.max_rows'</span>, <span class="dv">50</span>)</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="co"># ignore warnings</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> warnings</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>warnings.filterwarnings(<span class="st">'ignore'</span>)</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> xgboost <span class="im">import</span> XGBRegressor</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> lightgbm <span class="im">import</span> LGBMRegressor</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> catboost <span class="im">import</span> CatBoostRegressor</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.linear_model <span class="im">import</span> LinearRegression, Ridge, Lasso, ElasticNet</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.model_selection <span class="im">import</span> TimeSeriesSplit, KFold</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> mean_squared_error, r2_score, mean_absolute_error, root_mean_squared_error</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.preprocessing <span class="im">import</span> StandardScaler, MinMaxScaler</span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.pipeline <span class="im">import</span> Pipeline       </span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.compose <span class="im">import</span> ColumnTransformer</span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.impute <span class="im">import</span> SimpleImputer</span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.ensemble <span class="im">import</span> RandomForestRegressor, HistGradientBoostingRegressor, AdaBoostRegressor, GradientBoostingRegressor</span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> cubist <span class="im">import</span> Cubist</span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> hyperopt <span class="im">import</span> fmin, tpe, hp, Trials, STATUS_OK, space_eval</span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> hyperopt.pyll <span class="im">import</span> scope</span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a>pd.set_option(<span class="st">'display.max_rows'</span>, <span class="dv">150</span>)</span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pickle <span class="co"># for saving and loading models</span></span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> statsmodels.tsa.holtwinters <span class="im">import</span> ExponentialSmoothing</span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> statsmodels.tsa.seasonal <span class="im">import</span> seasonal_decompose, MSTL</span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.tree <span class="im">import</span> DecisionTreeRegressor</span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> peshbeen.models <span class="im">import</span> (ml_forecaster, ml_bidirect_forecaster, VARModel, MsHmmRegression, MsHmmVar)</span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> peshbeen.model_selection <span class="im">import</span> (cross_validate,  mv_cross_validate,</span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a>                                      cv_tune, mv_cv_tune, prob_param_forecasts,</span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a>                                      tune_ets, tune_sarima, ParametricTimeSeriesSplit,</span>
<span id="cb1-39"><a href="#cb1-39" aria-hidden="true" tabindex="-1"></a>                                      forward_feature_selection, backward_feature_selection,</span>
<span id="cb1-40"><a href="#cb1-40" aria-hidden="true" tabindex="-1"></a>                                      mv_forward_feature_selection, mv_backward_feature_selection,</span>
<span id="cb1-41"><a href="#cb1-41" aria-hidden="true" tabindex="-1"></a>                                      hmm_forward_feature_selection, hmm_backward_feature_selection,</span>
<span id="cb1-42"><a href="#cb1-42" aria-hidden="true" tabindex="-1"></a>                                      hmm_mv_forward_feature_selection, hmm_mv_backward_feature_selection,</span>
<span id="cb1-43"><a href="#cb1-43" aria-hidden="true" tabindex="-1"></a>                                      hmm_cross_validate, hmm_mv_cross_validate, cv_lag_tune, </span>
<span id="cb1-44"><a href="#cb1-44" aria-hidden="true" tabindex="-1"></a>                                      cv_hmm_lag_tune)</span>
<span id="cb1-45"><a href="#cb1-45" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> peshbeen.statplots <span class="im">import</span> (plot_ccf, plot_PACF_ACF)</span>
<span id="cb1-46"><a href="#cb1-46" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> peshbeen.stattools <span class="im">import</span> (unit_root_test, cross_autocorrelation,</span>
<span id="cb1-47"><a href="#cb1-47" aria-hidden="true" tabindex="-1"></a>                                lr_trend_model, forecast_trend, pacf_strength, ccf_strength)</span>
<span id="cb1-48"><a href="#cb1-48" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> peshbeen.transformations <span class="im">import</span> (fourier_terms, rolling_quantile,</span>
<span id="cb1-49"><a href="#cb1-49" aria-hidden="true" tabindex="-1"></a>                        rolling_mean, rolling_std, expanding_mean, expanding_std,</span>
<span id="cb1-50"><a href="#cb1-50" aria-hidden="true" tabindex="-1"></a>                        expanding_quantile, expanding_ets, box_cox_transform,</span>
<span id="cb1-51"><a href="#cb1-51" aria-hidden="true" tabindex="-1"></a>                        back_box_cox_transform,undiff_ts, seasonal_diff, invert_seasonal_diff,</span>
<span id="cb1-52"><a href="#cb1-52" aria-hidden="true" tabindex="-1"></a>                        nzInterval, zeroCumulative, kfold_target_encoder, target_encoder_for_test)</span>
<span id="cb1-53"><a href="#cb1-53" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> peshbeen.metrics <span class="im">import</span> (MAPE, MASE, MSE, MAE, RMSE, SMAPE, CFE, CFE_ABS, WMAPE, SRMSE, RMSSE, SMAE)</span>
<span id="cb1-54"><a href="#cb1-54" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> peshbeen.prob_forecast <span class="im">import</span> (ml_conformalizer, hmm_conformalizer, ets_conformalizer, bidirect_ts_conformalizer, var_conformalizer, bag_boost_aggr_conformalizer,</span>
<span id="cb1-55"><a href="#cb1-55" aria-hidden="true" tabindex="-1"></a>                                       bidirect_aggr_conformalizer, ets_aggr_conformalizer, s_arima_aggr_conformalizer,</span>
<span id="cb1-56"><a href="#cb1-56" aria-hidden="true" tabindex="-1"></a>                                       var_aggr_conformalizer, hmm_var_conformalizer)</span>
<span id="cb1-57"><a href="#cb1-57" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sktime.transformations.series.boxcox <span class="im">import</span> BoxCoxTransformer</span>
<span id="cb1-58"><a href="#cb1-58" aria-hidden="true" tabindex="-1"></a>sns.set_context(<span class="st">"talk"</span>)</span>
<span id="cb1-59"><a href="#cb1-59" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> statsmodels.tsa.seasonal <span class="im">import</span> STL, MSTL</span>
<span id="cb1-60"><a href="#cb1-60" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> statsmodels.nonparametric.smoothers_lowess <span class="im">import</span> lowess</span>
<span id="cb1-61"><a href="#cb1-61" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> statsmodels.graphics.tsaplots <span class="im">import</span> plot_acf, plot_pacf</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="75006017" class="cell" data-execution_count="2">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># import excel file</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>occupancy_hrs <span class="op">=</span> pd.read_excel(<span class="st">'hr_occupancy_df.xlsx'</span>)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>occupancy_hrs.set_index(<span class="st">'Date'</span>, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>ward_cols_ <span class="op">=</span> occupancy_hrs.columns[:<span class="op">-</span><span class="dv">1</span>].tolist()</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>occupancy_hrs.rename(columns<span class="op">=</span>{col: <span class="st">"ward_"</span> <span class="op">+</span> <span class="bu">str</span>(i) <span class="cf">for</span> i, col <span class="kw">in</span> <span class="bu">enumerate</span>(ward_cols_)}, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>ward_cols_ <span class="op">=</span> occupancy_hrs.columns[:<span class="op">-</span><span class="dv">1</span>].tolist()</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="co"># assign NA any values below 24</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>occupancy_hrs[occupancy_hrs <span class="op">&lt;=</span> <span class="dv">24</span>] <span class="op">=</span> np.nan</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a><span class="co"># ## Add month name and week day</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a><span class="co"># occupancy_hrs['month'] = occupancy_hrs.index.month_name()</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a><span class="co"># occupancy_hrs['week_day'] = occupancy_hrs.index.day_name()</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="51bef9e6" class="cell" data-execution_count="3">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>ward_cols_</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="3">
<pre><code>['ward_0', 'ward_1', 'ward_2', 'ward_3', 'ward_4', 'ward_5', 'ward_6']</code></pre>
</div>
</div>
<div id="734f1097" class="cell" data-execution_count="3">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># import refer_source and followup excel file</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>refer_source <span class="op">=</span> pd.read_excel(<span class="st">'refer_source.xlsx'</span>)</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>followup <span class="op">=</span> pd.read_excel(<span class="st">'followup_service.xlsx'</span>)</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>cmht_refer_df <span class="op">=</span> refer_source[[<span class="st">"refer_date"</span>, <span class="st">"CMHT"</span>]]</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>cmht_refer_df.rename(columns <span class="op">=</span> {<span class="st">"refer_date"</span>: <span class="st">"Date"</span>, <span class="st">"CMHT"</span>: <span class="st">"cmht_refer"</span>}, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>cmht_refer_df.set_index(<span class="st">"Date"</span>, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>cmht_followup_df <span class="op">=</span> followup[[<span class="st">"disc_date"</span>, <span class="st">"CMHRS"</span>]]</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>cmht_followup_df.rename(columns <span class="op">=</span> {<span class="st">"disc_date"</span>: <span class="st">"Date"</span>, <span class="st">"CMHRS"</span>: <span class="st">"cmht_followup"</span>}, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>cmht_followup_df.set_index(<span class="st">"Date"</span>, inplace<span class="op">=</span><span class="va">True</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="0ebca215" class="cell" data-execution_count="4">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="co"># convert hourly occupancy to daily occupancy so we can approximate dailly number of patients</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>occupancy_days <span class="op">=</span> occupancy_hrs.copy()</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>occupancy_days[[<span class="st">"ward_0"</span>, <span class="st">"ward_1"</span>, <span class="st">"ward_2"</span>, <span class="st">"ward_3"</span>, <span class="st">"ward_4"</span>, <span class="st">"ward_5"</span>, <span class="st">"ward_6"</span>]] <span class="op">=</span> (</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>    (occupancy_hrs[[<span class="st">"ward_0"</span>, <span class="st">"ward_1"</span>, <span class="st">"ward_2"</span>, <span class="st">"ward_3"</span>, <span class="st">"ward_4"</span>, <span class="st">"ward_5"</span>, <span class="st">"ward_6"</span>]] <span class="op">/</span> <span class="dv">24</span>)</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>    .<span class="bu">round</span>(<span class="dv">0</span>)</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>occupancy_days[<span class="st">"total"</span>] <span class="op">=</span> occupancy_days[[<span class="st">"ward_0"</span>, <span class="st">"ward_1"</span>, <span class="st">"ward_2"</span>, <span class="st">"ward_3"</span>, <span class="st">"ward_4"</span>, <span class="st">"ward_5"</span>, <span class="st">"ward_6"</span>]].<span class="bu">sum</span>(axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>occupancy_days <span class="op">=</span> occupancy_days.merge(cmht_refer_df, left_index<span class="op">=</span><span class="va">True</span>, right_index<span class="op">=</span><span class="va">True</span>, how<span class="op">=</span><span class="st">'left'</span>, validate<span class="op">=</span><span class="st">'one_to_one'</span>)</span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>occupancy_days <span class="op">=</span> occupancy_days.merge(cmht_followup_df, left_index<span class="op">=</span><span class="va">True</span>, right_index<span class="op">=</span><span class="va">True</span>, how<span class="op">=</span><span class="st">'left'</span>, validate<span class="op">=</span><span class="st">'one_to_one'</span>)</span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>holidays <span class="op">=</span> pd.read_excel(<span class="st">'holidays_eng.xlsx'</span>, index_col<span class="op">=</span><span class="st">'Date'</span>)</span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>holidays.index <span class="op">=</span> pd.to_datetime(holidays.index)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="b9370d2e" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># fig, ax = plt.subplots(2, 3, figsize=(15, 8))</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="co"># # for i, ward in enumerate(ward_cols_):</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="co"># ward_num = 0</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="co"># for j in range(2):</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="co">#     for k in range(3):</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a><span class="co">#         ax[j, k].plot(occupancy_days.index, occupancy_days[f"ward_{ward_num}"], label=f"Ward {ward_num}")</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a><span class="co">#         ax[j, k].set_title(f"Ward {ward_num} Occupancy")</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a><span class="co">#         # ax[j, k].legend()</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a><span class="co">#         ward_num += 1</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a><span class="co"># plt.tight_layout()</span></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a><span class="co"># plt.show()</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="a1884178" class="cell" data-execution_count="5">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>occupancy_days[<span class="st">"day_of_week"</span>] <span class="op">=</span> occupancy_days.index.weekday</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>occupancy_days[<span class="st">"day_of_month"</span>] <span class="op">=</span> occupancy_days.index.day</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>occupancy_days[<span class="st">"month"</span>] <span class="op">=</span> occupancy_days.index.month</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>occupancy_days[<span class="st">"week_of_year"</span>] <span class="op">=</span> occupancy_days.index.isocalendar().week</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>occupancy_days[<span class="st">"is_weekend"</span>] <span class="op">=</span> occupancy_days[<span class="st">"day_of_week"</span>].isin([<span class="dv">5</span>, <span class="dv">6</span>])</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>occupancy_days[<span class="st">"year"</span>] <span class="op">=</span> occupancy_days.index.year</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>occupancy <span class="op">=</span> occupancy_days.merge(holidays, left_index<span class="op">=</span><span class="va">True</span>, right_index<span class="op">=</span><span class="va">True</span>, how<span class="op">=</span><span class="st">'left'</span>)</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>occupancy[<span class="st">"holiday"</span>].fillna(<span class="st">"not_holiday"</span>, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>occupancy[<span class="st">"is_holiday"</span>] <span class="op">=</span> occupancy[<span class="st">"holiday"</span>].<span class="bu">apply</span>(<span class="kw">lambda</span> x: <span class="st">"holiday"</span> <span class="cf">if</span> x <span class="op">!=</span> <span class="st">"not_holiday"</span> else<span class="st">"not_holiday"</span>)</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>fourier_term <span class="op">=</span> fourier_terms(start_end_index<span class="op">=</span>[occupancy_days.index.<span class="bu">min</span>(), occupancy_days.index.<span class="bu">max</span>()], period<span class="op">=</span><span class="fl">365.25</span>, num_terms<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>occupancy <span class="op">=</span> occupancy.merge(fourier_term, left_index<span class="op">=</span><span class="va">True</span>, right_index<span class="op">=</span><span class="va">True</span>, how<span class="op">=</span><span class="st">'left'</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="d4c54f0b" class="cell" data-execution_count="6">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># train-test split for both dataset and test size is 30 days for both datasets occupancy_hrs and occupancy_fourier</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>train_size <span class="op">=</span> <span class="bu">len</span>(occupancy) <span class="op">-</span> <span class="dv">360</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>occup_train <span class="op">=</span> occupancy[:train_size]</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>occup_test <span class="op">=</span> occupancy[train_size:]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<section id="analysis-on-the-effect-of-weekdays-month-days-etc-on-occupancy-data" class="level2">
<h2 class="anchored" data-anchor-id="analysis-on-the-effect-of-weekdays-month-days-etc-on-occupancy-data">Analysis on the effect of weekdays, month days etc on occupancy data</h2>
</section>
<section id="weekly-occupancy-for-each-ward" class="level2">
<h2 class="anchored" data-anchor-id="weekly-occupancy-for-each-ward">Weekly Occupancy for Each Ward</h2>
<div id="928ae632" class="cell" data-execution_count="10">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>wards <span class="op">=</span> [<span class="ss">f"ward_</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">"</span> <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">7</span>)]  <span class="co"># e.g. 7 wards (0..6)</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>n_plots <span class="op">=</span> <span class="bu">len</span>(wards)</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="co"># create a grid with enough slots (2 rows, 4 cols = 8 slots here)</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(<span class="dv">2</span>, <span class="dv">4</span>, figsize<span class="op">=</span>(<span class="dv">20</span>, <span class="dv">8</span>))</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>axes <span class="op">=</span> axes.flatten()  <span class="co"># flatten to index linearly</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> ax, ward_col <span class="kw">in</span> <span class="bu">zip</span>(axes[:n_plots], wards):</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Plot each week's data (less transparent)</span></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>        ward <span class="op">=</span> occup_train.pivot_table(index<span class="op">=</span><span class="st">"day_of_week"</span>, columns<span class="op">=</span><span class="st">"week_of_year"</span>, values<span class="op">=</span>ward_col, aggfunc<span class="op">=</span><span class="st">'mean'</span>).reset_index()</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>        mean <span class="op">=</span> occup_train.groupby(<span class="st">'day_of_week'</span>)[ward_col].mean()</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> week <span class="kw">in</span> ward.columns[<span class="dv">1</span>:]:</span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>            ax.plot(ward.index, ward[week], alpha<span class="op">=</span><span class="fl">0.2</span>)  <span class="co"># Less transparent</span></span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Plot average of all weeks (more transparent, thicker line)</span></span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>        ax.plot(mean.index, mean, color<span class="op">=</span><span class="st">'black'</span>, linewidth<span class="op">=</span><span class="dv">2</span>, alpha<span class="op">=</span><span class="fl">0.9</span>, label<span class="op">=</span><span class="st">'Weekly Average'</span>)  <span class="co"># More transparent</span></span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>        ax.set_xlabel(<span class="st">"Day of Week"</span>, fontsize<span class="op">=</span><span class="dv">9</span>)</span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>        ax.tick_params(axis<span class="op">=</span><span class="st">'both'</span>, labelsize<span class="op">=</span><span class="dv">8</span>)  <span class="co"># &lt;-- Correct way</span></span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>        ax.set_ylabel(<span class="st">"Occupancy"</span>, fontsize<span class="op">=</span><span class="dv">9</span>)</span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a>        ax.set_title(<span class="ss">f"Weekly Occupancy for ward </span><span class="sc">{</span>ward_col<span class="sc">}</span><span class="ss">"</span>, fontsize<span class="op">=</span><span class="dv">9</span>)</span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a>        ax.legend(fontsize <span class="op">=</span> <span class="dv">9</span>)  <span class="co"># &lt;-- Only 'Weekly Average' will show up</span></span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a><span class="co"># remove any unused axes (if grid has more slots than n_plots)</span></span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> ax <span class="kw">in</span> axes[n_plots:]:</span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a>    fig.delaxes(ax)</span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="occupancy_nb_files/figure-html/cell-10-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="occupancy-by-day-of-month-for-each-month" class="level2">
<h2 class="anchored" data-anchor-id="occupancy-by-day-of-month-for-each-month">Occupancy by day of month for each month</h2>
<div id="d9f7ae7d" class="cell" data-execution_count="14">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>year_df <span class="op">=</span> occup_train[occup_train[<span class="st">"year"</span>].isin([<span class="dv">2019</span>, <span class="dv">2020</span>, <span class="dv">2021</span>, <span class="dv">2022</span>, <span class="dv">2023</span>])]</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="co"># choose how many wards to plot</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>wards <span class="op">=</span> [<span class="ss">f"ward_</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">"</span> <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">7</span>)]  <span class="co"># e.g. 7 wards (0..6)</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>n_plots <span class="op">=</span> <span class="bu">len</span>(wards)</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a><span class="co"># create a grid with enough slots (2 rows, 4 cols = 8 slots here)</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(<span class="dv">2</span>, <span class="dv">4</span>, figsize<span class="op">=</span>(<span class="dv">20</span>, <span class="dv">8</span>))</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>axes <span class="op">=</span> axes.flatten()  <span class="co"># flatten to index linearly</span></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> ax, ward_col <span class="kw">in</span> <span class="bu">zip</span>(axes[:n_plots], wards):</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Plot each week's data (less transparent)</span></span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>        ward <span class="op">=</span> occup_train.pivot_table(index<span class="op">=</span><span class="st">"day_of_month"</span>, columns<span class="op">=</span><span class="st">"month"</span>, values<span class="op">=</span>ward_col, aggfunc<span class="op">=</span><span class="st">'mean'</span>).reset_index()</span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>        mean <span class="op">=</span> occup_train.groupby(<span class="st">'day_of_month'</span>)[ward_col].mean()</span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> week <span class="kw">in</span> ward.columns[<span class="dv">1</span>:]:</span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>            ax.plot(ward.index, ward[week], alpha<span class="op">=</span><span class="fl">0.2</span>)  <span class="co"># Less transparent</span></span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Plot average of all weeks (more transparent, thicker line)</span></span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>        ax.plot(mean.index, mean, color<span class="op">=</span><span class="st">'black'</span>, linewidth<span class="op">=</span><span class="dv">2</span>, alpha<span class="op">=</span><span class="fl">0.9</span>, label<span class="op">=</span><span class="st">'Monthly Average'</span>)  <span class="co"># More transparent</span></span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a>        ax.set_xlabel(<span class="st">"Day of Month"</span>, fontsize<span class="op">=</span><span class="dv">9</span>)</span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a>        ax.tick_params(axis<span class="op">=</span><span class="st">'both'</span>, labelsize<span class="op">=</span><span class="dv">9</span>)  <span class="co"># &lt;-- Correct way</span></span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a>        ax.tick_params(axis<span class="op">=</span><span class="st">'x'</span>, labelsize<span class="op">=</span><span class="dv">10</span>)  <span class="co"># x-axis tick labels size</span></span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a>        ax.tick_params(axis<span class="op">=</span><span class="st">'y'</span>, labelsize<span class="op">=</span><span class="dv">12</span>) <span class="co"># y-axis tick labels size</span></span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a>        ax.set_ylabel(<span class="st">"Occupancy"</span>, fontsize<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a>        ax.set_title(<span class="ss">f"Monthly Occupancy for </span><span class="sc">{</span>ward_col<span class="sc">}</span><span class="ss">"</span>, fontsize<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a>        ax.legend(loc<span class="op">=</span><span class="st">'upper right'</span>, fontsize<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a><span class="co"># remove any unused axes (if grid has more slots than n_plots)</span></span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> ax <span class="kw">in</span> axes[n_plots:]:</span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true" tabindex="-1"></a>    fig.delaxes(ax)</span>
<span id="cb11-31"><a href="#cb11-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-32"><a href="#cb11-32" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb11-33"><a href="#cb11-33" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="occupancy_nb_files/figure-html/cell-11-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="34de398d" class="cell" data-execution_count="15">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>year_df <span class="op">=</span> occup_train[occup_train[<span class="st">"year"</span>].isin([<span class="dv">2019</span>, <span class="dv">2020</span>, <span class="dv">2021</span>, <span class="dv">2022</span>, <span class="dv">2023</span>])]</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="co"># choose how many wards to plot</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>wards <span class="op">=</span> [<span class="ss">f"ward_</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">"</span> <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">7</span>)]  <span class="co"># e.g. 7 wards (0..6)</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>n_plots <span class="op">=</span> <span class="bu">len</span>(wards)</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a><span class="co"># create a grid with enough slots (2 rows, 4 cols = 8 slots here)</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(<span class="dv">2</span>, <span class="dv">4</span>, figsize<span class="op">=</span>(<span class="dv">20</span>, <span class="dv">8</span>))</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>axes <span class="op">=</span> axes.flatten()  <span class="co"># flatten to index linearly</span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> ax, ward_col <span class="kw">in</span> <span class="bu">zip</span>(axes[:n_plots], wards):</span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Plot each week's data (less transparent)</span></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>        ward <span class="op">=</span> occup_train.pivot_table(index<span class="op">=</span><span class="st">"month"</span>, columns<span class="op">=</span><span class="st">"day_of_month"</span>, values<span class="op">=</span>ward_col, aggfunc<span class="op">=</span><span class="st">'mean'</span>).reset_index()</span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>        mean <span class="op">=</span> occup_train.groupby(<span class="st">'month'</span>)[ward_col].mean()</span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> week <span class="kw">in</span> ward.columns[<span class="dv">1</span>:]:</span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>            ax.plot(ward.index, ward[week], alpha<span class="op">=</span><span class="fl">0.2</span>)  <span class="co"># Less transparent</span></span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Plot average of all weeks (more transparent, thicker line)</span></span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a>        ax.plot(mean.index, mean, color<span class="op">=</span><span class="st">'black'</span>, linewidth<span class="op">=</span><span class="dv">2</span>, alpha<span class="op">=</span><span class="fl">0.9</span>, label<span class="op">=</span><span class="st">'Monthly Average'</span>)  <span class="co"># More transparent</span></span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a>        ax.set_xlabel(<span class="st">"Day of Month"</span>, fontsize<span class="op">=</span><span class="dv">9</span>)</span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a>        ax.tick_params(axis<span class="op">=</span><span class="st">'both'</span>, labelsize<span class="op">=</span><span class="dv">9</span>)  <span class="co"># &lt;-- Correct way</span></span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a>        ax.tick_params(axis<span class="op">=</span><span class="st">'x'</span>, labelsize<span class="op">=</span><span class="dv">10</span>)  <span class="co"># x-axis tick labels size</span></span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a>        ax.tick_params(axis<span class="op">=</span><span class="st">'y'</span>, labelsize<span class="op">=</span><span class="dv">12</span>) <span class="co"># y-axis tick labels size</span></span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a>        ax.set_ylabel(<span class="st">"Occupancy"</span>, fontsize<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a>        ax.set_title(<span class="ss">f"Monthly Occupancy for </span><span class="sc">{</span>ward_col<span class="sc">}</span><span class="ss">"</span>, fontsize<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a>        ax.legend(loc<span class="op">=</span><span class="st">'upper right'</span>, fontsize<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-28"><a href="#cb12-28" aria-hidden="true" tabindex="-1"></a><span class="co"># remove any unused axes (if grid has more slots than n_plots)</span></span>
<span id="cb12-29"><a href="#cb12-29" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> ax <span class="kw">in</span> axes[n_plots:]:</span>
<span id="cb12-30"><a href="#cb12-30" aria-hidden="true" tabindex="-1"></a>    fig.delaxes(ax)</span>
<span id="cb12-31"><a href="#cb12-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-32"><a href="#cb12-32" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb12-33"><a href="#cb12-33" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="occupancy_nb_files/figure-html/cell-12-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="occupancy-by-each-month-for-eaxh-year" class="level2">
<h2 class="anchored" data-anchor-id="occupancy-by-each-month-for-eaxh-year">Occupancy by each month for eaxh year</h2>
<div id="b06d2bd0" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>year_df <span class="op">=</span> occup_train[occup_train[<span class="st">"year"</span>].isin([<span class="dv">2019</span>, <span class="dv">2020</span>, <span class="dv">2021</span>, <span class="dv">2022</span>, <span class="dv">2023</span>])]</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="co"># choose how many wards to plot</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>wards <span class="op">=</span> [<span class="ss">f"ward_</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">"</span> <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">7</span>)]  <span class="co"># e.g. 7 wards (0..6)</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>n_plots <span class="op">=</span> <span class="bu">len</span>(wards)</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a><span class="co"># create a grid with enough slots (2 rows, 4 cols = 8 slots here)</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(<span class="dv">2</span>, <span class="dv">4</span>, figsize<span class="op">=</span>(<span class="dv">20</span>, <span class="dv">8</span>))</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>axes <span class="op">=</span> axes.flatten()  <span class="co"># flatten to index linearly</span></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> ax, ward_col <span class="kw">in</span> <span class="bu">zip</span>(axes[:n_plots], wards):</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>    ward <span class="op">=</span> year_df.pivot_table(index<span class="op">=</span><span class="st">"month"</span>, columns<span class="op">=</span><span class="st">"year"</span>,</span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>                               values<span class="op">=</span>ward_col, aggfunc<span class="op">=</span><span class="st">'mean'</span>).reset_index()</span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>    mean <span class="op">=</span> year_df.groupby(<span class="st">'month'</span>)[ward_col].mean()</span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># plot each year's monthly line (faint)</span></span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> year <span class="kw">in</span> ward.columns[<span class="dv">1</span>:]:</span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a>        ax.plot(ward[<span class="st">'month'</span>], ward[year], alpha<span class="op">=</span><span class="fl">0.2</span>)</span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># plot yearly average (bold)</span></span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a>    ax.plot(mean.index, mean, color<span class="op">=</span><span class="st">'black'</span>, linewidth<span class="op">=</span><span class="dv">2</span>, alpha<span class="op">=</span><span class="fl">0.9</span>, label<span class="op">=</span><span class="st">'Yearly Average'</span>)</span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ticks/labels</span></span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a>    ax.set_xlabel(<span class="st">"Month"</span>, fontsize<span class="op">=</span><span class="dv">9</span>)</span>
<span id="cb13-25"><a href="#cb13-25" aria-hidden="true" tabindex="-1"></a>    ax.set_xticks(ward[<span class="st">'month'</span>])                         <span class="co"># positions = month labels</span></span>
<span id="cb13-26"><a href="#cb13-26" aria-hidden="true" tabindex="-1"></a>    ax.set_xticklabels(ward[<span class="st">'month'</span>], rotation<span class="op">=</span><span class="dv">45</span>, fontsize<span class="op">=</span><span class="dv">9</span>)  <span class="co"># show month names</span></span>
<span id="cb13-27"><a href="#cb13-27" aria-hidden="true" tabindex="-1"></a>    ax.tick_params(axis<span class="op">=</span><span class="st">'y'</span>, labelsize<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb13-28"><a href="#cb13-28" aria-hidden="true" tabindex="-1"></a>    ax.set_ylabel(<span class="st">"Occupancy"</span>, fontsize<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb13-29"><a href="#cb13-29" aria-hidden="true" tabindex="-1"></a>    ax.set_title(<span class="ss">f"Monthly Occupancy for </span><span class="sc">{</span>ward_col<span class="sc">}</span><span class="ss">"</span>, fontsize<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb13-30"><a href="#cb13-30" aria-hidden="true" tabindex="-1"></a>    ax.legend(loc<span class="op">=</span><span class="st">'upper right'</span>, fontsize<span class="op">=</span><span class="dv">8</span>, ncol<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb13-31"><a href="#cb13-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-32"><a href="#cb13-32" aria-hidden="true" tabindex="-1"></a><span class="co"># remove any unused axes (if grid has more slots than n_plots)</span></span>
<span id="cb13-33"><a href="#cb13-33" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> ax <span class="kw">in</span> axes[n_plots:]:</span>
<span id="cb13-34"><a href="#cb13-34" aria-hidden="true" tabindex="-1"></a>    fig.delaxes(ax)</span>
<span id="cb13-35"><a href="#cb13-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-36"><a href="#cb13-36" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb13-37"><a href="#cb13-37" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="occupancy_nb_files/figure-html/cell-13-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="occupancy-by-weekends" class="level2">
<h2 class="anchored" data-anchor-id="occupancy-by-weekends">Occupancy by weekends</h2>
<div id="32be7524" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(<span class="dv">2</span>, <span class="dv">4</span>, figsize<span class="op">=</span>(<span class="dv">20</span>, <span class="dv">8</span>))</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>axes <span class="op">=</span> axes.flatten()             <span class="co"># 8 axes, indexed 0..7</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>year_df <span class="op">=</span> occup_train[occup_train[<span class="st">"year"</span>].isin([<span class="dv">2019</span>, <span class="dv">2020</span>, <span class="dv">2021</span>, <span class="dv">2022</span>, <span class="dv">2023</span>])]</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> ward_num, ax <span class="kw">in</span> <span class="bu">enumerate</span>(axes[:<span class="dv">7</span>]):   <span class="co"># only use the first 7 axes</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>        mean <span class="op">=</span> occup_train.groupby(<span class="st">'is_weekend'</span>)[<span class="ss">f"ward_</span><span class="sc">{</span>ward_num<span class="sc">}</span><span class="ss">"</span>].mean()</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>        ax.bar(mean.index, mean, color<span class="op">=</span><span class="st">'C0'</span>, alpha<span class="op">=</span><span class="fl">0.9</span>)</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>        <span class="co"># ax[i, j].bar(mean.index, mean, color='black', linewidth=2, alpha=0.9, label='Monthly Average')  # More transparent</span></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>        ax.set_xlabel(<span class="st">"is weekend"</span>, fontsize<span class="op">=</span><span class="dv">9</span>)</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>        ax.set_xticks([<span class="dv">0</span>, <span class="dv">1</span>], [<span class="st">"Weekday"</span>, <span class="st">"Weekend"</span>], fontsize<span class="op">=</span><span class="dv">12</span>)  <span class="co"># &lt;-- this changes tick labels</span></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>        ax.tick_params(axis<span class="op">=</span><span class="st">'x'</span>, labelsize<span class="op">=</span><span class="dv">10</span>)  <span class="co"># x-axis tick labels size</span></span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>        ax.tick_params(axis<span class="op">=</span><span class="st">'y'</span>, labelsize<span class="op">=</span><span class="dv">12</span>) <span class="co"># y-axis tick labels size</span></span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>        ax.set_ylabel(<span class="st">"Occupancy"</span>, fontsize<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>        ax.set_title(<span class="ss">f"Monthly Occupancy for ward </span><span class="sc">{</span>ward_num<span class="sc">}</span><span class="ss">"</span>, fontsize<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>        ax.legend(loc<span class="op">=</span><span class="st">'upper right'</span>, fontsize<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Optionally remove/hide any remaining axes (here there is one left)</span></span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> ax <span class="kw">in</span> axes[<span class="dv">7</span>:]:</span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a>    fig.delaxes(ax)            <span class="co"># removes the empty subplot from figure</span></span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="occupancy_nb_files/figure-html/cell-14-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="4650f00b" class="cell" data-execution_count="16">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(<span class="dv">2</span>, <span class="dv">4</span>, figsize<span class="op">=</span>(<span class="dv">20</span>, <span class="dv">8</span>))</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>axes <span class="op">=</span> axes.flatten()             <span class="co"># 8 axes, indexed 0..7</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>year_df <span class="op">=</span> occup_train[occup_train[<span class="st">"year"</span>].isin([<span class="dv">2019</span>, <span class="dv">2020</span>, <span class="dv">2021</span>, <span class="dv">2022</span>, <span class="dv">2023</span>])]</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> ward_num, ax <span class="kw">in</span> <span class="bu">enumerate</span>(axes[:<span class="dv">7</span>]):   <span class="co"># only use the first 7 axes</span></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>    sns.boxplot(x<span class="op">=</span><span class="st">'is_holiday'</span>, y<span class="op">=</span><span class="ss">f'ward_</span><span class="sc">{</span>ward_num<span class="sc">}</span><span class="ss">'</span>, data<span class="op">=</span>year_df, hue<span class="op">=</span><span class="st">'year'</span>,</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>                palette<span class="op">=</span><span class="st">"Set3"</span>, ax<span class="op">=</span>ax)</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>    mean <span class="op">=</span> year_df.groupby(<span class="st">'is_holiday'</span>)[<span class="ss">f"ward_</span><span class="sc">{</span>ward_num<span class="sc">}</span><span class="ss">"</span>].mean()</span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>    sns.scatterplot(x<span class="op">=</span>mean.index, y<span class="op">=</span>mean, color<span class="op">=</span><span class="st">'black'</span>, linewidth<span class="op">=</span><span class="dv">2</span>, alpha<span class="op">=</span><span class="fl">0.9</span>,</span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>                    label<span class="op">=</span><span class="st">'Yearly Average'</span>, ax<span class="op">=</span>ax)</span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>    ax.set_xticks([<span class="dv">0</span>, <span class="dv">1</span>])</span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a>    ax.set_xticklabels([<span class="st">"not holiday"</span>, <span class="st">"holiday"</span>], fontsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a>    ax.tick_params(axis<span class="op">=</span><span class="st">'both'</span>, labelsize<span class="op">=</span><span class="dv">9</span>)</span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a>    ax.set_ylabel(<span class="st">"Occupancy"</span>, fontsize<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a>    ax.set_title(<span class="ss">f"Monthly Occupancy for ward </span><span class="sc">{</span>ward_num<span class="sc">}</span><span class="ss">"</span>, fontsize<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a>    ax.legend(loc<span class="op">=</span><span class="st">'upper right'</span>, fontsize<span class="op">=</span><span class="dv">7</span>, ncol<span class="op">=</span><span class="dv">3</span>)</span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Optionally remove/hide any remaining axes (here there is one left)</span></span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> ax <span class="kw">in</span> axes[<span class="dv">7</span>:]:</span>
<span id="cb15-22"><a href="#cb15-22" aria-hidden="true" tabindex="-1"></a>    fig.delaxes(ax)            <span class="co"># removes the empty subplot from figure</span></span>
<span id="cb15-23"><a href="#cb15-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-24"><a href="#cb15-24" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb15-25"><a href="#cb15-25" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="occupancy_nb_files/figure-html/cell-15-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="occupancy-by-the-week-of-year" class="level2">
<h2 class="anchored" data-anchor-id="occupancy-by-the-week-of-year">Occupancy by the week of year</h2>
<div id="a269bff3" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(<span class="dv">2</span>, <span class="dv">4</span>, figsize<span class="op">=</span>(<span class="dv">20</span>, <span class="dv">8</span>))</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>axes <span class="op">=</span> axes.flatten()             <span class="co"># 8 axes, indexed 0..7</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>year_df <span class="op">=</span> occup_train[occup_train[<span class="st">"year"</span>].isin([<span class="dv">2019</span>, <span class="dv">2020</span>, <span class="dv">2021</span>, <span class="dv">2022</span>, <span class="dv">2023</span>])]</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> ward_num, ax <span class="kw">in</span> <span class="bu">enumerate</span>(axes[:<span class="dv">7</span>]):   <span class="co"># only use the first 7 axes</span></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Plot each week's data (less transparent)</span></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>        ward <span class="op">=</span> year_df.pivot_table(index<span class="op">=</span><span class="st">"week_of_year"</span>, columns<span class="op">=</span><span class="st">"year"</span>, values<span class="op">=</span><span class="ss">f"ward_</span><span class="sc">{</span>ward_num<span class="sc">}</span><span class="ss">"</span>, aggfunc<span class="op">=</span><span class="st">'mean'</span>).reset_index()</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>        mean <span class="op">=</span> year_df.groupby(<span class="st">'week_of_year'</span>)[<span class="ss">f"ward_</span><span class="sc">{</span>ward_num<span class="sc">}</span><span class="ss">"</span>].mean()</span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> year <span class="kw">in</span> ward.columns[<span class="dv">1</span>:]:</span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>            ax.plot(ward.index, ward[year], alpha<span class="op">=</span><span class="fl">0.2</span>, label<span class="op">=</span><span class="ss">f"</span><span class="sc">{</span>year<span class="sc">}</span><span class="ss">"</span>)  <span class="co"># Less transparent</span></span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Plot average of all weeks (more transparent, thicker line)</span></span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>        ax.plot(mean.index, mean, color<span class="op">=</span><span class="st">'black'</span>, linewidth<span class="op">=</span><span class="dv">2</span>, alpha<span class="op">=</span><span class="fl">0.9</span>, label<span class="op">=</span><span class="st">'Average'</span>)  <span class="co"># More transparent</span></span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a>        ax.set_xlabel(<span class="st">"week"</span>, fontsize<span class="op">=</span><span class="dv">9</span>)</span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a>        ax.tick_params(axis<span class="op">=</span><span class="st">'both'</span>, labelsize<span class="op">=</span><span class="dv">9</span>)  <span class="co"># &lt;-- Correct way</span></span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a>        ax.tick_params(axis<span class="op">=</span><span class="st">'x'</span>, labelsize<span class="op">=</span><span class="dv">10</span>)  <span class="co"># x-axis tick labels size</span></span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a>        ax.tick_params(axis<span class="op">=</span><span class="st">'y'</span>, labelsize<span class="op">=</span><span class="dv">12</span>) <span class="co"># y-axis tick labels size</span></span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a>        ax.set_ylabel(<span class="st">"Occupancy"</span>, fontsize<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a>        ax.set_title(<span class="ss">f"Weekly Occupancy for ward </span><span class="sc">{</span>ward_num<span class="sc">}</span><span class="ss">"</span>, fontsize<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a>        ax.legend(loc<span class="op">=</span><span class="st">'upper right'</span>, fontsize<span class="op">=</span><span class="dv">8</span>, ncol<span class="op">=</span><span class="dv">3</span>)</span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Optionally remove/hide any remaining axes (here there is one left)</span></span>
<span id="cb16-24"><a href="#cb16-24" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> ax <span class="kw">in</span> axes[<span class="dv">7</span>:]:</span>
<span id="cb16-25"><a href="#cb16-25" aria-hidden="true" tabindex="-1"></a>    fig.delaxes(ax)            <span class="co"># removes the empty subplot from figure</span></span>
<span id="cb16-26"><a href="#cb16-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-27"><a href="#cb16-27" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb16-28"><a href="#cb16-28" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="occupancy_nb_files/figure-html/cell-16-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="0a02d1ca" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(<span class="dv">2</span>, <span class="dv">4</span>, figsize<span class="op">=</span>(<span class="dv">20</span>, <span class="dv">8</span>))</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>axes <span class="op">=</span> axes.flatten()             <span class="co"># 8 axes, indexed 0..7</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>year_df <span class="op">=</span> occup_train[occup_train[<span class="st">"year"</span>].isin([<span class="dv">2019</span>, <span class="dv">2020</span>, <span class="dv">2021</span>, <span class="dv">2022</span>, <span class="dv">2023</span>])]</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> ward_num, ax <span class="kw">in</span> <span class="bu">enumerate</span>(axes[:<span class="dv">7</span>]):   <span class="co"># only use the first 7 axes</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Plot each week's data (less transparent)</span></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>        ward <span class="op">=</span> year_df.pivot_table(index<span class="op">=</span><span class="st">"holiday"</span>, columns<span class="op">=</span><span class="st">"year"</span>, values<span class="op">=</span><span class="ss">f"ward_</span><span class="sc">{</span>ward_num<span class="sc">}</span><span class="ss">"</span>, aggfunc<span class="op">=</span><span class="st">'mean'</span>).reset_index()</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>        mean <span class="op">=</span> year_df.groupby(<span class="st">'holiday'</span>)[<span class="ss">f"ward_</span><span class="sc">{</span>ward_num<span class="sc">}</span><span class="ss">"</span>].mean()</span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> year <span class="kw">in</span> ward.columns[<span class="dv">1</span>:]:</span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>            ax.plot(ward.index, ward[year], alpha<span class="op">=</span><span class="fl">0.2</span>, label<span class="op">=</span><span class="ss">f"</span><span class="sc">{</span>year<span class="sc">}</span><span class="ss">"</span>)  <span class="co"># Less transparent</span></span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Plot average of all weeks (more transparent, thicker line)</span></span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>        ax.plot(mean.index, mean, color<span class="op">=</span><span class="st">'black'</span>, linewidth<span class="op">=</span><span class="dv">2</span>, alpha<span class="op">=</span><span class="fl">0.9</span>, label<span class="op">=</span><span class="st">'Yearly Average'</span>)  <span class="co"># More transparent</span></span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>        ax.set_xlabel(<span class="st">"week"</span>, fontsize<span class="op">=</span><span class="dv">9</span>)</span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>        ax.tick_params(axis<span class="op">=</span><span class="st">'both'</span>, labelsize<span class="op">=</span><span class="dv">9</span>)  <span class="co"># &lt;-- Correct way</span></span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a>        ax.tick_params(axis<span class="op">=</span><span class="st">'x'</span>, labelsize<span class="op">=</span><span class="dv">10</span>, rotation<span class="op">=</span><span class="dv">45</span>)  <span class="co"># x-axis tick labels size</span></span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a>        ax.tick_params(axis<span class="op">=</span><span class="st">'y'</span>, labelsize<span class="op">=</span><span class="dv">12</span>) <span class="co"># y-axis tick labels size</span></span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a>        ax.set_ylabel(<span class="st">"Occupancy"</span>, fontsize<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a>        ax.set_title(<span class="ss">f"Weekly Occupancy for ward </span><span class="sc">{</span>ward_num<span class="sc">}</span><span class="ss">"</span>, fontsize<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a>        ax.legend(loc<span class="op">=</span><span class="st">'upper right'</span>, fontsize<span class="op">=</span><span class="dv">7</span>, ncol<span class="op">=</span><span class="dv">3</span>)</span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Optionally remove/hide any remaining axes (here there is one left)</span></span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> ax <span class="kw">in</span> axes[<span class="dv">7</span>:]:</span>
<span id="cb17-25"><a href="#cb17-25" aria-hidden="true" tabindex="-1"></a>    fig.delaxes(ax)            <span class="co"># removes the empty subplot from figure</span></span>
<span id="cb17-26"><a href="#cb17-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-27"><a href="#cb17-27" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb17-28"><a href="#cb17-28" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="occupancy_nb_files/figure-html/cell-17-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="change-point-and-outlier-detection-methods" class="level2">
<h2 class="anchored" data-anchor-id="change-point-and-outlier-detection-methods">Change point and outlier detection methods</h2>
<div id="8fe658c3" class="cell" data-execution_count="7">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> ruptures <span class="im">as</span> rpt</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="4bbe8580" class="cell" data-execution_count="8">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> stl_data_input(series, period<span class="op">=</span><span class="dv">7</span>, seasonal<span class="op">=</span><span class="dv">2999</span>):</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Apply STL decomposition</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>    res <span class="op">=</span> STL(series.interpolate(method<span class="op">=</span><span class="st">"linear"</span>).squeeze(), <span class="co"># Convert dataframe to a Series</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>                                                        <span class="co"># to avoid error in Statsmodels</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>            robust<span class="op">=</span><span class="va">True</span>, period<span class="op">=</span>period, seasonal<span class="op">=</span>seasonal).fit()</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>    seasonal_component <span class="op">=</span> res.seasonal</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># residual_component = res.resid</span></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># De-seasonlise original data</span></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>    df_deseasonalised <span class="op">=</span> series <span class="op">-</span> seasonal_component</span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># # Perform linear interpolation on de-seasonalised data</span></span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a>    df_deseasonalised_imputed <span class="op">=</span> df_deseasonalised.interpolate(method<span class="op">=</span><span class="st">"linear"</span>)</span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># # Randomly sample residuals (with replacement) and add back</span></span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># sampled_residuals = np.random.choice(residual_component, size=len(residual_component), replace=True)</span></span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># # Match DataFrame index</span></span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># sampled_residuals = pd.Series(sampled_residuals, index=series.index)</span></span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># # Add seasonal component back to get the final imputed time series</span></span>
<span id="cb19-21"><a href="#cb19-21" aria-hidden="true" tabindex="-1"></a>    df_imputed <span class="op">=</span> df_deseasonalised_imputed <span class="op">+</span> seasonal_component</span>
<span id="cb19-22"><a href="#cb19-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-23"><a href="#cb19-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df_imputed</span>
<span id="cb19-24"><a href="#cb19-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-25"><a href="#cb19-25" aria-hidden="true" tabindex="-1"></a><span class="co">## first input nan values using STL</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="02d0f0f0" class="cell" data-execution_count="9">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> ward <span class="kw">in</span> ward_cols_:</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>    occup_train[ward] <span class="op">=</span> stl_data_input(occup_train[ward], period<span class="op">=</span><span class="va">None</span>, seasonal<span class="op">=</span><span class="dv">2999</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="ward-0---change-point-detection-and-imputation" class="level2">
<h2 class="anchored" data-anchor-id="ward-0---change-point-detection-and-imputation">Ward 0 - Change point detection and imputation</h2>
<div id="ad2ae7e1" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>y_00 <span class="op">=</span> occup_train[<span class="st">'ward_0'</span>].values  <span class="co"># Example time series data</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>algo_rbf <span class="op">=</span> rpt.Pelt(model<span class="op">=</span><span class="st">"rbf"</span>).fit(y_00)</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>result_rbf_00 <span class="op">=</span> algo_rbf.predict(pen<span class="op">=</span><span class="dv">40</span>)</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>rpt.display(y_00, result_rbf_00, figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">4</span>))</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="occupancy_nb_files/figure-html/cell-21-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="f9d23435" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>result_rbf_00</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="143">
<pre><code>[655, 965, 1040, 1500, 2060, 2130]</code></pre>
</div>
</div>
<div id="f4466132" class="cell" data-execution_count="10">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co">## replace the outlier values between 965 and 1040 by interpolation</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>occup_train_clean <span class="op">=</span> occup_train.copy()</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>occup_train_nan <span class="op">=</span> occup_train.copy()</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>occup_train_nan.iloc[<span class="dv">965</span><span class="op">-</span><span class="dv">1</span>:<span class="dv">1040</span><span class="op">+</span><span class="dv">1</span>, occup_train_nan.columns.get_loc(<span class="st">'ward_0'</span>)] <span class="op">=</span> np.nan</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>occup_train_clean[<span class="st">'ward_0'</span>] <span class="op">=</span> stl_data_input(occup_train_nan[<span class="st">'ward_0'</span>], period<span class="op">=</span><span class="va">None</span>, seasonal<span class="op">=</span><span class="dv">2999</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="29c8153b" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>y_01 <span class="op">=</span> occup_train_clean[<span class="st">"ward_0"</span>].values  <span class="co"># Example time series data</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>algo_rbf <span class="op">=</span> rpt.Pelt(model<span class="op">=</span><span class="st">"rbf"</span>).fit(y_01)</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>result_rbf_01 <span class="op">=</span> algo_rbf.predict(pen<span class="op">=</span><span class="dv">50</span>) <span class="co">## best to try 1 and 3 piecewise (till 655, 655-1490 and 1490-...)</span></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>rpt.display(y_01, result_rbf_01, figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">4</span>))</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="occupancy_nb_files/figure-html/cell-24-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cf78643b" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>result_rbf_01</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="co"># change_points_ward_0 = [655, 1490], [1490] </span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="146">
<pre><code>[655, 1490, 2130]</code></pre>
</div>
</div>
</section>
<section id="ward-1---change-point-detection-and-imputation" class="level2">
<h2 class="anchored" data-anchor-id="ward-1---change-point-detection-and-imputation">Ward 1 - Change point detection and imputation</h2>
<div id="649ea167" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>y_10 <span class="op">=</span> occup_train[<span class="st">'ward_1'</span>].values  <span class="co"># Example time series data</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>algo_rbf <span class="op">=</span> rpt.Pelt(model<span class="op">=</span><span class="st">"rbf"</span>).fit(y_10)</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>result_rbf_10 <span class="op">=</span> algo_rbf.predict(pen<span class="op">=</span><span class="dv">60</span>) <span class="co"># best to try 1 and 2 with after 1440 break(till 1440, and 1440-...)</span></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>rpt.display(y_10, result_rbf_10, figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">4</span>))</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="occupancy_nb_files/figure-html/cell-26-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="26af29af" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>result_rbf_10</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="148">
<pre><code>[1020, 1440, 2130]</code></pre>
</div>
</div>
<div id="ba81ae8f" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="co"># change_points["ward_1"] = [1440], [1020, 1440]</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="ward-2---change-point-detection-and-imputation" class="level2">
<h2 class="anchored" data-anchor-id="ward-2---change-point-detection-and-imputation">Ward 2 - Change point detection and imputation</h2>
<div id="07922f90" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>y_20 <span class="op">=</span> occup_train[<span class="st">'ward_2'</span>].values  <span class="co"># Example time series data</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>algo_rbf <span class="op">=</span> rpt.Pelt(model<span class="op">=</span><span class="st">"rbf"</span>).fit(y_20)</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>result_rbf_20 <span class="op">=</span> algo_rbf.predict(pen<span class="op">=</span><span class="dv">50</span>) <span class="co"># best to try 1 and 2 with after 1500 break(till 1500, and 1500-...)</span></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>rpt.display(y_20, result_rbf_20, figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">4</span>))</span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="occupancy_nb_files/figure-html/cell-29-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="db1a1ff1" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>result_rbf_20</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="151">
<pre><code>[340, 465, 1020, 1500, 2130]</code></pre>
</div>
</div>
</section>
<section id="ward-3---change-point-detection-and-imputation" class="level2">
<h2 class="anchored" data-anchor-id="ward-3---change-point-detection-and-imputation">Ward 3 - Change point detection and imputation</h2>
<div id="c682e526" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>y_30 <span class="op">=</span> occup_train[<span class="st">'ward_3'</span>].values  <span class="co"># Example time series data</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>algo_rbf <span class="op">=</span> rpt.Pelt(model<span class="op">=</span><span class="st">"rbf"</span>).fit(y_30)</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>result_rbf_30 <span class="op">=</span> algo_rbf.predict(pen<span class="op">=</span><span class="dv">50</span>) <span class="co"># best to try just 1 because the changes are subtle and the last change has less data points</span></span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>rpt.display(y_30, result_rbf_30, figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">4</span>))</span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="occupancy_nb_files/figure-html/cell-31-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="28fd94cd" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>result_rbf_30</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="153">
<pre><code>[520, 885, 1855, 2130]</code></pre>
</div>
</div>
</section>
<section id="ward-4---change-point-detection-and-imputation" class="level2">
<h2 class="anchored" data-anchor-id="ward-4---change-point-detection-and-imputation">Ward 4 - Change point detection and imputation</h2>
<div id="168ca759" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>y_40 <span class="op">=</span> occup_train[<span class="st">'ward_4'</span>].values  <span class="co"># Example time series data</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>algo_rbf <span class="op">=</span> rpt.Pelt(model<span class="op">=</span><span class="st">"rbf"</span>).fit(y_40)</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>result_rbf_40 <span class="op">=</span> algo_rbf.predict(pen<span class="op">=</span><span class="dv">35</span>)</span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>rpt.display(y_40, result_rbf_40, figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">4</span>))</span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-error">
<div class="ansi-escaped-output">
<pre><span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">KeyboardInterrupt</span>                         Traceback (most recent call last)
<span class="ansi-cyan-fg">Cell</span><span class="ansi-cyan-fg"> </span><span class="ansi-green-fg">In[154]</span><span class="ansi-green-fg">, line 3</span>
<span class="ansi-green-fg">      1</span> y_40 = occup_train[<span class="ansi-yellow-fg">'</span><span class="ansi-yellow-fg">ward_4</span><span class="ansi-yellow-fg">'</span>].values  <span style="font-style:italic;color:rgb(95,135,135)"># Example time series data</span>
<span class="ansi-green-fg">      2</span> algo_rbf = rpt.Pelt(model=<span class="ansi-yellow-fg">"</span><span class="ansi-yellow-fg">rbf</span><span class="ansi-yellow-fg">"</span>).fit(y_40)
<span class="ansi-green-fg">----&gt; </span><span class="ansi-green-fg">3</span> result_rbf_40 = <span class="ansi-yellow-bg">algo_rbf</span><span class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">predict</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">pen</span><span class="ansi-yellow-bg">=</span><span class="ansi-green-fg ansi-yellow-bg">35</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg">      4</span> rpt.display(y_40, result_rbf_40, figsize=(<span class="ansi-green-fg">12</span>, <span class="ansi-green-fg">4</span>))
<span class="ansi-green-fg">      5</span> plt.show()

<span class="ansi-cyan-fg">File </span><span class="ansi-green-fg">~/Desktop/my_desk/phd_research/phd_project/quarto_py_env/lib/python3.13/site-packages/ruptures/detection/pelt.py:131</span>, in <span class="ansi-cyan-fg">Pelt.predict</span><span class="ansi-blue-fg">(self, pen)</span>
<span class="ansi-green-fg">    123</span> <span style="font-weight:bold;color:rgb(0,135,0)">if</span> <span style="font-weight:bold;color:rgb(175,0,255)">not</span> sanity_check(
<span class="ansi-green-fg">    124</span>     n_samples=<span style="color:rgb(0,135,0)">self</span>.cost.signal.shape[<span class="ansi-green-fg">0</span>],
<span class="ansi-green-fg">    125</span>     n_bkps=<span class="ansi-green-fg">0</span>,
<span class="ansi-green-fg">    126</span>     jump=<span style="color:rgb(0,135,0)">self</span>.jump,
<span class="ansi-green-fg">    127</span>     min_size=<span style="color:rgb(0,135,0)">self</span>.min_size,
<span class="ansi-green-fg">    128</span> ):
<span class="ansi-green-fg">    129</span>     <span style="font-weight:bold;color:rgb(0,135,0)">raise</span> BadSegmentationParameters
<span class="ansi-green-fg">--&gt; </span><span class="ansi-green-fg">131</span> partition = <span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">_seg</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">pen</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg">    132</span> bkps = <span style="color:rgb(0,135,0)">sorted</span>(e <span style="font-weight:bold;color:rgb(0,135,0)">for</span> s, e <span style="font-weight:bold;color:rgb(175,0,255)">in</span> partition.keys())
<span class="ansi-green-fg">    133</span> <span style="font-weight:bold;color:rgb(0,135,0)">return</span> bkps

<span class="ansi-cyan-fg">File </span><span class="ansi-green-fg">~/Desktop/my_desk/phd_research/phd_project/quarto_py_env/lib/python3.13/site-packages/ruptures/detection/pelt.py:72</span>, in <span class="ansi-cyan-fg">Pelt._seg</span><span class="ansi-blue-fg">(self, pen)</span>
<span class="ansi-green-fg">     70</span>         <span style="font-weight:bold;color:rgb(0,135,0)">continue</span>
<span class="ansi-green-fg">     71</span>     <span style="font-style:italic;color:rgb(95,135,135)"># we update with the right partition</span>
<span class="ansi-green-fg">---&gt; </span><span class="ansi-green-fg">72</span>     tmp_partition.update({(t, bkp): <span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">cost</span><span class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">error</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">t</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">bkp</span><span class="ansi-yellow-bg">)</span> + pen})
<span class="ansi-green-fg">     73</span>     subproblems.append(tmp_partition)
<span class="ansi-green-fg">     75</span> <span style="font-style:italic;color:rgb(95,135,135)"># finding the optimal partition</span>

<span class="ansi-cyan-fg">File </span><span class="ansi-green-fg">~/Desktop/my_desk/phd_research/phd_project/quarto_py_env/lib/python3.13/site-packages/ruptures/costs/costrbf.py:81</span>, in <span class="ansi-cyan-fg">CostRbf.error</span><span class="ansi-blue-fg">(self, start, end)</span>
<span class="ansi-green-fg">     79</span> sub_gram = <span style="color:rgb(0,135,0)">self</span>.gram[start:end, start:end]
<span class="ansi-green-fg">     80</span> val = np.diagonal(sub_gram).sum()
<span class="ansi-green-fg">---&gt; </span><span class="ansi-green-fg">81</span> val -= <span class="ansi-yellow-bg">sub_gram</span><span class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">sum</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">)</span> / (end - start)
<span class="ansi-green-fg">     82</span> <span style="font-weight:bold;color:rgb(0,135,0)">return</span> val

<span class="ansi-cyan-fg">File </span><span class="ansi-green-fg">~/Desktop/my_desk/phd_research/phd_project/quarto_py_env/lib/python3.13/site-packages/numpy/_core/_methods.py:52</span>, in <span class="ansi-cyan-fg">_sum</span><span class="ansi-blue-fg">(a, axis, dtype, out, keepdims, initial, where)</span>
<span class="ansi-green-fg">     50</span> <span style="font-weight:bold;color:rgb(0,135,0)">def</span><span style="color:rgb(188,188,188)"> </span><span class="ansi-blue-fg">_sum</span>(a, axis=<span style="font-weight:bold;color:rgb(0,135,0)">None</span>, dtype=<span style="font-weight:bold;color:rgb(0,135,0)">None</span>, out=<span style="font-weight:bold;color:rgb(0,135,0)">None</span>, keepdims=<span style="font-weight:bold;color:rgb(0,135,0)">False</span>,
<span class="ansi-green-fg">     51</span>          initial=_NoValue, where=<span style="font-weight:bold;color:rgb(0,135,0)">True</span>):
<span class="ansi-green-fg">---&gt; </span><span class="ansi-green-fg">52</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span class="ansi-yellow-bg">umr_sum</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">a</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">axis</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">dtype</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">out</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">keepdims</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">initial</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">where</span><span class="ansi-yellow-bg">)</span>

<span class="ansi-red-fg">KeyboardInterrupt</span>: </pre>
</div>
</div>
</div>
<div id="bc367fbf" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>result_rbf_40</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="22">
<pre><code>[175, 705, 815, 945, 1215, 1475, 1630, 1830, 2130]</code></pre>
</div>
</div>
<div id="cf6b9a97" class="cell" data-execution_count="12">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb41"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="co">## replace the outlier values between 815 and 945 by interpolation where they were also NaN values before interpolation </span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a><span class="co"># occup_train_nan = occup_train.copy()</span></span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>occup_train_nan.iloc[<span class="dv">815</span><span class="op">-</span><span class="dv">1</span>:<span class="dv">945</span><span class="op">+</span><span class="dv">1</span>, occup_train_nan.columns.get_loc(<span class="st">'ward_4'</span>)] <span class="op">=</span> np.nan</span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>occup_train_clean[<span class="st">'ward_4'</span>] <span class="op">=</span> stl_data_input(occup_train_nan[<span class="st">'ward_4'</span>], period<span class="op">=</span><span class="va">None</span>, seasonal<span class="op">=</span><span class="dv">2999</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="b4a6d315" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb42"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>y_41 <span class="op">=</span> occup_train_clean[<span class="st">'ward_4'</span>].values  <span class="co"># Example time series data</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>algo_rbf <span class="op">=</span> rpt.Pelt(model<span class="op">=</span><span class="st">"rbf"</span>).fit(y_41)</span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>result_rbf_41 <span class="op">=</span> algo_rbf.predict(pen<span class="op">=</span><span class="dv">50</span>) <span class="co">## try linear trend and 2 piecewise trend for ward_4 (after 705)</span></span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>rpt.display(y_41, result_rbf_41, figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">4</span>))</span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="occupancy_nb_files/figure-html/cell-36-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="ae602d85" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>result_rbf_41</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="25">
<pre><code>[175, 705, 1255, 1470, 2130]</code></pre>
</div>
</div>
<div id="288fd006" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb45"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>change_points_ward_4 <span class="op">=</span> [<span class="dv">705</span>], [<span class="dv">1255</span>]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="ward-5---change-point-detection-and-imputation" class="level2">
<h2 class="anchored" data-anchor-id="ward-5---change-point-detection-and-imputation">Ward 5 - Change point detection and imputation</h2>
<div id="cc7b42c4" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb46"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>y_50 <span class="op">=</span> occup_train[<span class="st">'ward_5'</span>].values  <span class="co"># Example time series data</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>algo_rbf <span class="op">=</span> rpt.Pelt(model<span class="op">=</span><span class="st">"rbf"</span>).fit(y_50)</span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>result_rbf_50 <span class="op">=</span> algo_rbf.predict(pen<span class="op">=</span><span class="dv">35</span>)</span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>rpt.display(y_50, result_rbf_50, figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">4</span>))</span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="occupancy_nb_files/figure-html/cell-39-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="51b678e9" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb47"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>result_rbf_50</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="37">
<pre><code>[915, 970, 1225, 1395, 2130]</code></pre>
</div>
</div>
<div id="343d56d0" class="cell" data-execution_count="15">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb49"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="co">## replace the outlier values between 1215 and 1395 by interpolation</span></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>occup_train_nan.iloc[<span class="dv">915</span><span class="op">-</span><span class="dv">1</span>:<span class="dv">970</span><span class="op">+</span><span class="dv">1</span>, occup_train_nan.columns.get_loc(<span class="st">'ward_5'</span>)] <span class="op">=</span> np.nan</span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>occup_train_nan.iloc[<span class="dv">1215</span><span class="op">-</span><span class="dv">1</span>:<span class="dv">1395</span><span class="op">+</span><span class="dv">1</span>, occup_train_nan.columns.get_loc(<span class="st">'ward_5'</span>)] <span class="op">=</span> np.nan</span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a>occup_train_clean[<span class="st">'ward_5'</span>] <span class="op">=</span> stl_data_input(occup_train_nan[<span class="st">'ward_5'</span>], period<span class="op">=</span><span class="va">None</span>, seasonal<span class="op">=</span><span class="dv">2999</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="a96d6a6f" class="cell" data-execution_count="16">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb50"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>y_51 <span class="op">=</span> occup_train_clean[<span class="st">'ward_5'</span>].values  <span class="co"># Example time series data</span></span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>algo_rbf <span class="op">=</span> rpt.Pelt(model<span class="op">=</span><span class="st">"rbf"</span>).fit(y_51)</span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>result_rbf_51 <span class="op">=</span> algo_rbf.predict(pen<span class="op">=</span><span class="dv">50</span>) <span class="co">## try linear trend and 3 piecewise trend for ward_5 (830, 830-1425, and 1425+)</span></span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a>rpt.display(y_51, result_rbf_51, figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">4</span>))</span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="occupancy_nb_files/figure-html/cell-42-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="13846ae7" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb51"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>result_rbf_51</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="127">
<pre><code>[830, 1425, 2130]</code></pre>
</div>
</div>
<div id="233eada3" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb53"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>change_points_ward_5 <span class="op">=</span> [<span class="dv">830</span>, <span class="dv">1425</span>]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="ward-6---change-point-detection-and-imputation" class="level2">
<h2 class="anchored" data-anchor-id="ward-6---change-point-detection-and-imputation">Ward 6 - Change point detection and imputation</h2>
<div id="ed38ad28" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb54"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>y_60 <span class="op">=</span> occup_train[<span class="st">'ward_6'</span>].values  <span class="co"># Example time series data</span></span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>algo_rbf <span class="op">=</span> rpt.Pelt(model<span class="op">=</span><span class="st">"rbf"</span>).fit(y_60)</span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>result_rbf_60 <span class="op">=</span> algo_rbf.predict(pen<span class="op">=</span><span class="dv">40</span>) <span class="co"># better to just try 1 because the only change is in the begining which might reflect the nature of data</span></span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a>rpt.display(y_60, result_rbf_60, figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">4</span>))</span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="occupancy_nb_files/figure-html/cell-45-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="535bd3bb" class="cell" data-execution_count="13">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb55"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="co"># change_points = {"ward_0": change_points_ward_0, "ward_1": change_points_ward_1, "ward_2": change_points_ward_2,</span></span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a><span class="co">#                  "ward_4": change_points_ward_4, "ward_5": change_points_ward_5}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="c358675a" class="cell" data-execution_count="16">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb56"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="co"># # Save to file</span></span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a><span class="co"># with open('model_params/change_points.pkl', 'wb') as f:</span></span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a><span class="co">#     pickle.dump(change_points, f)</span></span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Load from file</span></span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(<span class="st">'model_params/change_points.pkl'</span>, <span class="st">'rb'</span>) <span class="im">as</span> f:</span>
<span id="cb56-7"><a href="#cb56-7" aria-hidden="true" tabindex="-1"></a>    change_points <span class="op">=</span> pickle.load(f)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="guerrero-transformation" class="level2">
<h2 class="anchored" data-anchor-id="guerrero-transformation">guerrero transformation</h2>
<div id="ea504bdc" class="cell" data-execution_count="17">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb57"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a><span class="co"># from sktime.transformations.series.boxcox import BoxCoxTransformer</span></span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a><span class="co"># guerrero_lambdas = {}</span></span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a><span class="co"># for w in ward_cols_:</span></span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a><span class="co">#     # Make transformer and perform Box-Cox transform</span></span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a><span class="co">#     transformer = BoxCoxTransformer(</span></span>
<span id="cb57-7"><a href="#cb57-7" aria-hidden="true" tabindex="-1"></a><span class="co">#         method="guerrero",</span></span>
<span id="cb57-8"><a href="#cb57-8" aria-hidden="true" tabindex="-1"></a><span class="co">#         sp=7 # sp should be set to the seasonal period</span></span>
<span id="cb57-9"><a href="#cb57-9" aria-hidden="true" tabindex="-1"></a><span class="co">#     )  </span></span>
<span id="cb57-10"><a href="#cb57-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-11"><a href="#cb57-11" aria-hidden="true" tabindex="-1"></a><span class="co">#     transformer.fit_transform(occup_train_clean[w])</span></span>
<span id="cb57-12"><a href="#cb57-12" aria-hidden="true" tabindex="-1"></a><span class="co">#     guerrero_lambdas[w] = transformer.lambda_</span></span>
<span id="cb57-13"><a href="#cb57-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-14"><a href="#cb57-14" aria-hidden="true" tabindex="-1"></a><span class="co"># # Save to file</span></span>
<span id="cb57-15"><a href="#cb57-15" aria-hidden="true" tabindex="-1"></a><span class="co"># with open('model_params/guerrero_lambdas.pkl', 'wb') as f:</span></span>
<span id="cb57-16"><a href="#cb57-16" aria-hidden="true" tabindex="-1"></a><span class="co">#     pickle.dump(guerrero_lambdas, f)</span></span>
<span id="cb57-17"><a href="#cb57-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-18"><a href="#cb57-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Load from file</span></span>
<span id="cb57-19"><a href="#cb57-19" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(<span class="st">'model_params/guerrero_lambdas.pkl'</span>, <span class="st">'rb'</span>) <span class="im">as</span> f:</span>
<span id="cb57-20"><a href="#cb57-20" aria-hidden="true" tabindex="-1"></a>    guerrero_lambdas <span class="op">=</span> pickle.load(f)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="ee3e6d74" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb58"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>fitted_trend0, model_tr0 <span class="op">=</span> lr_trend_model(occup_train_clean[<span class="st">"ward_0"</span>], breakpoints<span class="op">=</span>[<span class="dv">655</span>], <span class="bu">type</span><span class="op">=</span><span class="st">'piecewise'</span>)</span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>fitted_trend_lr0, model_lr0 <span class="op">=</span> lr_trend_model(occup_train_clean[<span class="st">"ward_0"</span>])</span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a>forecast360_w0 <span class="op">=</span> forecast_trend(model<span class="op">=</span>model_tr0, H<span class="op">=</span><span class="dv">360</span>, start<span class="op">=</span><span class="bu">len</span>(occup_train_clean[<span class="st">"ward_0"</span>]), breakpoints<span class="op">=</span>[<span class="dv">655</span>])</span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a>forecast360_lr0 <span class="op">=</span> forecast_trend(model<span class="op">=</span>model_lr0, H<span class="op">=</span><span class="dv">360</span>, start<span class="op">=</span><span class="bu">len</span>(occup_train_clean[<span class="st">"ward_0"</span>]))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="33433a1a" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb59"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">15</span>, <span class="dv">8</span>))</span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>ax.plot(occup_train_clean.index, (occup_train_clean[<span class="st">"ward_0"</span>]), label<span class="op">=</span><span class="st">"Original Data"</span>, color<span class="op">=</span><span class="st">'blue'</span>, alpha<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a>ax.plot(occup_train_clean.index, fitted_trend0, label<span class="op">=</span><span class="st">"Fitted Trend"</span>, color<span class="op">=</span><span class="st">'red'</span>, linewidth<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a>ax.plot(occup_train_clean.index, fitted_trend_lr0, label<span class="op">=</span><span class="st">"Fitted Trend"</span>, color<span class="op">=</span><span class="st">'purple'</span>, linewidth<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a>ax.plot(occup_test.index, occup_test[<span class="st">"ward_0"</span>], label<span class="op">=</span><span class="st">"Detrended Data"</span>, color<span class="op">=</span><span class="st">'green'</span>, alpha<span class="op">=</span><span class="fl">0.7</span>)</span>
<span id="cb59-6"><a href="#cb59-6" aria-hidden="true" tabindex="-1"></a>ax.plot(occup_test.index, forecast360_w0, label<span class="op">=</span><span class="st">"Forecasted Trend"</span>, color<span class="op">=</span><span class="st">'orange'</span>, linewidth<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb59-7"><a href="#cb59-7" aria-hidden="true" tabindex="-1"></a>ax.plot(occup_test.index, forecast360_lr0, label<span class="op">=</span><span class="st">"Forecasted Trend"</span>, color<span class="op">=</span><span class="st">'pink'</span>, linewidth<span class="op">=</span><span class="dv">2</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="occupancy_nb_files/figure-html/cell-50-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="7275a38e" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb60"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="co"># RMSE(occup_test["ward_2"], forecast360_w2), RMSE(occup_test["ward_2"], forecast360_lr2)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="221">
<pre><code>(np.float64(3.8212542303129404), np.float64(5.129657020736392))</code></pre>
</div>
</div>
<div id="8dca723f" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb62"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> cross_validate_trend(series, cv_split, test_size, metrics, <span class="bu">type</span> <span class="op">=</span> <span class="st">"linear"</span>, break_points <span class="op">=</span> <span class="va">None</span>, step_size<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Run cross-validation using time series splits.</span></span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb62-6"><a href="#cb62-6" aria-hidden="true" tabindex="-1"></a><span class="co">        model (class): Machine learning model class (e.g., CatBoostRegressor, LGBMRegressor).</span></span>
<span id="cb62-7"><a href="#cb62-7" aria-hidden="true" tabindex="-1"></a><span class="co">        df (pd.DataFrame): Input data.</span></span>
<span id="cb62-8"><a href="#cb62-8" aria-hidden="true" tabindex="-1"></a><span class="co">        cv_split (int): Number of splits in TimeSeriesSplit.</span></span>
<span id="cb62-9"><a href="#cb62-9" aria-hidden="true" tabindex="-1"></a><span class="co">        test_size (int): Size of test window.</span></span>
<span id="cb62-10"><a href="#cb62-10" aria-hidden="true" tabindex="-1"></a><span class="co">        metrics (list): List of metric functions.</span></span>
<span id="cb62-11"><a href="#cb62-11" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb62-12"><a href="#cb62-12" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb62-13"><a href="#cb62-13" aria-hidden="true" tabindex="-1"></a><span class="co">        pd.DataFrame: Performance metrics for CV.</span></span>
<span id="cb62-14"><a href="#cb62-14" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb62-15"><a href="#cb62-15" aria-hidden="true" tabindex="-1"></a>    tscv <span class="op">=</span> ParametricTimeSeriesSplit(n_splits<span class="op">=</span>cv_split, test_size<span class="op">=</span>test_size, step_size<span class="op">=</span>step_size)</span>
<span id="cb62-16"><a href="#cb62-16" aria-hidden="true" tabindex="-1"></a>    metrics_dict <span class="op">=</span> {m.<span class="va">__name__</span>: [] <span class="cf">for</span> m <span class="kw">in</span> metrics}</span>
<span id="cb62-17"><a href="#cb62-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> train_index, test_index <span class="kw">in</span> tscv.split(series):</span>
<span id="cb62-18"><a href="#cb62-18" aria-hidden="true" tabindex="-1"></a>        train, test <span class="op">=</span> series[train_index], series[test_index]</span>
<span id="cb62-19"><a href="#cb62-19" aria-hidden="true" tabindex="-1"></a>        fitted_trend, model_ <span class="op">=</span> lr_trend_model(train, breakpoints<span class="op">=</span>break_points, <span class="bu">type</span><span class="op">=</span> <span class="bu">type</span>)</span>
<span id="cb62-20"><a href="#cb62-20" aria-hidden="true" tabindex="-1"></a>        forecast <span class="op">=</span> forecast_trend(model<span class="op">=</span>model_, H<span class="op">=</span>test_size, start<span class="op">=</span><span class="bu">len</span>(train), breakpoints<span class="op">=</span>break_points)</span>
<span id="cb62-21"><a href="#cb62-21" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Evaluate each metric</span></span>
<span id="cb62-22"><a href="#cb62-22" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> m <span class="kw">in</span> metrics:</span>
<span id="cb62-23"><a href="#cb62-23" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> m.<span class="va">__name__</span> <span class="kw">in</span> [<span class="st">"MASE"</span>, <span class="st">"SMAE"</span>, <span class="st">"SRMSE"</span>, <span class="st">"RMSSE"</span>]:</span>
<span id="cb62-24"><a href="#cb62-24" aria-hidden="true" tabindex="-1"></a>                eval_val <span class="op">=</span> m(np.array(test), forecast, train)</span>
<span id="cb62-25"><a href="#cb62-25" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb62-26"><a href="#cb62-26" aria-hidden="true" tabindex="-1"></a>                eval_val <span class="op">=</span> m(np.array(test), forecast)</span>
<span id="cb62-27"><a href="#cb62-27" aria-hidden="true" tabindex="-1"></a>            metrics_dict[m.<span class="va">__name__</span>].append(eval_val)</span>
<span id="cb62-28"><a href="#cb62-28" aria-hidden="true" tabindex="-1"></a>    overall_performance <span class="op">=</span> [[m.<span class="va">__name__</span>, np.mean(metrics_dict[m.<span class="va">__name__</span>])] <span class="cf">for</span> m <span class="kw">in</span> metrics]</span>
<span id="cb62-29"><a href="#cb62-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pd.DataFrame(overall_performance).rename(columns<span class="op">=</span>{<span class="dv">0</span>: <span class="st">"eval_metric"</span>, <span class="dv">1</span>: <span class="st">"score"</span>})</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="4e433d5f" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb63"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>cross_validate_trend(series<span class="op">=</span>occup_train_clean[<span class="st">"ward_0"</span>], cv_split<span class="op">=</span><span class="dv">10</span>, test_size<span class="op">=</span><span class="dv">30</span>, step_size<span class="op">=</span><span class="dv">1</span>, metrics<span class="op">=</span>[SRMSE, MAE, RMSE, MASE], <span class="bu">type</span><span class="op">=</span><span class="st">'piecewise'</span>, break_points<span class="op">=</span>[<span class="dv">655</span>])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="23">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">eval_metric</th>
<th data-quarto-table-cell-role="th">score</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>SRMSE</td>
<td>0.498297</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>MAE</td>
<td>5.501857</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>RMSE</td>
<td>5.757344</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">3</th>
<td>MASE</td>
<td>6.703189</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div id="498b4b62" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb64"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a>cross_validate_trend(series<span class="op">=</span>occup_train_clean[<span class="st">"ward_0"</span>], cv_split<span class="op">=</span><span class="dv">10</span>, test_size<span class="op">=</span><span class="dv">30</span>, step_size<span class="op">=</span><span class="dv">1</span>, metrics<span class="op">=</span>[SRMSE, MAE, RMSE, MASE], <span class="bu">type</span><span class="op">=</span><span class="st">'linear'</span>, break_points<span class="op">=</span><span class="va">None</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="23">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">eval_metric</th>
<th data-quarto-table-cell-role="th">score</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>SRMSE</td>
<td>0.360618</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>MAE</td>
<td>3.803619</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>RMSE</td>
<td>4.166597</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">3</th>
<td>MASE</td>
<td>4.634138</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div id="e1e8e859" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb65"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="co"># score_list = []</span></span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a><span class="co"># for b in range(500, 1900):</span></span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a><span class="co">#     cv = cross_validate_trend(series=occup_train_clean["ward_0"], cv_split=30, test_size=30, step_size=1, metrics=[MAE, RMSE, MASE], type='piecewise', break_points=[b])</span></span>
<span id="cb65-4"><a href="#cb65-4" aria-hidden="true" tabindex="-1"></a><span class="co">#     score = [b]+cv["score"].tolist()</span></span>
<span id="cb65-5"><a href="#cb65-5" aria-hidden="true" tabindex="-1"></a><span class="co">#     score_list.append(score)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<section id="cross-validation-results-for-trend-forecasting" class="level4">
<h4 class="anchored" data-anchor-id="cross-validation-results-for-trend-forecasting">Cross-validation results for trend forecasting</h4>
<ul>
<li>For Ward 0, use normal linear regression, perform better than piecewise linear regression.</li>
<li>For Ward 1, use piecewise linear regression, perform better than normal linear regression.</li>
<li>For Ward 2, use piecewise linear regression, perform better than normal linear regression.</li>
<li>For Ward 3, use normal linear regression, perform better than piecewise linear regression.</li>
<li>For Ward 4, use piecewise linear regression, perform better than normal linear regression. just 1255</li>
<li>For Ward 5, use piecewise linear regression, perform better than normal linear regression.</li>
</ul>
<div id="57757f79" class="cell" data-execution_count="18">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb66"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="co"># trend_lr_models = pd.DataFrame([["ward_0", "linear regression", np.nan],</span></span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a><span class="co">#  ["ward_1", "piecewise regression", 1440],</span></span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a><span class="co">#  ["ward_2", "piecewise regression", 1500],</span></span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a><span class="co">#  ["ward_3", "linear regression", np.nan],</span></span>
<span id="cb66-5"><a href="#cb66-5" aria-hidden="true" tabindex="-1"></a><span class="co">#  ["ward_4", "piecewise regression", 1255],</span></span>
<span id="cb66-6"><a href="#cb66-6" aria-hidden="true" tabindex="-1"></a><span class="co">#  ["ward_5", "piecewise regression", [830, 1425]],</span></span>
<span id="cb66-7"><a href="#cb66-7" aria-hidden="true" tabindex="-1"></a><span class="co">#  ["ward_6", "linear regression", np.nan]]).rename(columns={0: "ward", 1: "model", 2: "breakpoint"})</span></span>
<span id="cb66-8"><a href="#cb66-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-9"><a href="#cb66-9" aria-hidden="true" tabindex="-1"></a><span class="co"># # Save to file</span></span>
<span id="cb66-10"><a href="#cb66-10" aria-hidden="true" tabindex="-1"></a><span class="co"># with open('model_params/trend_lr_models.pkl', 'wb') as f:</span></span>
<span id="cb66-11"><a href="#cb66-11" aria-hidden="true" tabindex="-1"></a><span class="co">#     pickle.dump(trend_lr_models, f)</span></span>
<span id="cb66-12"><a href="#cb66-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-13"><a href="#cb66-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Load from file</span></span>
<span id="cb66-14"><a href="#cb66-14" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(<span class="st">'model_params/trend_lr_models.pkl'</span>, <span class="st">'rb'</span>) <span class="im">as</span> f:</span>
<span id="cb66-15"><a href="#cb66-15" aria-hidden="true" tabindex="-1"></a>    trend_lr_models <span class="op">=</span> pickle.load(f)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="077f4343" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb67"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="co"># var_rmse = []</span></span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a><span class="co"># for i in range(3, 3000, 2):</span></span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a><span class="co">#     res = STL(occup_train_clean["ward_0"], period=7, seasonal=i).fit()</span></span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true" tabindex="-1"></a><span class="co">#     var_rmse.append([i, np.var(res.resid), np.sqrt((res.resid**2).mean())])</span></span>
<span id="cb67-5"><a href="#cb67-5" aria-hidden="true" tabindex="-1"></a><span class="co"># df_result = pd.DataFrame(var_rmse, columns=["seasonal", "var", "rmse"])</span></span>
<span id="cb67-6"><a href="#cb67-6" aria-hidden="true" tabindex="-1"></a><span class="co"># df_result.sort_values(by="rmse")</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="8e3bd678" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb68"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a><span class="co"># for w in ward_cols_:</span></span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a><span class="co">#     strength = seasonality_strength(occup_train_clean[w], period=7, seasonal=3)</span></span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a><span class="co">#     print(f"seasonality_strength for {w}: {strength}")</span></span>
<span id="cb68-5"><a href="#cb68-5" aria-hidden="true" tabindex="-1"></a><span class="co"># for w in ward_cols_:</span></span>
<span id="cb68-6"><a href="#cb68-6" aria-hidden="true" tabindex="-1"></a><span class="co">#     strength = trend_strength(occup_train_clean[w], period=7, seasonal=3)</span></span>
<span id="cb68-7"><a href="#cb68-7" aria-hidden="true" tabindex="-1"></a><span class="co">#     print(f"trend_strength for {w}: {strength}")</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
</section>
<section id="acf-test-and-pacf-test" class="level2">
<h2 class="anchored" data-anchor-id="acf-test-and-pacf-test">ACF test and PACF test</h2>
<div id="a5bc4dcd" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb69"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Stationary check for each ward using ADF test and KPSS</span></span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> ward <span class="kw">in</span> ward_cols_:</span>
<span id="cb69-3"><a href="#cb69-3" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Unit root test for </span><span class="sc">{</span>ward<span class="sc">}</span><span class="ss">:"</span>)</span>
<span id="cb69-4"><a href="#cb69-4" aria-hidden="true" tabindex="-1"></a>    unit_root_test(occup_train_clean[ward], n_lag<span class="op">=</span><span class="dv">26</span>, method<span class="op">=</span><span class="st">"ADF"</span>)</span>
<span id="cb69-5"><a href="#cb69-5" aria-hidden="true" tabindex="-1"></a>    unit_root_test(occup_train_clean[ward], n_lag<span class="op">=</span><span class="dv">20</span>, method<span class="op">=</span><span class="st">"KPSS"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Unit root test for ward_0:
ADF p-value: 0.000796 and data is stationary at 5% significance level
KPSS p-value: 0.010000 and data is non-stationary at 5% significance level
Unit root test for ward_1:
ADF p-value: 0.006183 and data is stationary at 5% significance level
KPSS p-value: 0.010000 and data is non-stationary at 5% significance level
Unit root test for ward_2:
ADF p-value: 0.000232 and data is stationary at 5% significance level
KPSS p-value: 0.047429 and data is non-stationary at 5% significance level
Unit root test for ward_3:
ADF p-value: 0.000318 and data is stationary at 5% significance level
KPSS p-value: 0.010000 and data is non-stationary at 5% significance level
Unit root test for ward_4:
ADF p-value: 0.000184 and data is stationary at 5% significance level
KPSS p-value: 0.010000 and data is non-stationary at 5% significance level
Unit root test for ward_5:
ADF p-value: 0.000000 and data is stationary at 5% significance level
KPSS p-value: 0.100000 and data is stationary at 5% significance level
Unit root test for ward_6:
ADF p-value: 0.000000 and data is stationary at 5% significance level
KPSS p-value: 0.010000 and data is non-stationary at 5% significance level</code></pre>
</div>
</div>
<div id="2d8f1779" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb71"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a><span class="co"># from statsmodels.tsa.stattools import adfuller</span></span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a><span class="co"># def adf_lag(y):</span></span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a><span class="co">#     # Run ADF test with automatic lag selection using AIC and BIC</span></span>
<span id="cb71-4"><a href="#cb71-4" aria-hidden="true" tabindex="-1"></a><span class="co">#     adf_aic = adfuller(y, autolag="AIC")</span></span>
<span id="cb71-5"><a href="#cb71-5" aria-hidden="true" tabindex="-1"></a><span class="co">#     adf_bic = adfuller(y, autolag="BIC")</span></span>
<span id="cb71-6"><a href="#cb71-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-7"><a href="#cb71-7" aria-hidden="true" tabindex="-1"></a><span class="co">#     auto_results = pd.DataFrame({</span></span>
<span id="cb71-8"><a href="#cb71-8" aria-hidden="true" tabindex="-1"></a><span class="co">#         "Criterion": ["AIC", "BIC"],</span></span>
<span id="cb71-9"><a href="#cb71-9" aria-hidden="true" tabindex="-1"></a><span class="co">#         "ADF Statistic": [adf_aic[0], adf_bic[0]],</span></span>
<span id="cb71-10"><a href="#cb71-10" aria-hidden="true" tabindex="-1"></a><span class="co">#         "p-value": [adf_aic[1], adf_bic[1]],</span></span>
<span id="cb71-11"><a href="#cb71-11" aria-hidden="true" tabindex="-1"></a><span class="co">#         "Used Lags": [adf_aic[2], adf_bic[2]]</span></span>
<span id="cb71-12"><a href="#cb71-12" aria-hidden="true" tabindex="-1"></a><span class="co">#     })</span></span>
<span id="cb71-13"><a href="#cb71-13" aria-hidden="true" tabindex="-1"></a><span class="co">#     return auto_results</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="63ae0252" class="cell" data-execution_count="19">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb72"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a>occup_train_guerrero <span class="op">=</span> occup_train_clean.copy()</span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-3"><a href="#cb72-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> w <span class="kw">in</span> ward_cols_:</span>
<span id="cb72-4"><a href="#cb72-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Apply the Box-Cox transformation using the saved lambda</span></span>
<span id="cb72-5"><a href="#cb72-5" aria-hidden="true" tabindex="-1"></a>    occup_train_guerrero[w] <span class="op">=</span> box_cox_transform(occup_train_clean[w],</span>
<span id="cb72-6"><a href="#cb72-6" aria-hidden="true" tabindex="-1"></a>                                                box_cox_lmda<span class="op">=</span>guerrero_lambdas[w])[<span class="dv">0</span>]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="43b9ceb2" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb73"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Stationary check for each ward using ADF test and KPSS</span></span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> ward <span class="kw">in</span> ward_cols_:</span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Unit root test for </span><span class="sc">{</span>ward<span class="sc">}</span><span class="ss">:"</span>)</span>
<span id="cb73-4"><a href="#cb73-4" aria-hidden="true" tabindex="-1"></a>    unit_root_test(occup_train_guerrero[ward], n_lag<span class="op">=</span><span class="dv">10</span>, method<span class="op">=</span><span class="st">"ADF"</span>)</span>
<span id="cb73-5"><a href="#cb73-5" aria-hidden="true" tabindex="-1"></a>    unit_root_test(occup_train_guerrero[ward], n_lag<span class="op">=</span><span class="dv">10</span>, method<span class="op">=</span><span class="st">"KPSS"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Unit root test for ward_0:
ADF p-value: 0.000027 and data is stationary at 5% significance level
KPSS p-value: 0.010000 and data is non-stationary at 5% significance level
Unit root test for ward_1:
ADF p-value: 0.000006 and data is stationary at 5% significance level
KPSS p-value: 0.010000 and data is non-stationary at 5% significance level
Unit root test for ward_2:
ADF p-value: 0.000010 and data is stationary at 5% significance level
KPSS p-value: 0.010000 and data is non-stationary at 5% significance level
Unit root test for ward_3:
ADF p-value: 0.000178 and data is stationary at 5% significance level
KPSS p-value: 0.010000 and data is non-stationary at 5% significance level
Unit root test for ward_4:
ADF p-value: 0.000270 and data is stationary at 5% significance level
KPSS p-value: 0.010000 and data is non-stationary at 5% significance level
Unit root test for ward_5:
ADF p-value: 0.000000 and data is stationary at 5% significance level
KPSS p-value: 0.020208 and data is non-stationary at 5% significance level
Unit root test for ward_6:
ADF p-value: 0.000000 and data is stationary at 5% significance level
KPSS p-value: 0.010000 and data is non-stationary at 5% significance level</code></pre>
</div>
</div>
<div id="dfa27c87" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb75"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a><span class="co"># occup_train_fe = occup_train_clean.copy()</span></span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-3"><a href="#cb75-3" aria-hidden="true" tabindex="-1"></a><span class="co"># ## Since whole wards are non-stationary, first we detrended using differencing and also difference between original series-linear trends to try both</span></span>
<span id="cb75-4"><a href="#cb75-4" aria-hidden="true" tabindex="-1"></a><span class="co"># for ward, model in zip(ward_cols_, trend_lr_models["model"]):</span></span>
<span id="cb75-5"><a href="#cb75-5" aria-hidden="true" tabindex="-1"></a><span class="co">#     occup_train_fe[f"{ward}_diff"] = occup_train_fe[ward].diff()</span></span>
<span id="cb75-6"><a href="#cb75-6" aria-hidden="true" tabindex="-1"></a><span class="co">#     occup_train_fe[f"{ward}_gr_diff"] = occup_train_guerrero[ward].diff()</span></span>
<span id="cb75-7"><a href="#cb75-7" aria-hidden="true" tabindex="-1"></a><span class="co">#     br = list(trend_lr_models.loc[trend_lr_models["ward"]==ward, "breakpoint"])</span></span>
<span id="cb75-8"><a href="#cb75-8" aria-hidden="true" tabindex="-1"></a><span class="co">#     if ward == "ward_5":</span></span>
<span id="cb75-9"><a href="#cb75-9" aria-hidden="true" tabindex="-1"></a><span class="co">#         br = br[0]</span></span>
<span id="cb75-10"><a href="#cb75-10" aria-hidden="true" tabindex="-1"></a><span class="co">#     # print(f"breakpoints for {ward}: {br}")</span></span>
<span id="cb75-11"><a href="#cb75-11" aria-hidden="true" tabindex="-1"></a><span class="co">#     if model == "linear regression":</span></span>
<span id="cb75-12"><a href="#cb75-12" aria-hidden="true" tabindex="-1"></a><span class="co">#         occup_train_fe[f"{ward}_lr_diff"] = occup_train_fe[ward] - lr_trend_model(occup_train_fe[ward])[0]</span></span>
<span id="cb75-13"><a href="#cb75-13" aria-hidden="true" tabindex="-1"></a><span class="co">#         occup_train_fe[f"{ward}_gr_lr_diff"] = occup_train_guerrero[ward] - lr_trend_model(occup_train_guerrero[ward])[0]</span></span>
<span id="cb75-14"><a href="#cb75-14" aria-hidden="true" tabindex="-1"></a><span class="co">#     else:</span></span>
<span id="cb75-15"><a href="#cb75-15" aria-hidden="true" tabindex="-1"></a><span class="co">#         occup_train_fe[f"{ward}_lr_diff"] = occup_train_fe[ward] - lr_trend_model(occup_train_fe[ward], breakpoints=br,  type="piecewise")[0]</span></span>
<span id="cb75-16"><a href="#cb75-16" aria-hidden="true" tabindex="-1"></a><span class="co">#         occup_train_fe[f"{ward}_gr_lr_diff"] = occup_train_guerrero[ward] - lr_trend_model(occup_train_guerrero[ward], breakpoints=br, type="piecewise")[0]</span></span>
<span id="cb75-17"><a href="#cb75-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-18"><a href="#cb75-18" aria-hidden="true" tabindex="-1"></a><span class="co"># ## Then since referrals from CMHTs and follow-ups to CMHTs are intermitted, we create rolling window features to see if there might be significant patterns</span></span>
<span id="cb75-19"><a href="#cb75-19" aria-hidden="true" tabindex="-1"></a><span class="co"># windows= [14, 21, 28, 30, 35, 42, 60, 90]</span></span>
<span id="cb75-20"><a href="#cb75-20" aria-hidden="true" tabindex="-1"></a><span class="co"># for window in windows:</span></span>
<span id="cb75-21"><a href="#cb75-21" aria-hidden="true" tabindex="-1"></a><span class="co">#     # occup_train_fe[f"cmh_refer_w{window}_sum"] = occup_train_fe["cmht_refer"].rolling(window=window).sum()</span></span>
<span id="cb75-22"><a href="#cb75-22" aria-hidden="true" tabindex="-1"></a><span class="co">#     occup_train_fe[f"cmh_refer_w{window}_mean"] = occup_train_fe["cmht_refer"].rolling(window=window).mean()</span></span>
<span id="cb75-23"><a href="#cb75-23" aria-hidden="true" tabindex="-1"></a><span class="co">#     occup_train_fe[f"cmh_refer_w{window}_std"] = occup_train_fe["cmht_refer"].rolling(window=window).std()</span></span>
<span id="cb75-24"><a href="#cb75-24" aria-hidden="true" tabindex="-1"></a><span class="co">#     # occup_train_fe[f"cmh_refer_w{window}_mean_diff"] = occup_train_fe[f"cmh_refer_w{window}_mean"].diff(1)</span></span>
<span id="cb75-25"><a href="#cb75-25" aria-hidden="true" tabindex="-1"></a><span class="co">#     # occup_train_fe[f"cmh_refer_w{window}_std_diff"] = occup_train_fe[f"cmh_refer_w{window}_std"].diff(1)</span></span>
<span id="cb75-26"><a href="#cb75-26" aria-hidden="true" tabindex="-1"></a><span class="co"># # occup_train_fe[f"cmh_refer_expand_mean30"] = occup_train_fe["cmht_refer"].shift(30).expanding().mean()</span></span>
<span id="cb75-27"><a href="#cb75-27" aria-hidden="true" tabindex="-1"></a><span class="co"># # occup_train_fe[f"cmh_refer_expand_std30"] = occup_train_fe["cmht_refer"].shift(30).expanding().std()</span></span>
<span id="cb75-28"><a href="#cb75-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-29"><a href="#cb75-29" aria-hidden="true" tabindex="-1"></a><span class="co"># for window in windows:</span></span>
<span id="cb75-30"><a href="#cb75-30" aria-hidden="true" tabindex="-1"></a><span class="co">#     # occup_train_fe[f"cmh_follow_w{window}_sum"] = occup_train_fe["cmht_followup"].rolling(window=window).sum()</span></span>
<span id="cb75-31"><a href="#cb75-31" aria-hidden="true" tabindex="-1"></a><span class="co">#     occup_train_fe[f"cmh_follow_w{window}_mean"] = occup_train_fe["cmht_followup"].rolling(window=window).mean()</span></span>
<span id="cb75-32"><a href="#cb75-32" aria-hidden="true" tabindex="-1"></a><span class="co">#     occup_train_fe[f"cmh_follow_w{window}_std"] = occup_train_fe["cmht_followup"].rolling(window=window).std()</span></span>
<span id="cb75-33"><a href="#cb75-33" aria-hidden="true" tabindex="-1"></a><span class="co">#     # occup_train_fe[f"cmh_follow_w{window}_mean_diff"] = occup_train_fe[f"cmh_follow_w{window}_mean"].diff(1)</span></span>
<span id="cb75-34"><a href="#cb75-34" aria-hidden="true" tabindex="-1"></a><span class="co">#     # occup_train_fe[f"cmh_follow_w{window}_std_diff"] = occup_train_fe[f"cmh_follow_w{window}_std"].diff(1)</span></span>
<span id="cb75-35"><a href="#cb75-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-36"><a href="#cb75-36" aria-hidden="true" tabindex="-1"></a><span class="co"># # occup_train_fe[f"cmh_follow_expand_mean30"] = occup_train_fe["cmht_followup"].shift(30).expanding().mean()</span></span>
<span id="cb75-37"><a href="#cb75-37" aria-hidden="true" tabindex="-1"></a><span class="co"># # occup_train_fe[f"cmh_follow_expand_std30"] = occup_train_fe["cmht_followup"].shift(30).expanding().std()</span></span>
<span id="cb75-38"><a href="#cb75-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-39"><a href="#cb75-39" aria-hidden="true" tabindex="-1"></a><span class="co"># occup_train_fe.dropna(inplace=True)</span></span>
<span id="cb75-40"><a href="#cb75-40" aria-hidden="true" tabindex="-1"></a><span class="co"># occup_train_fe = occup_train_fe.drop(columns=["year", "holiday"])</span></span>
<span id="cb75-41"><a href="#cb75-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-42"><a href="#cb75-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-43"><a href="#cb75-43" aria-hidden="true" tabindex="-1"></a><span class="co"># ## Feature Engineering for Wards</span></span>
<span id="cb75-44"><a href="#cb75-44" aria-hidden="true" tabindex="-1"></a><span class="co"># fe_wards = occup_train_fe.filter(regex=r'ward_.*_.*gr_', axis=1)</span></span>
<span id="cb75-45"><a href="#cb75-45" aria-hidden="true" tabindex="-1"></a><span class="co"># # fe_w1 = occup_train_fe.filter(like="ward_1", axis=1)</span></span>
<span id="cb75-46"><a href="#cb75-46" aria-hidden="true" tabindex="-1"></a><span class="co"># # fe_w2 = occup_train_fe.filter(like="ward_2", axis=1)</span></span>
<span id="cb75-47"><a href="#cb75-47" aria-hidden="true" tabindex="-1"></a><span class="co"># # fe_w3 = occup_train_fe.filter(like="ward_3", axis=1)</span></span>
<span id="cb75-48"><a href="#cb75-48" aria-hidden="true" tabindex="-1"></a><span class="co"># # fe_w4 = occup_train_fe.filter(like="ward_4", axis=1)</span></span>
<span id="cb75-49"><a href="#cb75-49" aria-hidden="true" tabindex="-1"></a><span class="co"># # fe_w5 = occup_train_fe.filter(like="ward_5", axis=1)</span></span>
<span id="cb75-50"><a href="#cb75-50" aria-hidden="true" tabindex="-1"></a><span class="co"># # fe_w6 = occup_train_fe.filter(like="ward_6", axis=1)</span></span>
<span id="cb75-51"><a href="#cb75-51" aria-hidden="true" tabindex="-1"></a><span class="co"># fe_refer = occup_train_fe.filter(like="cmh_refer_", axis=1)</span></span>
<span id="cb75-52"><a href="#cb75-52" aria-hidden="true" tabindex="-1"></a><span class="co"># fe_follow = occup_train_fe.filter(like="cmh_follow_", axis=1)</span></span>
<span id="cb75-53"><a href="#cb75-53" aria-hidden="true" tabindex="-1"></a><span class="co"># # fe_refer = fe_refer.drop(fe_refer.filter(like="_sum").columns, axis=1)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="686e29fc" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb76"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ccf_strength(fe_wards["ward_1_gr_lr_diff"], fe_refer["cmh_refer_w60_mean"],</span></span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a><span class="co">#              adjusted=True, n_lags=90)[["lags", "ccf_value"]].reset_index(drop=True)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="e1d42d2d" class="cell" data-execution_count="17">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb77"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a>param_space_s <span class="op">=</span> {<span class="st">"trend"</span>: hp.choice(<span class="st">"trend"</span>, [<span class="va">None</span>, <span class="st">"add"</span>, <span class="st">"mul"</span>]),</span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a>         <span class="st">"seasonal"</span>: hp.choice(<span class="st">"seasonal"</span>, [<span class="va">None</span>, <span class="st">"add"</span>, <span class="st">"mul"</span>]),</span>
<span id="cb77-3"><a href="#cb77-3" aria-hidden="true" tabindex="-1"></a>                 <span class="st">"seasonal_periods"</span>:<span class="dv">7</span>,</span>
<span id="cb77-4"><a href="#cb77-4" aria-hidden="true" tabindex="-1"></a>        <span class="st">"damped_trend"</span>: hp.choice(<span class="st">"damped_trend"</span>, [<span class="va">True</span>, <span class="va">False</span>]),</span>
<span id="cb77-5"><a href="#cb77-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">'smoothing_level'</span>: hp.uniform(<span class="st">'smoothing_level'</span>, <span class="dv">0</span>, <span class="fl">0.99</span>),</span>
<span id="cb77-6"><a href="#cb77-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">'smoothing_trend'</span>: hp.uniform(<span class="st">'smoothing_trend'</span>, <span class="dv">0</span>, <span class="fl">0.99</span>),</span>
<span id="cb77-7"><a href="#cb77-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">'smoothing_seasonal'</span>: hp.uniform(<span class="st">'smoothing_seasonal'</span>, <span class="dv">0</span>, <span class="fl">0.99</span>),</span>
<span id="cb77-8"><a href="#cb77-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">'damping_trend'</span>: hp.uniform(<span class="st">'damping_trend'</span>, <span class="dv">0</span>, <span class="fl">0.99</span>)</span>
<span id="cb77-9"><a href="#cb77-9" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb77-10"><a href="#cb77-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-11"><a href="#cb77-11" aria-hidden="true" tabindex="-1"></a>param_space_t <span class="op">=</span> {<span class="st">"trend"</span>: hp.choice(<span class="st">"trend"</span>, [<span class="va">None</span>, <span class="st">"add"</span>, <span class="st">"mul"</span>]),</span>
<span id="cb77-12"><a href="#cb77-12" aria-hidden="true" tabindex="-1"></a>        <span class="st">"damped_trend"</span>: hp.choice(<span class="st">"damped_trend"</span>, [<span class="va">True</span>, <span class="va">False</span>]),</span>
<span id="cb77-13"><a href="#cb77-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">'smoothing_level'</span>: hp.uniform(<span class="st">'smoothing_level'</span>, <span class="dv">0</span>, <span class="fl">0.99</span>),</span>
<span id="cb77-14"><a href="#cb77-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">'smoothing_trend'</span>: hp.uniform(<span class="st">'smoothing_trend'</span>, <span class="dv">0</span>, <span class="fl">0.99</span>),</span>
<span id="cb77-15"><a href="#cb77-15" aria-hidden="true" tabindex="-1"></a>    <span class="st">'damping_trend'</span>: hp.uniform(<span class="st">'damping_trend'</span>, <span class="dv">0</span>, <span class="fl">0.99</span>)</span>
<span id="cb77-16"><a href="#cb77-16" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="a9d7b1ec" class="cell" data-execution_count="17">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb78"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ets_season_param = {}</span></span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a><span class="co"># for w in ward_cols_:</span></span>
<span id="cb78-3"><a href="#cb78-3" aria-hidden="true" tabindex="-1"></a><span class="co">#    print(f"Tuning ETS model for {w} for whole components")</span></span>
<span id="cb78-4"><a href="#cb78-4" aria-hidden="true" tabindex="-1"></a><span class="co">#    ets_season_param[w] = tune_ets(data=occup_train_clean[w], param_space=param_space_s, cv_splits=30,</span></span>
<span id="cb78-5"><a href="#cb78-5" aria-hidden="true" tabindex="-1"></a><span class="co">#              horizon=30, step_size=13, eval_metric=SRMSE, eval_num=1000, verbose=False)</span></span>
<span id="cb78-6"><a href="#cb78-6" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb78-7"><a href="#cb78-7" aria-hidden="true" tabindex="-1"></a><span class="co"># # Save to file</span></span>
<span id="cb78-8"><a href="#cb78-8" aria-hidden="true" tabindex="-1"></a><span class="co"># with open('model_params/ets_season_param.pkl', 'wb') as f:</span></span>
<span id="cb78-9"><a href="#cb78-9" aria-hidden="true" tabindex="-1"></a><span class="co">#     pickle.dump(ets_season_param, f)</span></span>
<span id="cb78-10"><a href="#cb78-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-11"><a href="#cb78-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Load from file</span></span>
<span id="cb78-12"><a href="#cb78-12" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(<span class="st">'model_params/ets_season_param.pkl'</span>, <span class="st">'rb'</span>) <span class="im">as</span> f:</span>
<span id="cb78-13"><a href="#cb78-13" aria-hidden="true" tabindex="-1"></a>    ets_season_param <span class="op">=</span> pickle.load(f)</span>
<span id="cb78-14"><a href="#cb78-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-15"><a href="#cb78-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-16"><a href="#cb78-16" aria-hidden="true" tabindex="-1"></a><span class="co"># ets_trend30_param = {}</span></span>
<span id="cb78-17"><a href="#cb78-17" aria-hidden="true" tabindex="-1"></a><span class="co"># for w in ward_cols_:</span></span>
<span id="cb78-18"><a href="#cb78-18" aria-hidden="true" tabindex="-1"></a><span class="co">#    print(f"Tuning ETS model for {w} for trend-30 components")</span></span>
<span id="cb78-19"><a href="#cb78-19" aria-hidden="true" tabindex="-1"></a><span class="co">#    ets_trend30_param[w] = tune_ets(data=occup_train_clean[w], param_space=param_space_t, cv_splits=30,</span></span>
<span id="cb78-20"><a href="#cb78-20" aria-hidden="true" tabindex="-1"></a><span class="co">#              horizon=30, step_size=13, eval_metric=SRMSE, eval_num=1000, verbose=False)</span></span>
<span id="cb78-21"><a href="#cb78-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-22"><a href="#cb78-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-23"><a href="#cb78-23" aria-hidden="true" tabindex="-1"></a><span class="co"># # Save to file</span></span>
<span id="cb78-24"><a href="#cb78-24" aria-hidden="true" tabindex="-1"></a><span class="co"># with open('model_params/ets_trend30_param.pkl', 'wb') as f:</span></span>
<span id="cb78-25"><a href="#cb78-25" aria-hidden="true" tabindex="-1"></a><span class="co">#     pickle.dump(ets_trend30_param, f)</span></span>
<span id="cb78-26"><a href="#cb78-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-27"><a href="#cb78-27" aria-hidden="true" tabindex="-1"></a><span class="co"># Load from file</span></span>
<span id="cb78-28"><a href="#cb78-28" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(<span class="st">'model_params/ets_trend30_param.pkl'</span>, <span class="st">'rb'</span>) <span class="im">as</span> f:</span>
<span id="cb78-29"><a href="#cb78-29" aria-hidden="true" tabindex="-1"></a>    ets_trend30_param <span class="op">=</span> pickle.load(f)</span>
<span id="cb78-30"><a href="#cb78-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-31"><a href="#cb78-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-32"><a href="#cb78-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-33"><a href="#cb78-33" aria-hidden="true" tabindex="-1"></a><span class="co"># ets_trend45_param = {}</span></span>
<span id="cb78-34"><a href="#cb78-34" aria-hidden="true" tabindex="-1"></a><span class="co"># for w in ward_cols_:</span></span>
<span id="cb78-35"><a href="#cb78-35" aria-hidden="true" tabindex="-1"></a><span class="co">#    print(f"Tuning ETS model for {w} for trend-45 components")</span></span>
<span id="cb78-36"><a href="#cb78-36" aria-hidden="true" tabindex="-1"></a><span class="co">#    ets_trend45_param[w] = tune_ets(data=occup_train_clean[w], param_space=param_space_t, cv_splits=30,</span></span>
<span id="cb78-37"><a href="#cb78-37" aria-hidden="true" tabindex="-1"></a><span class="co">#              horizon=45, step_size=13, eval_metric=SRMSE, eval_num=1000, verbose=False)</span></span>
<span id="cb78-38"><a href="#cb78-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-39"><a href="#cb78-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-40"><a href="#cb78-40" aria-hidden="true" tabindex="-1"></a><span class="co"># # Save to file</span></span>
<span id="cb78-41"><a href="#cb78-41" aria-hidden="true" tabindex="-1"></a><span class="co"># with open('model_params/ets_trend45_param.pkl', 'wb') as f:</span></span>
<span id="cb78-42"><a href="#cb78-42" aria-hidden="true" tabindex="-1"></a><span class="co">#     pickle.dump(ets_trend45_param, f)</span></span>
<span id="cb78-43"><a href="#cb78-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-44"><a href="#cb78-44" aria-hidden="true" tabindex="-1"></a><span class="co"># Load from file</span></span>
<span id="cb78-45"><a href="#cb78-45" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(<span class="st">'model_params/ets_trend45_param.pkl'</span>, <span class="st">'rb'</span>) <span class="im">as</span> f:</span>
<span id="cb78-46"><a href="#cb78-46" aria-hidden="true" tabindex="-1"></a>    ets_trend45_param <span class="op">=</span> pickle.load(f)</span>
<span id="cb78-47"><a href="#cb78-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-48"><a href="#cb78-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-49"><a href="#cb78-49" aria-hidden="true" tabindex="-1"></a><span class="co"># ets_trend60_param = {}</span></span>
<span id="cb78-50"><a href="#cb78-50" aria-hidden="true" tabindex="-1"></a><span class="co"># for w in ward_cols_:</span></span>
<span id="cb78-51"><a href="#cb78-51" aria-hidden="true" tabindex="-1"></a><span class="co">#    print(f"Tuning ETS model for {w} for trend-60 components")</span></span>
<span id="cb78-52"><a href="#cb78-52" aria-hidden="true" tabindex="-1"></a><span class="co">#    ets_trend60_param[w] = tune_ets(data=occup_train_clean[w], param_space=param_space_t, cv_splits=30,</span></span>
<span id="cb78-53"><a href="#cb78-53" aria-hidden="true" tabindex="-1"></a><span class="co">#              horizon=60, step_size=13, eval_metric=SRMSE, eval_num=1000, verbose=False)</span></span>
<span id="cb78-54"><a href="#cb78-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-55"><a href="#cb78-55" aria-hidden="true" tabindex="-1"></a><span class="co"># # Save to file</span></span>
<span id="cb78-56"><a href="#cb78-56" aria-hidden="true" tabindex="-1"></a><span class="co"># with open('model_params/ets_trend60_param.pkl', 'wb') as f:</span></span>
<span id="cb78-57"><a href="#cb78-57" aria-hidden="true" tabindex="-1"></a><span class="co">#     pickle.dump(ets_trend60_param, f)</span></span>
<span id="cb78-58"><a href="#cb78-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-59"><a href="#cb78-59" aria-hidden="true" tabindex="-1"></a><span class="co"># Load from file</span></span>
<span id="cb78-60"><a href="#cb78-60" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(<span class="st">'model_params/ets_trend60_param.pkl'</span>, <span class="st">'rb'</span>) <span class="im">as</span> f:</span>
<span id="cb78-61"><a href="#cb78-61" aria-hidden="true" tabindex="-1"></a>    ets_trend60_param <span class="op">=</span> pickle.load(f)</span>
<span id="cb78-62"><a href="#cb78-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-63"><a href="#cb78-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-64"><a href="#cb78-64" aria-hidden="true" tabindex="-1"></a><span class="co"># ets_trend90_param = {}</span></span>
<span id="cb78-65"><a href="#cb78-65" aria-hidden="true" tabindex="-1"></a><span class="co"># for w in ward_cols_:</span></span>
<span id="cb78-66"><a href="#cb78-66" aria-hidden="true" tabindex="-1"></a><span class="co">#    print(f"Tuning ETS model for {w} for trend-90 components")</span></span>
<span id="cb78-67"><a href="#cb78-67" aria-hidden="true" tabindex="-1"></a><span class="co">#    ets_trend90_param[w] = tune_ets(data=occup_train_clean[w], param_space=param_space_t, cv_splits=30,</span></span>
<span id="cb78-68"><a href="#cb78-68" aria-hidden="true" tabindex="-1"></a><span class="co">#              horizon=90, step_size=13, eval_metric=SRMSE, eval_num=1000, verbose=False)</span></span>
<span id="cb78-69"><a href="#cb78-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-70"><a href="#cb78-70" aria-hidden="true" tabindex="-1"></a><span class="co"># # Save to file</span></span>
<span id="cb78-71"><a href="#cb78-71" aria-hidden="true" tabindex="-1"></a><span class="co"># with open('model_params/ets_trend90_param.pkl', 'wb') as f:</span></span>
<span id="cb78-72"><a href="#cb78-72" aria-hidden="true" tabindex="-1"></a><span class="co">#     pickle.dump(ets_trend90_param, f)</span></span>
<span id="cb78-73"><a href="#cb78-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-74"><a href="#cb78-74" aria-hidden="true" tabindex="-1"></a><span class="co"># Load from file</span></span>
<span id="cb78-75"><a href="#cb78-75" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(<span class="st">'model_params/ets_trend90_param.pkl'</span>, <span class="st">'rb'</span>) <span class="im">as</span> f:</span>
<span id="cb78-76"><a href="#cb78-76" aria-hidden="true" tabindex="-1"></a>    ets_trend90_param <span class="op">=</span> pickle.load(f)</span>
<span id="cb78-77"><a href="#cb78-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-78"><a href="#cb78-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-79"><a href="#cb78-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-80"><a href="#cb78-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-81"><a href="#cb78-81" aria-hidden="true" tabindex="-1"></a><span class="co"># ets_trend180_param = {}</span></span>
<span id="cb78-82"><a href="#cb78-82" aria-hidden="true" tabindex="-1"></a><span class="co"># for w in ward_cols_:</span></span>
<span id="cb78-83"><a href="#cb78-83" aria-hidden="true" tabindex="-1"></a><span class="co">#    print(f"Tuning ETS model for {w} for trend-180 components")</span></span>
<span id="cb78-84"><a href="#cb78-84" aria-hidden="true" tabindex="-1"></a><span class="co">#    ets_trend180_param[w] = tune_ets(data=occup_train_clean[w], param_space=param_space_t, cv_splits=30,</span></span>
<span id="cb78-85"><a href="#cb78-85" aria-hidden="true" tabindex="-1"></a><span class="co">#              horizon=180, step_size=13, eval_metric=SRMSE, eval_num=1000, verbose=False)</span></span>
<span id="cb78-86"><a href="#cb78-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-87"><a href="#cb78-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-88"><a href="#cb78-88" aria-hidden="true" tabindex="-1"></a><span class="co"># # Save to file</span></span>
<span id="cb78-89"><a href="#cb78-89" aria-hidden="true" tabindex="-1"></a><span class="co"># with open('model_params/ets_trend180_param.pkl', 'wb') as f:</span></span>
<span id="cb78-90"><a href="#cb78-90" aria-hidden="true" tabindex="-1"></a><span class="co">#     pickle.dump(ets_trend180_param, f)</span></span>
<span id="cb78-91"><a href="#cb78-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-92"><a href="#cb78-92" aria-hidden="true" tabindex="-1"></a><span class="co"># Load from file</span></span>
<span id="cb78-93"><a href="#cb78-93" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(<span class="st">'model_params/ets_trend180_param.pkl'</span>, <span class="st">'rb'</span>) <span class="im">as</span> f:</span>
<span id="cb78-94"><a href="#cb78-94" aria-hidden="true" tabindex="-1"></a>    ets_trend180_param <span class="op">=</span> pickle.load(f)</span>
<span id="cb78-95"><a href="#cb78-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-96"><a href="#cb78-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-97"><a href="#cb78-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-98"><a href="#cb78-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-99"><a href="#cb78-99" aria-hidden="true" tabindex="-1"></a><span class="co"># ets_trend120_param = {}</span></span>
<span id="cb78-100"><a href="#cb78-100" aria-hidden="true" tabindex="-1"></a><span class="co"># for w in ward_cols_:</span></span>
<span id="cb78-101"><a href="#cb78-101" aria-hidden="true" tabindex="-1"></a><span class="co">#    print(f"Tuning ETS model for {w} for trend-120 components")</span></span>
<span id="cb78-102"><a href="#cb78-102" aria-hidden="true" tabindex="-1"></a><span class="co">#    ets_trend120_param[w] = tune_ets(data=occup_train_clean[w], param_space=param_space_t, cv_splits=30,</span></span>
<span id="cb78-103"><a href="#cb78-103" aria-hidden="true" tabindex="-1"></a><span class="co">#              horizon=120, step_size=13, eval_metric=SRMSE, eval_num=1000, verbose=False)</span></span>
<span id="cb78-104"><a href="#cb78-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-105"><a href="#cb78-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-106"><a href="#cb78-106" aria-hidden="true" tabindex="-1"></a><span class="co"># # Save to file</span></span>
<span id="cb78-107"><a href="#cb78-107" aria-hidden="true" tabindex="-1"></a><span class="co"># with open('model_params/ets_trend120_param.pkl', 'wb') as f:</span></span>
<span id="cb78-108"><a href="#cb78-108" aria-hidden="true" tabindex="-1"></a><span class="co">#     pickle.dump(ets_trend120_param, f)</span></span>
<span id="cb78-109"><a href="#cb78-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-110"><a href="#cb78-110" aria-hidden="true" tabindex="-1"></a><span class="co"># Load from file</span></span>
<span id="cb78-111"><a href="#cb78-111" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(<span class="st">'model_params/ets_trend120_param.pkl'</span>, <span class="st">'rb'</span>) <span class="im">as</span> f:</span>
<span id="cb78-112"><a href="#cb78-112" aria-hidden="true" tabindex="-1"></a>    ets_trend120_param <span class="op">=</span> pickle.load(f)</span>
<span id="cb78-113"><a href="#cb78-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-114"><a href="#cb78-114" aria-hidden="true" tabindex="-1"></a><span class="co"># # Load from file</span></span>
<span id="cb78-115"><a href="#cb78-115" aria-hidden="true" tabindex="-1"></a><span class="co"># with open('model_params/all_trend_ets_params.pkl', 'rb') as f:</span></span>
<span id="cb78-116"><a href="#cb78-116" aria-hidden="true" tabindex="-1"></a><span class="co">#     all_trend_ets_params = pickle.load(f)</span></span>
<span id="cb78-117"><a href="#cb78-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-118"><a href="#cb78-118" aria-hidden="true" tabindex="-1"></a><span class="co"># # Load from file</span></span>
<span id="cb78-119"><a href="#cb78-119" aria-hidden="true" tabindex="-1"></a><span class="co"># with open('model_params/all_trend_ets_params.pkl', 'rb') as f:</span></span>
<span id="cb78-120"><a href="#cb78-120" aria-hidden="true" tabindex="-1"></a><span class="co">#     all_trend_ets_params = pickle.load(f)</span></span>
<span id="cb78-121"><a href="#cb78-121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-122"><a href="#cb78-122" aria-hidden="true" tabindex="-1"></a>all_possible_ets_params <span class="op">=</span> {</span>
<span id="cb78-123"><a href="#cb78-123" aria-hidden="true" tabindex="-1"></a>    <span class="st">"trend_30"</span>: ets_trend30_param,</span>
<span id="cb78-124"><a href="#cb78-124" aria-hidden="true" tabindex="-1"></a>    <span class="st">"trend_45"</span>: ets_trend45_param,</span>
<span id="cb78-125"><a href="#cb78-125" aria-hidden="true" tabindex="-1"></a>    <span class="st">"trend_60"</span>: ets_trend60_param,</span>
<span id="cb78-126"><a href="#cb78-126" aria-hidden="true" tabindex="-1"></a>    <span class="st">"trend_90"</span>: ets_trend90_param,</span>
<span id="cb78-127"><a href="#cb78-127" aria-hidden="true" tabindex="-1"></a>    <span class="st">"trend_120"</span>: ets_trend120_param,</span>
<span id="cb78-128"><a href="#cb78-128" aria-hidden="true" tabindex="-1"></a>    <span class="st">"trend_180"</span>: ets_trend180_param,</span>
<span id="cb78-129"><a href="#cb78-129" aria-hidden="true" tabindex="-1"></a>    <span class="st">'linear'</span>: {w: <span class="va">None</span> <span class="cf">for</span> w <span class="kw">in</span> ward_cols_}</span>
<span id="cb78-130"><a href="#cb78-130" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb78-131"><a href="#cb78-131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-132"><a href="#cb78-132" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-133"><a href="#cb78-133" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> t <span class="kw">in</span> all_possible_ets_params:</span>
<span id="cb78-134"><a href="#cb78-134" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> t <span class="op">==</span> <span class="st">'linear'</span>:</span>
<span id="cb78-135"><a href="#cb78-135" aria-hidden="true" tabindex="-1"></a>        <span class="cf">continue</span></span>
<span id="cb78-136"><a href="#cb78-136" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb78-137"><a href="#cb78-137" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> w <span class="kw">in</span> ward_cols_:</span>
<span id="cb78-138"><a href="#cb78-138" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> all_possible_ets_params[t][w][<span class="dv">0</span>] <span class="op">==</span> {<span class="st">'damped_trend'</span>: <span class="va">True</span>}:</span>
<span id="cb78-139"><a href="#cb78-139" aria-hidden="true" tabindex="-1"></a>                lst <span class="op">=</span> <span class="bu">list</span>(all_possible_ets_params[t][w])</span>
<span id="cb78-140"><a href="#cb78-140" aria-hidden="true" tabindex="-1"></a>                all_possible_ets_params[t][w] <span class="op">=</span> lst</span>
<span id="cb78-141"><a href="#cb78-141" aria-hidden="true" tabindex="-1"></a>                all_possible_ets_params[t][w][<span class="dv">0</span>] <span class="op">=</span> {<span class="st">'damped_trend'</span>: <span class="va">False</span>}</span>
<span id="cb78-142"><a href="#cb78-142" aria-hidden="true" tabindex="-1"></a>                all_possible_ets_params[t][w] <span class="op">=</span> <span class="bu">tuple</span>(lst)</span>
<span id="cb78-143"><a href="#cb78-143" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f"Changed damped_trend for </span><span class="sc">{</span>w<span class="sc">}</span><span class="ss"> in </span><span class="sc">{</span>t<span class="sc">}</span><span class="ss"> ETS params"</span>)</span>
<span id="cb78-144"><a href="#cb78-144" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-145"><a href="#cb78-145" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-146"><a href="#cb78-146" aria-hidden="true" tabindex="-1"></a>occup_train_clean[<span class="st">"day_of_week"</span>] <span class="op">=</span> occup_train_clean.index.day_name()</span>
<span id="cb78-147"><a href="#cb78-147" aria-hidden="true" tabindex="-1"></a>occup_train_clean[<span class="st">"month"</span>] <span class="op">=</span> occup_train_clean.index.month_name()</span>
<span id="cb78-148"><a href="#cb78-148" aria-hidden="true" tabindex="-1"></a>occup_train_clean[<span class="st">"is_holiday"</span>] <span class="op">=</span> np.where(occup_train_clean[<span class="st">"is_holiday"</span>] <span class="op">==</span> <span class="dv">1</span>, <span class="st">"holiday"</span>, <span class="st">"not holiday"</span>)</span>
<span id="cb78-149"><a href="#cb78-149" aria-hidden="true" tabindex="-1"></a>cat_cols <span class="op">=</span> [<span class="st">"day_of_week"</span>, <span class="st">"month"</span>, <span class="st">"is_holiday"</span>]</span>
<span id="cb78-150"><a href="#cb78-150" aria-hidden="true" tabindex="-1"></a>cat_col_f <span class="op">=</span> [<span class="st">"day_of_week"</span>, <span class="st">"is_holiday"</span>]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Changed damped_trend for ward_4 in trend_45 ETS params
Changed damped_trend for ward_3 in trend_90 ETS params
Changed damped_trend for ward_5 in trend_90 ETS params
Changed damped_trend for ward_5 in trend_180 ETS params</code></pre>
</div>
</div>
<div id="e77b49ad" class="cell" data-execution_count="18">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb80"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> data_prep_f(ward, fourier_k):</span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a>    ward_train <span class="op">=</span> occup_train_clean[[ward]<span class="op">+</span>cat_col_f]</span>
<span id="cb80-3"><a href="#cb80-3" aria-hidden="true" tabindex="-1"></a>    ward_test <span class="op">=</span> occup_test[[ward]<span class="op">+</span>cat_col_f]</span>
<span id="cb80-4"><a href="#cb80-4" aria-hidden="true" tabindex="-1"></a>    ward_test[ward] <span class="op">=</span> ward_test[ward].interpolate(method<span class="op">=</span><span class="st">"linear"</span>)</span>
<span id="cb80-5"><a href="#cb80-5" aria-hidden="true" tabindex="-1"></a>    ward_test[<span class="st">"day_of_week"</span>] <span class="op">=</span> ward_test.index.day_name()</span>
<span id="cb80-6"><a href="#cb80-6" aria-hidden="true" tabindex="-1"></a>    df_all <span class="op">=</span> pd.concat([ward_train, ward_test], axis<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb80-7"><a href="#cb80-7" aria-hidden="true" tabindex="-1"></a>    ft <span class="op">=</span> fourier_terms(start_end_index<span class="op">=</span>(df_all.index.<span class="bu">min</span>(), df_all.index.<span class="bu">max</span>()),</span>
<span id="cb80-8"><a href="#cb80-8" aria-hidden="true" tabindex="-1"></a>                period<span class="op">=</span><span class="fl">365.25</span>, num_terms<span class="op">=</span>fourier_k)</span>
<span id="cb80-9"><a href="#cb80-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df_all.merge(ft, left_index<span class="op">=</span><span class="va">True</span>, right_index<span class="op">=</span><span class="va">True</span>, how<span class="op">=</span><span class="st">"left"</span>)</span>
<span id="cb80-10"><a href="#cb80-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-11"><a href="#cb80-11" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> data_prep(ward):</span>
<span id="cb80-12"><a href="#cb80-12" aria-hidden="true" tabindex="-1"></a>    ward_train <span class="op">=</span> occup_train_clean[[ward]<span class="op">+</span>cat_cols]</span>
<span id="cb80-13"><a href="#cb80-13" aria-hidden="true" tabindex="-1"></a>    ward_test <span class="op">=</span> occup_test[[ward]<span class="op">+</span>cat_cols]</span>
<span id="cb80-14"><a href="#cb80-14" aria-hidden="true" tabindex="-1"></a>    ward_test[ward] <span class="op">=</span> ward_test[ward].interpolate(method<span class="op">=</span><span class="st">"linear"</span>)</span>
<span id="cb80-15"><a href="#cb80-15" aria-hidden="true" tabindex="-1"></a>    ward_test[<span class="st">"day_of_week"</span>] <span class="op">=</span> ward_test.index.day_name()</span>
<span id="cb80-16"><a href="#cb80-16" aria-hidden="true" tabindex="-1"></a>    ward_test[<span class="st">"month"</span>] <span class="op">=</span> ward_test.index.month_name()</span>
<span id="cb80-17"><a href="#cb80-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pd.concat([ward_train, ward_test], axis<span class="op">=</span><span class="dv">0</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="6722b918" class="cell" data-execution_count="19">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb81"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load from file</span></span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(<span class="st">'model_params/best_ward_ets_tk.pkl'</span>, <span class="st">'rb'</span>) <span class="im">as</span> f:</span>
<span id="cb81-3"><a href="#cb81-3" aria-hidden="true" tabindex="-1"></a>    best_ward_ets_tk <span class="op">=</span> pickle.load(f)</span>
<span id="cb81-4"><a href="#cb81-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Load from file</span></span>
<span id="cb81-5"><a href="#cb81-5" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(<span class="st">'model_params/ml_best_ward_ets.pkl'</span>, <span class="st">'rb'</span>) <span class="im">as</span> f:</span>
<span id="cb81-6"><a href="#cb81-6" aria-hidden="true" tabindex="-1"></a>    ml_best_ward_ets <span class="op">=</span> pickle.load(f)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="0774b2f6" class="cell" data-execution_count="20">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb82"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a>df_diff <span class="op">=</span> pd.DataFrame()</span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> w <span class="kw">in</span> ward_cols_:</span>
<span id="cb82-3"><a href="#cb82-3" aria-hidden="true" tabindex="-1"></a>    df_diff[<span class="ss">f'</span><span class="sc">{</span>w<span class="sc">}</span><span class="ss">'</span>] <span class="op">=</span> occup_train_clean[w]</span>
<span id="cb82-4"><a href="#cb82-4" aria-hidden="true" tabindex="-1"></a>    df_diff[<span class="ss">f'</span><span class="sc">{</span>w<span class="sc">}</span><span class="ss">_diff'</span>] <span class="op">=</span> occup_train_clean[w].diff()</span>
<span id="cb82-5"><a href="#cb82-5" aria-hidden="true" tabindex="-1"></a>    df_diff[<span class="ss">f'</span><span class="sc">{</span>w<span class="sc">}</span><span class="ss">_fitted_ets_trend'</span>] <span class="op">=</span> ExponentialSmoothing(occup_train_clean[w], <span class="op">**</span>best_ward_ets_tk[w][<span class="dv">0</span>][<span class="dv">0</span>]).fit(<span class="op">**</span>best_ward_ets_tk[w][<span class="dv">0</span>][<span class="dv">1</span>]).fittedvalues</span>
<span id="cb82-6"><a href="#cb82-6" aria-hidden="true" tabindex="-1"></a>    df_diff[<span class="ss">f'</span><span class="sc">{</span>w<span class="sc">}</span><span class="ss">_detrended'</span>] <span class="op">=</span> df_diff[<span class="ss">f'</span><span class="sc">{</span>w<span class="sc">}</span><span class="ss">'</span>] <span class="op">-</span> df_diff[<span class="ss">f'</span><span class="sc">{</span>w<span class="sc">}</span><span class="ss">_fitted_ets_trend'</span>]</span>
<span id="cb82-7"><a href="#cb82-7" aria-hidden="true" tabindex="-1"></a>df_diff.dropna(inplace<span class="op">=</span><span class="va">True</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="8492c469" class="cell" data-execution_count="21">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb83"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a><span class="co"># plot original differenced series in two plots in one graph</span></span>
<span id="cb83-2"><a href="#cb83-2" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">15</span>, <span class="dv">10</span>))</span>
<span id="cb83-3"><a href="#cb83-3" aria-hidden="true" tabindex="-1"></a>plt.plot(df_diff.index[<span class="op">-</span><span class="dv">500</span>:], df_diff[<span class="st">'ward_0'</span>][<span class="op">-</span><span class="dv">500</span>:], label<span class="op">=</span><span class="st">'Original Differenced Series'</span>, color<span class="op">=</span><span class="st">'C0'</span>, alpha<span class="op">=</span><span class="fl">0.9</span>)</span>
<span id="cb83-4"><a href="#cb83-4" aria-hidden="true" tabindex="-1"></a>plt.plot(df_diff.index[<span class="op">-</span><span class="dv">500</span>:], df_diff[<span class="st">'ward_0_fitted_ets_trend'</span>][<span class="op">-</span><span class="dv">500</span>:], label<span class="op">=</span><span class="st">'Fitted ETS Trend'</span>, color<span class="op">=</span><span class="st">'C1'</span>, alpha<span class="op">=</span><span class="fl">0.9</span>)</span>
<span id="cb83-5"><a href="#cb83-5" aria-hidden="true" tabindex="-1"></a>plt.plot(df_diff.index[<span class="op">-</span><span class="dv">500</span>:], df_diff[<span class="st">'ward_0_detrended'</span>][<span class="op">-</span><span class="dv">500</span>:], label<span class="op">=</span><span class="st">'Detrended Series'</span>, color<span class="op">=</span><span class="st">'C2'</span>, alpha<span class="op">=</span><span class="fl">0.9</span>)</span>
<span id="cb83-6"><a href="#cb83-6" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Original Differenced Series vs Detrended Series for ward_0'</span>)</span>
<span id="cb83-7"><a href="#cb83-7" aria-hidden="true" tabindex="-1"></a>plt.legend(loc<span class="op">=</span><span class="st">'lower right'</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="occupancy_nb_files/figure-html/cell-70-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="57cd4332" class="cell" data-execution_count="22">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb84"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a><span class="co"># plot original differenced series in two plots in one graph</span></span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true" tabindex="-1"></a>fig, axs <span class="op">=</span> plt.subplots(<span class="dv">3</span>, <span class="dv">1</span>, figsize<span class="op">=</span>(<span class="dv">15</span>, <span class="dv">10</span>))</span>
<span id="cb84-3"><a href="#cb84-3" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>].plot(df_diff.index, df_diff[<span class="st">'ward_0'</span>], label<span class="op">=</span><span class="st">'Original Differenced Series'</span>, color<span class="op">=</span><span class="st">'C0'</span>, alpha<span class="op">=</span><span class="fl">0.9</span>)</span>
<span id="cb84-4"><a href="#cb84-4" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>].set_title(<span class="st">'Original Differenced Series for ward_0'</span>)</span>
<span id="cb84-5"><a href="#cb84-5" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>].legend(loc <span class="op">=</span> <span class="st">'lower right'</span>)</span>
<span id="cb84-6"><a href="#cb84-6" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">1</span>].plot(df_diff.index, df_diff[<span class="st">'ward_0_fitted_ets_trend'</span>], label<span class="op">=</span><span class="st">'Fitted ETS Trend'</span>, color<span class="op">=</span><span class="st">'C1'</span>, alpha<span class="op">=</span><span class="fl">0.9</span>)</span>
<span id="cb84-7"><a href="#cb84-7" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">1</span>].set_title(<span class="st">'Fitted ETS Trend for ward_0 occupancy'</span>)</span>
<span id="cb84-8"><a href="#cb84-8" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">1</span>].legend(loc <span class="op">=</span> <span class="st">'lower right'</span>)</span>
<span id="cb84-9"><a href="#cb84-9" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">2</span>].plot(df_diff.index, df_diff[<span class="st">'ward_0_detrended'</span>], label<span class="op">=</span><span class="st">'detrended series'</span>, color<span class="op">=</span><span class="st">'C2'</span>, alpha<span class="op">=</span><span class="fl">0.9</span>)</span>
<span id="cb84-10"><a href="#cb84-10" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">2</span>].set_title(<span class="st">'Detrended Series for ward_0 occupancy'</span>)</span>
<span id="cb84-11"><a href="#cb84-11" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">2</span>].legend(loc <span class="op">=</span> <span class="st">'lower right'</span>)</span>
<span id="cb84-12"><a href="#cb84-12" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb84-13"><a href="#cb84-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-14"><a href="#cb84-14" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="occupancy_nb_files/figure-html/cell-71-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="721bf9e0" class="cell" data-execution_count="83">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb85"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(<span class="dv">2</span>, <span class="dv">1</span>, figsize<span class="op">=</span>(<span class="dv">15</span>, <span class="dv">10</span>))</span>
<span id="cb85-2"><a href="#cb85-2" aria-hidden="true" tabindex="-1"></a>plot_acf(df_diff[<span class="st">'ward_0_diff'</span>], lags<span class="op">=</span><span class="dv">40</span>, ax<span class="op">=</span>axes[<span class="dv">0</span>])</span>
<span id="cb85-3"><a href="#cb85-3" aria-hidden="true" tabindex="-1"></a>plot_pacf(df_diff[<span class="st">'ward_0_diff'</span>], lags<span class="op">=</span><span class="dv">40</span>, ax<span class="op">=</span>axes[<span class="dv">1</span>])</span>
<span id="cb85-4"><a href="#cb85-4" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_title(<span class="st">'ACF of Differenced Series for ward_0 occupancy'</span>)</span>
<span id="cb85-5"><a href="#cb85-5" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_title(<span class="st">'PACF of Differenced Series for ward_0 occupancy'</span>)</span>
<span id="cb85-6"><a href="#cb85-6" aria-hidden="true" tabindex="-1"></a>plt.tight_layout(pad<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb85-7"><a href="#cb85-7" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="occupancy_nb_files/figure-html/cell-72-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="ets-results" class="level2">
<h2 class="anchored" data-anchor-id="ets-results">ETS results</h2>
<div id="8b4daaba" class="cell" data-execution_count="23">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb86"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load from file</span></span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(<span class="st">'model_params/ets_season_param.pkl'</span>, <span class="st">'rb'</span>) <span class="im">as</span> f:</span>
<span id="cb86-3"><a href="#cb86-3" aria-hidden="true" tabindex="-1"></a>    ets_season_param <span class="op">=</span> pickle.load(f)</span>
<span id="cb86-4"><a href="#cb86-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb86-5"><a href="#cb86-5" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> ets_ward_perf(ward, step_size<span class="op">=</span><span class="dv">13</span>, days_in_test<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb86-6"><a href="#cb86-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> days_in_test <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb86-7"><a href="#cb86-7" aria-hidden="true" tabindex="-1"></a>        df_ <span class="op">=</span> data_prep(ward)[:<span class="op">-</span>days_in_test]</span>
<span id="cb86-8"><a href="#cb86-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb86-9"><a href="#cb86-9" aria-hidden="true" tabindex="-1"></a>        df_ <span class="op">=</span> data_prep(ward)</span>
<span id="cb86-10"><a href="#cb86-10" aria-hidden="true" tabindex="-1"></a>    metrics <span class="op">=</span> [SRMSE, MAE, RMSE, MASE]</span>
<span id="cb86-11"><a href="#cb86-11" aria-hidden="true" tabindex="-1"></a>    perfmance_ets <span class="op">=</span> {m.<span class="va">__name__</span>: [] <span class="cf">for</span> m <span class="kw">in</span> metrics}</span>
<span id="cb86-12"><a href="#cb86-12" aria-hidden="true" tabindex="-1"></a>    tscv <span class="op">=</span> ParametricTimeSeriesSplit(n_splits<span class="op">=</span><span class="dv">30</span>, test_size<span class="op">=</span><span class="dv">30</span>, step_size<span class="op">=</span>step_size)</span>
<span id="cb86-13"><a href="#cb86-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> train_index, test_index <span class="kw">in</span> tscv.split(df_):</span>
<span id="cb86-14"><a href="#cb86-14" aria-hidden="true" tabindex="-1"></a>        train, test <span class="op">=</span> df_.iloc[train_index], df_.iloc[test_index]</span>
<span id="cb86-15"><a href="#cb86-15" aria-hidden="true" tabindex="-1"></a>        y_test <span class="op">=</span> np.array(test[ward])</span>
<span id="cb86-16"><a href="#cb86-16" aria-hidden="true" tabindex="-1"></a>        fit <span class="op">=</span> ExponentialSmoothing(train[ward],</span>
<span id="cb86-17"><a href="#cb86-17" aria-hidden="true" tabindex="-1"></a>                                   <span class="op">**</span>ets_season_param[ward][<span class="dv">0</span>]).fit(<span class="op">**</span>ets_season_param[ward][<span class="dv">1</span>])</span>
<span id="cb86-18"><a href="#cb86-18" aria-hidden="true" tabindex="-1"></a>        y_forecast <span class="op">=</span> fit.forecast(steps<span class="op">=</span><span class="dv">30</span>)</span>
<span id="cb86-19"><a href="#cb86-19" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb86-20"><a href="#cb86-20" aria-hidden="true" tabindex="-1"></a>        <span class="co">#Evaluate using the specified metric</span></span>
<span id="cb86-21"><a href="#cb86-21" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> m <span class="kw">in</span> metrics:</span>
<span id="cb86-22"><a href="#cb86-22" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> m <span class="kw">in</span> [MASE, SMAE, SRMSE, RMSSE]:</span>
<span id="cb86-23"><a href="#cb86-23" aria-hidden="true" tabindex="-1"></a>                eval_val <span class="op">=</span> m(y_test, y_forecast, np.array(train[ward]))</span>
<span id="cb86-24"><a href="#cb86-24" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb86-25"><a href="#cb86-25" aria-hidden="true" tabindex="-1"></a>                eval_val <span class="op">=</span> m(y_test, y_forecast)</span>
<span id="cb86-26"><a href="#cb86-26" aria-hidden="true" tabindex="-1"></a>            perfmance_ets[m.<span class="va">__name__</span>].append(eval_val)</span>
<span id="cb86-27"><a href="#cb86-27" aria-hidden="true" tabindex="-1"></a>    overall_performance <span class="op">=</span> [[m.<span class="va">__name__</span>, np.mean(perfmance_ets[m.<span class="va">__name__</span>])] <span class="cf">for</span> m <span class="kw">in</span> metrics]</span>
<span id="cb86-28"><a href="#cb86-28" aria-hidden="true" tabindex="-1"></a>    overall_performance <span class="op">=</span> pd.DataFrame(overall_performance).rename(columns<span class="op">=</span>{<span class="dv">0</span>: <span class="st">"eval_metric"</span>, <span class="dv">1</span>: <span class="st">"ets"</span>})</span>
<span id="cb86-29"><a href="#cb86-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> overall_performance</span>
<span id="cb86-30"><a href="#cb86-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-31"><a href="#cb86-31" aria-hidden="true" tabindex="-1"></a><span class="co"># ets_pointf_perform = {}</span></span>
<span id="cb86-32"><a href="#cb86-32" aria-hidden="true" tabindex="-1"></a><span class="co"># for w_ in ward_cols_:</span></span>
<span id="cb86-33"><a href="#cb86-33" aria-hidden="true" tabindex="-1"></a><span class="co">#     ets_pointf_perform[w_] = ets_ward_perf(w_)</span></span>
<span id="cb86-34"><a href="#cb86-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-35"><a href="#cb86-35" aria-hidden="true" tabindex="-1"></a><span class="co"># # Save to file</span></span>
<span id="cb86-36"><a href="#cb86-36" aria-hidden="true" tabindex="-1"></a><span class="co"># with open('results/ets_pointf_perform.pkl', 'wb') as f:</span></span>
<span id="cb86-37"><a href="#cb86-37" aria-hidden="true" tabindex="-1"></a><span class="co">#     pickle.dump(ets_pointf_perform, f)</span></span>
<span id="cb86-38"><a href="#cb86-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-39"><a href="#cb86-39" aria-hidden="true" tabindex="-1"></a><span class="co"># Load from file</span></span>
<span id="cb86-40"><a href="#cb86-40" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(<span class="st">'results/ets_pointf_perform.pkl'</span>, <span class="st">'rb'</span>) <span class="im">as</span> f:</span>
<span id="cb86-41"><a href="#cb86-41" aria-hidden="true" tabindex="-1"></a>    ets_pointf_perform <span class="op">=</span> pickle.load(f)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="2c5aa0f2" class="cell" data-execution_count="24">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb87"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a>ets_pointf_perform[<span class="st">"ward_0"</span>]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="24">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">eval_metric</th>
<th data-quarto-table-cell-role="th">ets</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>SRMSE</td>
<td>0.309981</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>MAE</td>
<td>3.167916</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>RMSE</td>
<td>3.679475</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">3</th>
<td>MASE</td>
<td>3.801991</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
<section id="lr-cv-results" class="level2">
<h2 class="anchored" data-anchor-id="lr-cv-results">LR CV results</h2>
<div id="fb2d27ac" class="cell" data-execution_count="25">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb88"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-2"><a href="#cb88-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Load from file</span></span>
<span id="cb88-3"><a href="#cb88-3" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(<span class="st">'model_params/best_ward_ets_tk.pkl'</span>, <span class="st">'rb'</span>) <span class="im">as</span> f:</span>
<span id="cb88-4"><a href="#cb88-4" aria-hidden="true" tabindex="-1"></a>    best_ward_ets_tk <span class="op">=</span> pickle.load(f)</span>
<span id="cb88-5"><a href="#cb88-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Load from file</span></span>
<span id="cb88-6"><a href="#cb88-6" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(<span class="st">'model_params/best_ward_ets_forecastk.pkl'</span>, <span class="st">'rb'</span>) <span class="im">as</span> f:</span>
<span id="cb88-7"><a href="#cb88-7" aria-hidden="true" tabindex="-1"></a>    best_ward_ets_forecastk <span class="op">=</span> pickle.load(f)</span>
<span id="cb88-8"><a href="#cb88-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-9"><a href="#cb88-9" aria-hidden="true" tabindex="-1"></a><span class="co"># ml_best_ward_etsforecast = {col: best_ward_ets_forecastk[col][0] for col in ward_cols_}</span></span>
<span id="cb88-10"><a href="#cb88-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-11"><a href="#cb88-11" aria-hidden="true" tabindex="-1"></a><span class="co"># # Save to file</span></span>
<span id="cb88-12"><a href="#cb88-12" aria-hidden="true" tabindex="-1"></a><span class="co"># with open('model_params/ml_best_ward_etsforecast.pkl', 'wb') as f:</span></span>
<span id="cb88-13"><a href="#cb88-13" aria-hidden="true" tabindex="-1"></a><span class="co">#     pickle.dump(ml_best_ward_etsforecast, f)</span></span>
<span id="cb88-14"><a href="#cb88-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Load from file</span></span>
<span id="cb88-15"><a href="#cb88-15" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(<span class="st">'model_params/ml_best_ward_etsforecast.pkl'</span>, <span class="st">'rb'</span>) <span class="im">as</span> f:</span>
<span id="cb88-16"><a href="#cb88-16" aria-hidden="true" tabindex="-1"></a>    ml_best_ward_etsforecast <span class="op">=</span> pickle.load(f)</span>
<span id="cb88-17"><a href="#cb88-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-18"><a href="#cb88-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-19"><a href="#cb88-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Load from file</span></span>
<span id="cb88-20"><a href="#cb88-20" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(<span class="st">'model_params/ward_best_forward_lags.pkl'</span>, <span class="st">'rb'</span>) <span class="im">as</span> f:</span>
<span id="cb88-21"><a href="#cb88-21" aria-hidden="true" tabindex="-1"></a>    ward_best_forward_lags <span class="op">=</span> pickle.load(f)</span>
<span id="cb88-22"><a href="#cb88-22" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb88-23"><a href="#cb88-23" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> lr_performance(ets_param, step_size<span class="op">=</span><span class="dv">13</span>, test_datasize<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb88-24"><a href="#cb88-24" aria-hidden="true" tabindex="-1"></a>    lr_pointf_perform <span class="op">=</span> {}</span>
<span id="cb88-25"><a href="#cb88-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> w <span class="kw">in</span> ward_cols_:</span>
<span id="cb88-26"><a href="#cb88-26" aria-hidden="true" tabindex="-1"></a>        k <span class="op">=</span> ets_param[w][<span class="dv">1</span>]</span>
<span id="cb88-27"><a href="#cb88-27" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> test_datasize <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb88-28"><a href="#cb88-28" aria-hidden="true" tabindex="-1"></a>            df_ <span class="op">=</span> data_prep_f(ward<span class="op">=</span>w, fourier_k<span class="op">=</span>k, days_in_test<span class="op">=</span>test_datasize)</span>
<span id="cb88-29"><a href="#cb88-29" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb88-30"><a href="#cb88-30" aria-hidden="true" tabindex="-1"></a>            df_ <span class="op">=</span> data_prep_f(ward<span class="op">=</span>w, fourier_k<span class="op">=</span>k)</span>
<span id="cb88-31"><a href="#cb88-31" aria-hidden="true" tabindex="-1"></a>        lr_model_ets <span class="op">=</span> ml_forecaster(LinearRegression(), lags<span class="op">=</span>ward_best_forward_lags[w], target_col<span class="op">=</span>w,</span>
<span id="cb88-32"><a href="#cb88-32" aria-hidden="true" tabindex="-1"></a>                                    cat_variables<span class="op">=</span>cat_col_f, trend<span class="op">=</span><span class="st">"ets"</span>,</span>
<span id="cb88-33"><a href="#cb88-33" aria-hidden="true" tabindex="-1"></a>                                ets_params<span class="op">=</span>ets_param[w][<span class="dv">0</span>])</span>
<span id="cb88-34"><a href="#cb88-34" aria-hidden="true" tabindex="-1"></a>        cv_m <span class="op">=</span> cross_validate(model<span class="op">=</span>lr_model_ets, df<span class="op">=</span>df_, cv_split<span class="op">=</span><span class="dv">30</span>, test_size<span class="op">=</span><span class="dv">30</span>,</span>
<span id="cb88-35"><a href="#cb88-35" aria-hidden="true" tabindex="-1"></a>                            step_size<span class="op">=</span>step_size, metrics<span class="op">=</span>[SRMSE, MAE, RMSE, MASE])</span>
<span id="cb88-36"><a href="#cb88-36" aria-hidden="true" tabindex="-1"></a>        cv_m.rename(columns<span class="op">=</span>{<span class="st">"score"</span>: <span class="st">"linearRegression"</span>}, inplace <span class="op">=</span> <span class="va">True</span>)</span>
<span id="cb88-37"><a href="#cb88-37" aria-hidden="true" tabindex="-1"></a>        lr_pointf_perform[w] <span class="op">=</span> cv_m</span>
<span id="cb88-38"><a href="#cb88-38" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> lr_pointf_perform</span>
<span id="cb88-39"><a href="#cb88-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-40"><a href="#cb88-40" aria-hidden="true" tabindex="-1"></a><span class="co"># lr_pointf_perform_ = lr_performance()</span></span>
<span id="cb88-41"><a href="#cb88-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-42"><a href="#cb88-42" aria-hidden="true" tabindex="-1"></a><span class="co"># with open('results/lr_pointf_perform_.pkl', 'wb') as f:</span></span>
<span id="cb88-43"><a href="#cb88-43" aria-hidden="true" tabindex="-1"></a><span class="co">#     pickle.dump(lr_pointf_perform_, f)</span></span>
<span id="cb88-44"><a href="#cb88-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-45"><a href="#cb88-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-46"><a href="#cb88-46" aria-hidden="true" tabindex="-1"></a><span class="co"># Load from file</span></span>
<span id="cb88-47"><a href="#cb88-47" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(<span class="st">'results/lr_pointf_perform_.pkl'</span>, <span class="st">'rb'</span>) <span class="im">as</span> f:</span>
<span id="cb88-48"><a href="#cb88-48" aria-hidden="true" tabindex="-1"></a>    lr_pointf_perform_ <span class="op">=</span> pickle.load(f)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="f315f12a" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb89"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a><span class="co"># lr_pointf_perform_t = lr_performance(best_ward_ets_tk)</span></span>
<span id="cb89-2"><a href="#cb89-2" aria-hidden="true" tabindex="-1"></a>lr_pointf_perform_ <span class="op">=</span> lr_performance(best_ward_ets_forecastk)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="932331a4" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb90"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a><span class="co"># # # Save to file</span></span>
<span id="cb90-2"><a href="#cb90-2" aria-hidden="true" tabindex="-1"></a><span class="co"># with open('results/lr_pointf_perform_.pkl', 'wb') as f:</span></span>
<span id="cb90-3"><a href="#cb90-3" aria-hidden="true" tabindex="-1"></a><span class="co">#     pickle.dump(lr_pointf_perform_, f)</span></span>
<span id="cb90-4"><a href="#cb90-4" aria-hidden="true" tabindex="-1"></a><span class="co"># # Load from file</span></span>
<span id="cb90-5"><a href="#cb90-5" aria-hidden="true" tabindex="-1"></a><span class="co"># with open('results/lr_pointf_perform_.pkl', 'rb') as f:</span></span>
<span id="cb90-6"><a href="#cb90-6" aria-hidden="true" tabindex="-1"></a><span class="co">#     lr_pointf_perform_ = pickle.load(f)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="ml-ressults" class="level2">
<h2 class="anchored" data-anchor-id="ml-ressults">ML ressults</h2>
<div id="a4f97bc9" class="cell" data-execution_count="26">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb91"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load from file</span></span>
<span id="cb91-2"><a href="#cb91-2" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(<span class="st">'model_params/ml_best_ward_ets.pkl'</span>, <span class="st">'rb'</span>) <span class="im">as</span> f:</span>
<span id="cb91-3"><a href="#cb91-3" aria-hidden="true" tabindex="-1"></a>    ml_best_ward_ets <span class="op">=</span> pickle.load(f)</span>
<span id="cb91-4"><a href="#cb91-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-5"><a href="#cb91-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Load from file</span></span>
<span id="cb91-6"><a href="#cb91-6" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(<span class="st">'model_params/_best_xgb_params.pkl'</span>, <span class="st">'rb'</span>) <span class="im">as</span> f:</span>
<span id="cb91-7"><a href="#cb91-7" aria-hidden="true" tabindex="-1"></a>    _best_xgb_params <span class="op">=</span> pickle.load(f)</span>
<span id="cb91-8"><a href="#cb91-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Load from file</span></span>
<span id="cb91-9"><a href="#cb91-9" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(<span class="st">'model_params/_best_lgb_params.pkl'</span>, <span class="st">'rb'</span>) <span class="im">as</span> f:</span>
<span id="cb91-10"><a href="#cb91-10" aria-hidden="true" tabindex="-1"></a>    _best_lgb_params <span class="op">=</span> pickle.load(f)</span>
<span id="cb91-11"><a href="#cb91-11" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(<span class="st">'model_params/_best_rf_params.pkl'</span>, <span class="st">'rb'</span>) <span class="im">as</span> f:</span>
<span id="cb91-12"><a href="#cb91-12" aria-hidden="true" tabindex="-1"></a>    _best_rf_params <span class="op">=</span> pickle.load(f)</span>
<span id="cb91-13"><a href="#cb91-13" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(<span class="st">'model_params/_best_lasso_params.pkl'</span>, <span class="st">'rb'</span>) <span class="im">as</span> f:</span>
<span id="cb91-14"><a href="#cb91-14" aria-hidden="true" tabindex="-1"></a>    _best_lasso_params <span class="op">=</span> pickle.load(f)</span>
<span id="cb91-15"><a href="#cb91-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-16"><a href="#cb91-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-17"><a href="#cb91-17" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> ml_performance(ets_param, step_size<span class="op">=</span><span class="dv">13</span>, test_datasize<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb91-18"><a href="#cb91-18" aria-hidden="true" tabindex="-1"></a>    ml_pointf_perform <span class="op">=</span> {}</span>
<span id="cb91-19"><a href="#cb91-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-20"><a href="#cb91-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> w <span class="kw">in</span> ward_cols_:</span>
<span id="cb91-21"><a href="#cb91-21" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> test_datasize <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb91-22"><a href="#cb91-22" aria-hidden="true" tabindex="-1"></a>            df_ <span class="op">=</span> data_prep(ward<span class="op">=</span>w, days_in_test<span class="op">=</span>test_datasize)</span>
<span id="cb91-23"><a href="#cb91-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb91-24"><a href="#cb91-24" aria-hidden="true" tabindex="-1"></a>            df_ <span class="op">=</span> data_prep(w)</span>
<span id="cb91-25"><a href="#cb91-25" aria-hidden="true" tabindex="-1"></a>        model_param_ <span class="op">=</span> _best_xgb_params[w][<span class="dv">0</span>]</span>
<span id="cb91-26"><a href="#cb91-26" aria-hidden="true" tabindex="-1"></a>        model_lags_ <span class="op">=</span> _best_xgb_params[w][<span class="dv">1</span>]</span>
<span id="cb91-27"><a href="#cb91-27" aria-hidden="true" tabindex="-1"></a>        xgb_model_ets <span class="op">=</span> ml_forecaster(XGBRegressor(<span class="op">**</span>model_param_), lags<span class="op">=</span>model_lags_, target_col<span class="op">=</span>w,</span>
<span id="cb91-28"><a href="#cb91-28" aria-hidden="true" tabindex="-1"></a>                                    cat_variables<span class="op">=</span>cat_cols, trend<span class="op">=</span><span class="st">"ets"</span>,</span>
<span id="cb91-29"><a href="#cb91-29" aria-hidden="true" tabindex="-1"></a>                                    ets_params<span class="op">=</span>ets_param[w])</span>
<span id="cb91-30"><a href="#cb91-30" aria-hidden="true" tabindex="-1"></a>        cv_m <span class="op">=</span> cross_validate(model<span class="op">=</span>xgb_model_ets, df<span class="op">=</span>df_, cv_split<span class="op">=</span><span class="dv">30</span>, test_size<span class="op">=</span><span class="dv">30</span>,</span>
<span id="cb91-31"><a href="#cb91-31" aria-hidden="true" tabindex="-1"></a>                            step_size<span class="op">=</span>step_size, metrics<span class="op">=</span>[SRMSE, MAE, RMSE, MASE])</span>
<span id="cb91-32"><a href="#cb91-32" aria-hidden="true" tabindex="-1"></a>        cv_m.rename(columns<span class="op">=</span>{<span class="st">"score"</span>: <span class="st">"XGBoost"</span>}, inplace <span class="op">=</span> <span class="va">True</span>)</span>
<span id="cb91-33"><a href="#cb91-33" aria-hidden="true" tabindex="-1"></a>        ml_pointf_perform[w] <span class="op">=</span> cv_m</span>
<span id="cb91-34"><a href="#cb91-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-35"><a href="#cb91-35" aria-hidden="true" tabindex="-1"></a>        model_param_ <span class="op">=</span> _best_lgb_params[w][<span class="dv">0</span>]</span>
<span id="cb91-36"><a href="#cb91-36" aria-hidden="true" tabindex="-1"></a>        model_lags_ <span class="op">=</span> _best_lgb_params[w][<span class="dv">1</span>]</span>
<span id="cb91-37"><a href="#cb91-37" aria-hidden="true" tabindex="-1"></a>        lgb_model_ets <span class="op">=</span> ml_forecaster(LGBMRegressor(<span class="op">**</span>model_param_, verbose<span class="op">=-</span><span class="dv">1</span>), lags<span class="op">=</span>model_lags_, target_col<span class="op">=</span>w,</span>
<span id="cb91-38"><a href="#cb91-38" aria-hidden="true" tabindex="-1"></a>                                    cat_variables<span class="op">=</span>cat_cols, trend<span class="op">=</span><span class="st">"ets"</span>,</span>
<span id="cb91-39"><a href="#cb91-39" aria-hidden="true" tabindex="-1"></a>                                ets_params<span class="op">=</span>ets_param[w])</span>
<span id="cb91-40"><a href="#cb91-40" aria-hidden="true" tabindex="-1"></a>        cv_m <span class="op">=</span> cross_validate(model<span class="op">=</span>lgb_model_ets, df<span class="op">=</span>df_, cv_split<span class="op">=</span><span class="dv">30</span>, test_size<span class="op">=</span><span class="dv">30</span>,</span>
<span id="cb91-41"><a href="#cb91-41" aria-hidden="true" tabindex="-1"></a>                            step_size<span class="op">=</span>step_size, metrics<span class="op">=</span>[SRMSE, MAE, RMSE, MASE])</span>
<span id="cb91-42"><a href="#cb91-42" aria-hidden="true" tabindex="-1"></a>        cv_m.rename(columns<span class="op">=</span>{<span class="st">"score"</span>: <span class="st">"LightGBM"</span>}, inplace <span class="op">=</span> <span class="va">True</span>)</span>
<span id="cb91-43"><a href="#cb91-43" aria-hidden="true" tabindex="-1"></a>        ml_pointf_perform[w] <span class="op">=</span> ml_pointf_perform[w].merge(cv_m, left_on<span class="op">=</span><span class="st">"eval_metric"</span>, right_on<span class="op">=</span><span class="st">"eval_metric"</span>)</span>
<span id="cb91-44"><a href="#cb91-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-45"><a href="#cb91-45" aria-hidden="true" tabindex="-1"></a>        model_param_ <span class="op">=</span> _best_rf_params[w][<span class="dv">0</span>]</span>
<span id="cb91-46"><a href="#cb91-46" aria-hidden="true" tabindex="-1"></a>        model_lags_ <span class="op">=</span> _best_rf_params[w][<span class="dv">1</span>]</span>
<span id="cb91-47"><a href="#cb91-47" aria-hidden="true" tabindex="-1"></a>        rf_model_ets <span class="op">=</span> ml_forecaster(RandomForestRegressor(<span class="op">**</span>model_param_), lags<span class="op">=</span>model_lags_, target_col<span class="op">=</span>w,</span>
<span id="cb91-48"><a href="#cb91-48" aria-hidden="true" tabindex="-1"></a>                                    cat_variables<span class="op">=</span>cat_cols, trend<span class="op">=</span><span class="st">"ets"</span>,</span>
<span id="cb91-49"><a href="#cb91-49" aria-hidden="true" tabindex="-1"></a>                                ets_params<span class="op">=</span>ets_param[w])</span>
<span id="cb91-50"><a href="#cb91-50" aria-hidden="true" tabindex="-1"></a>        cv_m <span class="op">=</span> cross_validate(model<span class="op">=</span>rf_model_ets, df<span class="op">=</span>df_, cv_split<span class="op">=</span><span class="dv">30</span>, test_size<span class="op">=</span><span class="dv">30</span>,</span>
<span id="cb91-51"><a href="#cb91-51" aria-hidden="true" tabindex="-1"></a>                            step_size<span class="op">=</span>step_size, metrics<span class="op">=</span>[SRMSE, MAE, RMSE, MASE])</span>
<span id="cb91-52"><a href="#cb91-52" aria-hidden="true" tabindex="-1"></a>        cv_m.rename(columns<span class="op">=</span>{<span class="st">"score"</span>: <span class="st">"RandomForest"</span>}, inplace <span class="op">=</span> <span class="va">True</span>)</span>
<span id="cb91-53"><a href="#cb91-53" aria-hidden="true" tabindex="-1"></a>        ml_pointf_perform[w] <span class="op">=</span> ml_pointf_perform[w].merge(cv_m, left_on<span class="op">=</span><span class="st">"eval_metric"</span>, right_on<span class="op">=</span><span class="st">"eval_metric"</span>)</span>
<span id="cb91-54"><a href="#cb91-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-55"><a href="#cb91-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-56"><a href="#cb91-56" aria-hidden="true" tabindex="-1"></a>        model_param_ <span class="op">=</span> _best_lasso_params[w][<span class="dv">0</span>]</span>
<span id="cb91-57"><a href="#cb91-57" aria-hidden="true" tabindex="-1"></a>        model_lags_ <span class="op">=</span> _best_lasso_params[w][<span class="dv">1</span>]</span>
<span id="cb91-58"><a href="#cb91-58" aria-hidden="true" tabindex="-1"></a>        lasso_model_ets <span class="op">=</span> ml_forecaster(Lasso(<span class="op">**</span>model_param_), lags<span class="op">=</span>model_lags_, target_col<span class="op">=</span>w,</span>
<span id="cb91-59"><a href="#cb91-59" aria-hidden="true" tabindex="-1"></a>                                    cat_variables<span class="op">=</span>cat_cols, trend<span class="op">=</span><span class="st">"ets"</span>,</span>
<span id="cb91-60"><a href="#cb91-60" aria-hidden="true" tabindex="-1"></a>                                ets_params<span class="op">=</span>ets_param[w])</span>
<span id="cb91-61"><a href="#cb91-61" aria-hidden="true" tabindex="-1"></a>        cv_m <span class="op">=</span> cross_validate(model<span class="op">=</span>lasso_model_ets, df<span class="op">=</span>df_, cv_split<span class="op">=</span><span class="dv">30</span>, test_size<span class="op">=</span><span class="dv">30</span>,</span>
<span id="cb91-62"><a href="#cb91-62" aria-hidden="true" tabindex="-1"></a>                            step_size<span class="op">=</span>step_size, metrics<span class="op">=</span>[SRMSE, MAE, RMSE, MASE])</span>
<span id="cb91-63"><a href="#cb91-63" aria-hidden="true" tabindex="-1"></a>        cv_m.rename(columns<span class="op">=</span>{<span class="st">"score"</span>: <span class="st">"Lasso"</span>}, inplace <span class="op">=</span> <span class="va">True</span>)</span>
<span id="cb91-64"><a href="#cb91-64" aria-hidden="true" tabindex="-1"></a>        ml_pointf_perform[w] <span class="op">=</span> ml_pointf_perform[w].merge(cv_m, left_on<span class="op">=</span><span class="st">"eval_metric"</span>, right_on<span class="op">=</span><span class="st">"eval_metric"</span>)</span>
<span id="cb91-65"><a href="#cb91-65" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Completed ML CV for </span><span class="sc">{</span>w<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb91-66"><a href="#cb91-66" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> ml_pointf_perform</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="06f272a8" class="cell" data-execution_count="281">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb92"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a>ml_pointf_perform_ <span class="op">=</span> ml_performance(ml_best_ward_etsforecast)</span>
<span id="cb92-2"><a href="#cb92-2" aria-hidden="true" tabindex="-1"></a><span class="co"># print("forecast_ets done")</span></span>
<span id="cb92-3"><a href="#cb92-3" aria-hidden="true" tabindex="-1"></a><span class="co"># ml_pointf_perform_f = ml_performance(ml_best_ward_ets)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Completed ML CV for ward_0
Completed ML CV for ward_1
Completed ML CV for ward_2
Completed ML CV for ward_3
Completed ML CV for ward_4
Completed ML CV for ward_5
Completed ML CV for ward_6</code></pre>
</div>
</div>
<div id="ac337f59" class="cell" data-execution_count="27">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb94"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a><span class="co"># with open('results/ml_pointf_perform_.pkl', 'wb') as f:</span></span>
<span id="cb94-2"><a href="#cb94-2" aria-hidden="true" tabindex="-1"></a><span class="co">#     pickle.dump(ml_pointf_perform_, f)</span></span>
<span id="cb94-3"><a href="#cb94-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-4"><a href="#cb94-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Load from file</span></span>
<span id="cb94-5"><a href="#cb94-5" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(<span class="st">'results/ml_pointf_perform_.pkl'</span>, <span class="st">'rb'</span>) <span class="im">as</span> f:</span>
<span id="cb94-6"><a href="#cb94-6" aria-hidden="true" tabindex="-1"></a>    ml_pointf_perform_ <span class="op">=</span> pickle.load(f)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="hmm-results" class="level2">
<h2 class="anchored" data-anchor-id="hmm-results">HMM results</h2>
<div id="36ce8a07" class="cell" data-execution_count="27">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb95"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load from file</span></span>
<span id="cb95-2"><a href="#cb95-2" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(<span class="st">'model_params/hmm_best_forward_lags.pkl'</span>, <span class="st">'rb'</span>) <span class="im">as</span> f:</span>
<span id="cb95-3"><a href="#cb95-3" aria-hidden="true" tabindex="-1"></a>    hmm_best_forward_lags <span class="op">=</span> pickle.load(f)</span>
<span id="cb95-4"><a href="#cb95-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-5"><a href="#cb95-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Load from file</span></span>
<span id="cb95-6"><a href="#cb95-6" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(<span class="st">'model_params/best_ward_ets_tk.pkl'</span>, <span class="st">'rb'</span>) <span class="im">as</span> f:</span>
<span id="cb95-7"><a href="#cb95-7" aria-hidden="true" tabindex="-1"></a>    best_ward_ets_tk <span class="op">=</span> pickle.load(f)</span>
<span id="cb95-8"><a href="#cb95-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Load from file</span></span>
<span id="cb95-9"><a href="#cb95-9" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(<span class="st">'model_params/best_ward_ets_forecastk.pkl'</span>, <span class="st">'rb'</span>) <span class="im">as</span> f:</span>
<span id="cb95-10"><a href="#cb95-10" aria-hidden="true" tabindex="-1"></a>    best_ward_ets_forecastk <span class="op">=</span> pickle.load(f)</span>
<span id="cb95-11"><a href="#cb95-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-12"><a href="#cb95-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Load from file</span></span>
<span id="cb95-13"><a href="#cb95-13" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(<span class="st">'model_params/best_hmm_ets_tks.pkl'</span>, <span class="st">'rb'</span>) <span class="im">as</span> f:</span>
<span id="cb95-14"><a href="#cb95-14" aria-hidden="true" tabindex="-1"></a>    best_hmm_ets_tks <span class="op">=</span> pickle.load(f)</span>
<span id="cb95-15"><a href="#cb95-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-16"><a href="#cb95-16" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> hmm_performance(ets_param, test_datasize<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb95-17"><a href="#cb95-17" aria-hidden="true" tabindex="-1"></a>    hmm_pointf_perform <span class="op">=</span> {}</span>
<span id="cb95-18"><a href="#cb95-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> w <span class="kw">in</span> ward_cols_:</span>
<span id="cb95-19"><a href="#cb95-19" aria-hidden="true" tabindex="-1"></a>        k <span class="op">=</span> ets_param[w][<span class="dv">1</span>]</span>
<span id="cb95-20"><a href="#cb95-20" aria-hidden="true" tabindex="-1"></a>        ets_paramshmm <span class="op">=</span> ets_param[w][<span class="dv">0</span>]</span>
<span id="cb95-21"><a href="#cb95-21" aria-hidden="true" tabindex="-1"></a>        hmm_lags <span class="op">=</span> <span class="bu">sorted</span>(hmm_best_forward_lags[w][<span class="dv">0</span>][<span class="st">"best_lags"</span>])</span>
<span id="cb95-22"><a href="#cb95-22" aria-hidden="true" tabindex="-1"></a>        s <span class="op">=</span> best_hmm_ets_tks[w][<span class="dv">2</span>]</span>
<span id="cb95-23"><a href="#cb95-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-24"><a href="#cb95-24" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> test_datasize <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb95-25"><a href="#cb95-25" aria-hidden="true" tabindex="-1"></a>            df_ <span class="op">=</span> data_prep_f(ward<span class="op">=</span>w, fourier_k<span class="op">=</span>k, days_in_test<span class="op">=</span>test_datasize)</span>
<span id="cb95-26"><a href="#cb95-26" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb95-27"><a href="#cb95-27" aria-hidden="true" tabindex="-1"></a>            df_ <span class="op">=</span> data_prep_f(ward<span class="op">=</span>w, fourier_k<span class="op">=</span>k)</span>
<span id="cb95-28"><a href="#cb95-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-29"><a href="#cb95-29" aria-hidden="true" tabindex="-1"></a>        hm_model <span class="op">=</span> MsHmmRegression(n_components<span class="op">=</span>s, target_col<span class="op">=</span>w, cat_variables<span class="op">=</span>cat_col_f, lags<span class="op">=</span>hmm_lags,</span>
<span id="cb95-30"><a href="#cb95-30" aria-hidden="true" tabindex="-1"></a>                            trend<span class="op">=</span><span class="st">"ets"</span>, ets_params<span class="op">=</span>ets_paramshmm, random_state<span class="op">=</span><span class="dv">42</span>, n_iter<span class="op">=</span><span class="dv">300</span>, tol<span class="op">=</span><span class="fl">1e-3</span>)</span>
<span id="cb95-31"><a href="#cb95-31" aria-hidden="true" tabindex="-1"></a>        fit_df <span class="op">=</span> df_[:<span class="op">-</span><span class="dv">360</span>] <span class="co"># fit on train data only to avoid data leakage</span></span>
<span id="cb95-32"><a href="#cb95-32" aria-hidden="true" tabindex="-1"></a>        hm_model.fit_em(fit_df)</span>
<span id="cb95-33"><a href="#cb95-33" aria-hidden="true" tabindex="-1"></a>        cv_ <span class="op">=</span> hmm_cross_validate(model<span class="op">=</span>hm_model, df<span class="op">=</span>df_, cv_split<span class="op">=</span><span class="dv">30</span>, test_size<span class="op">=</span><span class="dv">30</span>, step_size<span class="op">=</span><span class="dv">13</span>, n_iter<span class="op">=</span><span class="dv">100</span>, metrics<span class="op">=</span>[SRMSE, MAE, RMSE, MASE])</span>
<span id="cb95-34"><a href="#cb95-34" aria-hidden="true" tabindex="-1"></a>        cv_.rename(columns<span class="op">=</span>{<span class="st">"score"</span>: <span class="st">"HMM"</span>}, inplace <span class="op">=</span> <span class="va">True</span>)</span>
<span id="cb95-35"><a href="#cb95-35" aria-hidden="true" tabindex="-1"></a>        hmm_pointf_perform[w] <span class="op">=</span> cv_</span>
<span id="cb95-36"><a href="#cb95-36" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Completed HMM CV for </span><span class="sc">{</span>w<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb95-37"><a href="#cb95-37" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> hmm_pointf_perform</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="6e6cf0c0" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb96"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a>hmm_performance_ <span class="op">=</span> hmm_performance(best_ward_ets_forecastk)</span>
<span id="cb96-2"><a href="#cb96-2" aria-hidden="true" tabindex="-1"></a>hmm_performance_past <span class="op">=</span> hmm_performance(best_hmm_ets_tks)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="all-results" class="level2">
<h2 class="anchored" data-anchor-id="all-results">all results</h2>
<div id="ad68d608" class="cell" data-execution_count="28">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb97"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load from file</span></span>
<span id="cb97-2"><a href="#cb97-2" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(<span class="st">'results/all_model_points.pkl'</span>, <span class="st">'rb'</span>) <span class="im">as</span> f:</span>
<span id="cb97-3"><a href="#cb97-3" aria-hidden="true" tabindex="-1"></a>    all_model_points <span class="op">=</span> pickle.load(f)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="4af3fd46" class="cell" data-execution_count="90">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb98"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> copy</span>
<span id="cb98-2"><a href="#cb98-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> statsmodels.api <span class="im">as</span> sm</span>
<span id="cb98-3"><a href="#cb98-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy.stats <span class="im">import</span> norm, multivariate_normal</span>
<span id="cb98-4"><a href="#cb98-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.linear_model <span class="im">import</span> LinearRegression</span>
<span id="cb98-5"><a href="#cb98-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> statsmodels.tsa.holtwinters <span class="im">import</span> ExponentialSmoothing</span>
<span id="cb98-6"><a href="#cb98-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy.special <span class="im">import</span> logsumexp</span>
<span id="cb98-7"><a href="#cb98-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-8"><a href="#cb98-8" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> MsHmmRegression:</span>
<span id="cb98-9"><a href="#cb98-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb98-10"><a href="#cb98-10" aria-hidden="true" tabindex="-1"></a><span class="co">    Hidden Markov Model Regression for time series with EM parameter estimation.</span></span>
<span id="cb98-11"><a href="#cb98-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-12"><a href="#cb98-12" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb98-13"><a href="#cb98-13" aria-hidden="true" tabindex="-1"></a><span class="co">        n_components (int): Number of hidden states.</span></span>
<span id="cb98-14"><a href="#cb98-14" aria-hidden="true" tabindex="-1"></a><span class="co">        target_col (str): Name of the target variable.</span></span>
<span id="cb98-15"><a href="#cb98-15" aria-hidden="true" tabindex="-1"></a><span class="co">        lag_list (list): List of integer lags to include as features.</span></span>
<span id="cb98-16"><a href="#cb98-16" aria-hidden="true" tabindex="-1"></a><span class="co">        method (str): 'posterior' for soft state assignment, 'viterbi' for hard paths.</span></span>
<span id="cb98-17"><a href="#cb98-17" aria-hidden="true" tabindex="-1"></a><span class="co">        startprob_prior (float): Prior for initial state probabilities.</span></span>
<span id="cb98-18"><a href="#cb98-18" aria-hidden="true" tabindex="-1"></a><span class="co">        transmat_prior (float): Prior for transition matrix.</span></span>
<span id="cb98-19"><a href="#cb98-19" aria-hidden="true" tabindex="-1"></a><span class="co">        ets_params (tuple, optional): A tuple (model_params, fit_params) for exponential smoothing. Ex.g. ({'trend': 'add', 'seasonal': 'add'}, {'damped_trend': True}). If trend is "ets", this will be used.</span></span>
<span id="cb98-20"><a href="#cb98-20" aria-hidden="true" tabindex="-1"></a><span class="co">        change_points (list or None): List of change points for piecewise linear regression to handle trend</span></span>
<span id="cb98-21"><a href="#cb98-21" aria-hidden="true" tabindex="-1"></a><span class="co">        add_constant (bool): Whether to add constant to regressors.</span></span>
<span id="cb98-22"><a href="#cb98-22" aria-hidden="true" tabindex="-1"></a><span class="co">        difference (int or None): Order of differencing to apply to target.</span></span>
<span id="cb98-23"><a href="#cb98-23" aria-hidden="true" tabindex="-1"></a><span class="co">        trend (str or None): Type of trend to remove ('linear', 'ets', etc.). Default is None.</span></span>
<span id="cb98-24"><a href="#cb98-24" aria-hidden="true" tabindex="-1"></a><span class="co">        cat_variables (list or None): List of categorical columns.</span></span>
<span id="cb98-25"><a href="#cb98-25" aria-hidden="true" tabindex="-1"></a><span class="co">        n_iter (int): Maximum number of EM iterations.</span></span>
<span id="cb98-26"><a href="#cb98-26" aria-hidden="true" tabindex="-1"></a><span class="co">        tol (float): Convergence tolerance for EM.</span></span>
<span id="cb98-27"><a href="#cb98-27" aria-hidden="true" tabindex="-1"></a><span class="co">        coefficients (np.ndarray or None): Initial regression coefficients.</span></span>
<span id="cb98-28"><a href="#cb98-28" aria-hidden="true" tabindex="-1"></a><span class="co">        stds (np.ndarray or None): Initial state std deviations.</span></span>
<span id="cb98-29"><a href="#cb98-29" aria-hidden="true" tabindex="-1"></a><span class="co">        init_state (np.ndarray or None): Initial state distribution.</span></span>
<span id="cb98-30"><a href="#cb98-30" aria-hidden="true" tabindex="-1"></a><span class="co">        trans_matrix (np.ndarray or None): Initial transition matrix.</span></span>
<span id="cb98-31"><a href="#cb98-31" aria-hidden="true" tabindex="-1"></a><span class="co">        random_state (int or None): Random seed.</span></span>
<span id="cb98-32"><a href="#cb98-32" aria-hidden="true" tabindex="-1"></a><span class="co">        verbose (bool): Print progress if True.</span></span>
<span id="cb98-33"><a href="#cb98-33" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb98-34"><a href="#cb98-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-35"><a href="#cb98-35" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, n_components, target_col, lags, method<span class="op">=</span><span class="st">"posterior"</span>,</span>
<span id="cb98-36"><a href="#cb98-36" aria-hidden="true" tabindex="-1"></a>                 startprob_prior<span class="op">=</span><span class="fl">1e3</span>, transmat_prior<span class="op">=</span><span class="fl">1e5</span>, add_constant<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb98-37"><a href="#cb98-37" aria-hidden="true" tabindex="-1"></a>                 difference<span class="op">=</span><span class="va">None</span>, trend<span class="op">=</span><span class="va">None</span>, ets_params <span class="op">=</span> <span class="va">None</span>, change_points<span class="op">=</span><span class="va">None</span>,</span>
<span id="cb98-38"><a href="#cb98-38" aria-hidden="true" tabindex="-1"></a>                 cat_variables<span class="op">=</span><span class="va">None</span>, lag_transform<span class="op">=</span><span class="va">None</span>, n_iter<span class="op">=</span><span class="dv">100</span>, tol<span class="op">=</span><span class="fl">1e-6</span>,</span>
<span id="cb98-39"><a href="#cb98-39" aria-hidden="true" tabindex="-1"></a>                 coefficients<span class="op">=</span><span class="va">None</span>, stds<span class="op">=</span><span class="va">None</span>, init_state<span class="op">=</span><span class="va">None</span>, trans_matrix<span class="op">=</span><span class="va">None</span>,</span>
<span id="cb98-40"><a href="#cb98-40" aria-hidden="true" tabindex="-1"></a>                 box_cox<span class="op">=</span><span class="va">False</span>, lamda<span class="op">=</span><span class="va">None</span>, box_cox_biasadj<span class="op">=</span><span class="va">False</span>, season_diff<span class="op">=</span><span class="va">None</span>,</span>
<span id="cb98-41"><a href="#cb98-41" aria-hidden="true" tabindex="-1"></a>                 ridge<span class="op">=</span><span class="fl">1e-5</span>, var_floor<span class="op">=</span><span class="fl">1e-5</span>, </span>
<span id="cb98-42"><a href="#cb98-42" aria-hidden="true" tabindex="-1"></a>                 random_state<span class="op">=</span><span class="va">None</span>, verbose<span class="op">=</span><span class="va">False</span>):</span>
<span id="cb98-43"><a href="#cb98-43" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.N <span class="op">=</span> n_components</span>
<span id="cb98-44"><a href="#cb98-44" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.target_col <span class="op">=</span> target_col</span>
<span id="cb98-45"><a href="#cb98-45" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.diff <span class="op">=</span> difference</span>
<span id="cb98-46"><a href="#cb98-46" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.cons <span class="op">=</span> add_constant</span>
<span id="cb98-47"><a href="#cb98-47" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.cat_variables <span class="op">=</span> cat_variables</span>
<span id="cb98-48"><a href="#cb98-48" aria-hidden="true" tabindex="-1"></a>        <span class="co"># lags must be a list of integers or an integer</span></span>
<span id="cb98-49"><a href="#cb98-49" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> <span class="bu">isinstance</span>(lags, (<span class="bu">int</span>, <span class="bu">list</span>)):</span>
<span id="cb98-50"><a href="#cb98-50" aria-hidden="true" tabindex="-1"></a>            <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="st">"Lags must be an integer or a list of integers."</span>)</span>
<span id="cb98-51"><a href="#cb98-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-52"><a href="#cb98-52" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.lags <span class="op">=</span> [i <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, lags <span class="op">+</span> <span class="dv">1</span>)] <span class="cf">if</span> <span class="bu">isinstance</span>(lags, <span class="bu">int</span>) <span class="cf">else</span> lags</span>
<span id="cb98-53"><a href="#cb98-53" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.method <span class="op">=</span> method</span>
<span id="cb98-54"><a href="#cb98-54" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.box_cox <span class="op">=</span> box_cox</span>
<span id="cb98-55"><a href="#cb98-55" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.lamda <span class="op">=</span> lamda</span>
<span id="cb98-56"><a href="#cb98-56" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.biasadj <span class="op">=</span> box_cox_biasadj</span>
<span id="cb98-57"><a href="#cb98-57" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.trend <span class="op">=</span> trend</span>
<span id="cb98-58"><a href="#cb98-58" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> ets_params <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb98-59"><a href="#cb98-59" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.ets_model <span class="op">=</span> ets_params[<span class="dv">0</span>]</span>
<span id="cb98-60"><a href="#cb98-60" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.ets_fit <span class="op">=</span> ets_params[<span class="dv">1</span>]</span>
<span id="cb98-61"><a href="#cb98-61" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb98-62"><a href="#cb98-62" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.ets_model <span class="op">=</span> <span class="va">None</span></span>
<span id="cb98-63"><a href="#cb98-63" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.ets_fit <span class="op">=</span> <span class="va">None</span></span>
<span id="cb98-64"><a href="#cb98-64" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb98-65"><a href="#cb98-65" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.cps <span class="op">=</span> change_points</span>
<span id="cb98-66"><a href="#cb98-66" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.season_diff <span class="op">=</span> season_diff</span>
<span id="cb98-67"><a href="#cb98-67" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.lag_transform <span class="op">=</span> lag_transform</span>
<span id="cb98-68"><a href="#cb98-68" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.<span class="bu">iter</span> <span class="op">=</span> n_iter</span>
<span id="cb98-69"><a href="#cb98-69" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.tol <span class="op">=</span> tol</span>
<span id="cb98-70"><a href="#cb98-70" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.ridge <span class="op">=</span> ridge</span>
<span id="cb98-71"><a href="#cb98-71" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.var_floor <span class="op">=</span> var_floor</span>
<span id="cb98-72"><a href="#cb98-72" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.verb <span class="op">=</span> verbose</span>
<span id="cb98-73"><a href="#cb98-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-74"><a href="#cb98-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-75"><a href="#cb98-75" aria-hidden="true" tabindex="-1"></a>        <span class="co"># RNG for reproducibility</span></span>
<span id="cb98-76"><a href="#cb98-76" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.rng <span class="op">=</span> np.random.default_rng(random_state)</span>
<span id="cb98-77"><a href="#cb98-77" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> init_state <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb98-78"><a href="#cb98-78" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.sp <span class="op">=</span> startprob_prior</span>
<span id="cb98-79"><a href="#cb98-79" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.alpha_p <span class="op">=</span> np.repeat(<span class="va">self</span>.sp, <span class="va">self</span>.N)</span>
<span id="cb98-80"><a href="#cb98-80" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.pi <span class="op">=</span> <span class="va">self</span>.rng.dirichlet(<span class="va">self</span>.alpha_p) <span class="co"># Initial state probabilities using Dirichlet distribution</span></span>
<span id="cb98-81"><a href="#cb98-81" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb98-82"><a href="#cb98-82" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.pi <span class="op">=</span> np.array(init_state)</span>
<span id="cb98-83"><a href="#cb98-83" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> trans_matrix <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb98-84"><a href="#cb98-84" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.tm <span class="op">=</span> transmat_prior</span>
<span id="cb98-85"><a href="#cb98-85" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.alpha_t <span class="op">=</span> np.repeat(<span class="va">self</span>.tm, <span class="va">self</span>.N) <span class="co"># </span></span>
<span id="cb98-86"><a href="#cb98-86" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.A <span class="op">=</span> <span class="va">self</span>.rng.dirichlet(<span class="va">self</span>.alpha_t, size<span class="op">=</span><span class="va">self</span>.N)</span>
<span id="cb98-87"><a href="#cb98-87" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb98-88"><a href="#cb98-88" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.A <span class="op">=</span> np.array(trans_matrix)</span>
<span id="cb98-89"><a href="#cb98-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-90"><a href="#cb98-90" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.coeffs <span class="op">=</span> coefficients</span>
<span id="cb98-91"><a href="#cb98-91" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.stds <span class="op">=</span> stds</span>
<span id="cb98-92"><a href="#cb98-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-93"><a href="#cb98-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-94"><a href="#cb98-94" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> data_prep(<span class="va">self</span>, df):</span>
<span id="cb98-95"><a href="#cb98-95" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""</span></span>
<span id="cb98-96"><a href="#cb98-96" aria-hidden="true" tabindex="-1"></a><span class="co">        Prepare the data: encode categoricals, add lags, trend, differencing.</span></span>
<span id="cb98-97"><a href="#cb98-97" aria-hidden="true" tabindex="-1"></a><span class="co">        """</span></span>
<span id="cb98-98"><a href="#cb98-98" aria-hidden="true" tabindex="-1"></a>        dfc <span class="op">=</span> df.copy()</span>
<span id="cb98-99"><a href="#cb98-99" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Categorical variable encoding</span></span>
<span id="cb98-100"><a href="#cb98-100" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="va">self</span>.cat_variables <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb98-101"><a href="#cb98-101" aria-hidden="true" tabindex="-1"></a>            <span class="co"># if self.target_encode ==True:</span></span>
<span id="cb98-102"><a href="#cb98-102" aria-hidden="true" tabindex="-1"></a>            <span class="co">#     for col in self.cat_variables:</span></span>
<span id="cb98-103"><a href="#cb98-103" aria-hidden="true" tabindex="-1"></a>            <span class="co">#         encode_col = col+"_target_encoded"</span></span>
<span id="cb98-104"><a href="#cb98-104" aria-hidden="true" tabindex="-1"></a>            <span class="co">#         dfc[encode_col] = kfold_target_encoder(dfc, col, self.target_col, 36)</span></span>
<span id="cb98-105"><a href="#cb98-105" aria-hidden="true" tabindex="-1"></a>            <span class="co">#     self.df_encode = dfc.copy()</span></span>
<span id="cb98-106"><a href="#cb98-106" aria-hidden="true" tabindex="-1"></a>            <span class="co">#     dfc = dfc.drop(columns = self.cat_variables)</span></span>
<span id="cb98-107"><a href="#cb98-107" aria-hidden="true" tabindex="-1"></a>            <span class="co">#     # If target encoding is not used, convert categories to dummies    </span></span>
<span id="cb98-108"><a href="#cb98-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-109"><a href="#cb98-109" aria-hidden="true" tabindex="-1"></a>            <span class="co"># else:</span></span>
<span id="cb98-110"><a href="#cb98-110" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> col, cat <span class="kw">in</span> <span class="va">self</span>.cat_var.items():</span>
<span id="cb98-111"><a href="#cb98-111" aria-hidden="true" tabindex="-1"></a>                dfc[col] <span class="op">=</span> dfc[col].astype(<span class="st">'category'</span>)</span>
<span id="cb98-112"><a href="#cb98-112" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Set categories for categorical columns</span></span>
<span id="cb98-113"><a href="#cb98-113" aria-hidden="true" tabindex="-1"></a>                dfc[col] <span class="op">=</span> dfc[col].cat.set_categories(cat)</span>
<span id="cb98-114"><a href="#cb98-114" aria-hidden="true" tabindex="-1"></a>            dfc <span class="op">=</span> pd.get_dummies(dfc, dtype<span class="op">=</span>np.float64)</span>
<span id="cb98-115"><a href="#cb98-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-116"><a href="#cb98-116" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> i <span class="kw">in</span> <span class="va">self</span>.drop_categ:</span>
<span id="cb98-117"><a href="#cb98-117" aria-hidden="true" tabindex="-1"></a>                dfc.drop(<span class="bu">list</span>(dfc.<span class="bu">filter</span>(regex<span class="op">=</span>i)), axis<span class="op">=</span><span class="dv">1</span>, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb98-118"><a href="#cb98-118" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb98-119"><a href="#cb98-119" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="va">self</span>.target_col <span class="kw">in</span> dfc.columns:</span>
<span id="cb98-120"><a href="#cb98-120" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Apply Box–Cox transformation if specified</span></span>
<span id="cb98-121"><a href="#cb98-121" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="va">self</span>.box_cox:</span>
<span id="cb98-122"><a href="#cb98-122" aria-hidden="true" tabindex="-1"></a>                <span class="va">self</span>.is_zero <span class="op">=</span> np.<span class="bu">any</span>(np.array(dfc[<span class="va">self</span>.target_col]) <span class="op">&lt;</span> <span class="dv">1</span>) <span class="co"># check for zero or negative values</span></span>
<span id="cb98-123"><a href="#cb98-123" aria-hidden="true" tabindex="-1"></a>                trans_data, <span class="va">self</span>.lamda <span class="op">=</span> box_cox_transform(x<span class="op">=</span>dfc[<span class="va">self</span>.target_col],</span>
<span id="cb98-124"><a href="#cb98-124" aria-hidden="true" tabindex="-1"></a>                                                        shift<span class="op">=</span><span class="va">self</span>.is_zero,</span>
<span id="cb98-125"><a href="#cb98-125" aria-hidden="true" tabindex="-1"></a>                                                        box_cox_lmda<span class="op">=</span><span class="va">self</span>.lamda)</span>
<span id="cb98-126"><a href="#cb98-126" aria-hidden="true" tabindex="-1"></a>                dfc[<span class="va">self</span>.target_col] <span class="op">=</span> trans_data</span>
<span id="cb98-127"><a href="#cb98-127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-128"><a href="#cb98-128" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="va">self</span>.trend <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb98-129"><a href="#cb98-129" aria-hidden="true" tabindex="-1"></a>                <span class="va">self</span>.<span class="bu">len</span> <span class="op">=</span> <span class="bu">len</span>(dfc)</span>
<span id="cb98-130"><a href="#cb98-130" aria-hidden="true" tabindex="-1"></a>                <span class="va">self</span>.target_orig <span class="op">=</span> dfc[<span class="va">self</span>.target_col] <span class="co"># Store original values for later use during forecasting</span></span>
<span id="cb98-131"><a href="#cb98-131" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="va">self</span>.trend <span class="op">==</span> <span class="st">"linear"</span>:</span>
<span id="cb98-132"><a href="#cb98-132" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># self.lr_model = LinearRegression().fit(np.arange(self.len).reshape(-1, 1), self.target_orig)</span></span>
<span id="cb98-133"><a href="#cb98-133" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># dfc[self.target_col] = dfc[self.target_col] - self.lr_model.predict(np.arange(self.len).reshape(-1, 1))</span></span>
<span id="cb98-134"><a href="#cb98-134" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> <span class="va">self</span>.cps <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb98-135"><a href="#cb98-135" aria-hidden="true" tabindex="-1"></a>                        trend, <span class="va">self</span>.lr_model <span class="op">=</span> lr_trend_model(<span class="va">self</span>.target_orig, breakpoints<span class="op">=</span><span class="va">self</span>.cps, <span class="bu">type</span><span class="op">=</span><span class="st">'piecewise'</span>)</span>
<span id="cb98-136"><a href="#cb98-136" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">else</span>:</span>
<span id="cb98-137"><a href="#cb98-137" aria-hidden="true" tabindex="-1"></a>                        trend, <span class="va">self</span>.lr_model <span class="op">=</span> lr_trend_model(<span class="va">self</span>.target_orig)</span>
<span id="cb98-138"><a href="#cb98-138" aria-hidden="true" tabindex="-1"></a>                    dfc[<span class="va">self</span>.target_col] <span class="op">=</span> dfc[<span class="va">self</span>.target_col] <span class="op">-</span> trend</span>
<span id="cb98-139"><a href="#cb98-139" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="va">self</span>.trend <span class="op">==</span> <span class="st">"ets"</span>:</span>
<span id="cb98-140"><a href="#cb98-140" aria-hidden="true" tabindex="-1"></a>                    <span class="va">self</span>.ets_model_fit <span class="op">=</span> ExponentialSmoothing(<span class="va">self</span>.target_orig, <span class="op">**</span><span class="va">self</span>.ets_model).fit(<span class="op">**</span><span class="va">self</span>.ets_fit)</span>
<span id="cb98-141"><a href="#cb98-141" aria-hidden="true" tabindex="-1"></a>                    dfc[<span class="va">self</span>.target_col] <span class="op">=</span> dfc[<span class="va">self</span>.target_col] <span class="op">-</span> <span class="va">self</span>.ets_model_fit.fittedvalues.values</span>
<span id="cb98-142"><a href="#cb98-142" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-143"><a href="#cb98-143" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-144"><a href="#cb98-144" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Apply differencing if specified</span></span>
<span id="cb98-145"><a href="#cb98-145" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="va">self</span>.diff <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span> <span class="kw">or</span> <span class="va">self</span>.season_diff <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb98-146"><a href="#cb98-146" aria-hidden="true" tabindex="-1"></a>                <span class="va">self</span>.orig <span class="op">=</span> dfc[<span class="va">self</span>.target_col].tolist()</span>
<span id="cb98-147"><a href="#cb98-147" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="va">self</span>.diff <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb98-148"><a href="#cb98-148" aria-hidden="true" tabindex="-1"></a>                    dfc[<span class="va">self</span>.target_col] <span class="op">=</span> np.diff(dfc[<span class="va">self</span>.target_col], n<span class="op">=</span><span class="va">self</span>.diff,</span>
<span id="cb98-149"><a href="#cb98-149" aria-hidden="true" tabindex="-1"></a>                                                prepend<span class="op">=</span>np.repeat(np.nan, <span class="va">self</span>.diff))</span>
<span id="cb98-150"><a href="#cb98-150" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="va">self</span>.season_diff <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb98-151"><a href="#cb98-151" aria-hidden="true" tabindex="-1"></a>                    <span class="va">self</span>.orig_d <span class="op">=</span> dfc[<span class="va">self</span>.target_col].tolist()</span>
<span id="cb98-152"><a href="#cb98-152" aria-hidden="true" tabindex="-1"></a>                    dfc[<span class="va">self</span>.target_col] <span class="op">=</span> seasonal_diff(dfc[<span class="va">self</span>.target_col], <span class="va">self</span>.season_diff)</span>
<span id="cb98-153"><a href="#cb98-153" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-154"><a href="#cb98-154" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Create lag features based on lags parameter</span></span>
<span id="cb98-155"><a href="#cb98-155" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="va">self</span>.lags <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb98-156"><a href="#cb98-156" aria-hidden="true" tabindex="-1"></a>                <span class="cf">for</span> lag <span class="kw">in</span> <span class="va">self</span>.lags:</span>
<span id="cb98-157"><a href="#cb98-157" aria-hidden="true" tabindex="-1"></a>                    dfc[<span class="ss">f"</span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>target_col<span class="sc">}</span><span class="ss">_lag_</span><span class="sc">{</span>lag<span class="sc">}</span><span class="ss">"</span>] <span class="op">=</span> dfc[<span class="va">self</span>.target_col].shift(lag)</span>
<span id="cb98-158"><a href="#cb98-158" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Create additional lag transformations if specified</span></span>
<span id="cb98-159"><a href="#cb98-159" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="va">self</span>.lag_transform <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb98-160"><a href="#cb98-160" aria-hidden="true" tabindex="-1"></a>                <span class="cf">for</span> func <span class="kw">in</span> <span class="va">self</span>.lag_transform:</span>
<span id="cb98-161"><a href="#cb98-161" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> <span class="bu">isinstance</span>(func, (expanding_std, expanding_mean)):</span>
<span id="cb98-162"><a href="#cb98-162" aria-hidden="true" tabindex="-1"></a>                        dfc[<span class="ss">f"</span><span class="sc">{</span>func<span class="sc">.</span><span class="va">__class__</span><span class="sc">.</span><span class="va">__name__</span><span class="sc">}</span><span class="ss">_shift_</span><span class="sc">{</span>func<span class="sc">.</span>shift<span class="sc">}</span><span class="ss">"</span>] <span class="op">=</span> func(dfc[<span class="va">self</span>.target_col])</span>
<span id="cb98-163"><a href="#cb98-163" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">elif</span> <span class="bu">isinstance</span>(func, expanding_quantile):</span>
<span id="cb98-164"><a href="#cb98-164" aria-hidden="true" tabindex="-1"></a>                        dfc[<span class="ss">f"</span><span class="sc">{</span>func<span class="sc">.</span><span class="va">__class__</span><span class="sc">.</span><span class="va">__name__</span><span class="sc">}</span><span class="ss">_shift_</span><span class="sc">{</span>func<span class="sc">.</span>shift<span class="sc">}</span><span class="ss">_q</span><span class="sc">{</span>func<span class="sc">.</span>quantile<span class="sc">}</span><span class="ss">"</span>] <span class="op">=</span> func(dfc[<span class="va">self</span>.target_col])</span>
<span id="cb98-165"><a href="#cb98-165" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">elif</span> <span class="bu">isinstance</span>(func, rolling_quantile):</span>
<span id="cb98-166"><a href="#cb98-166" aria-hidden="true" tabindex="-1"></a>                        dfc[<span class="ss">f"</span><span class="sc">{</span>func<span class="sc">.</span><span class="va">__class__</span><span class="sc">.</span><span class="va">__name__</span><span class="sc">}</span><span class="ss">_</span><span class="sc">{</span>func<span class="sc">.</span>window_size<span class="sc">}</span><span class="ss">_shift_</span><span class="sc">{</span>func<span class="sc">.</span>shift<span class="sc">}</span><span class="ss">_q</span><span class="sc">{</span>func<span class="sc">.</span>quantile<span class="sc">}</span><span class="ss">"</span>] <span class="op">=</span> func(dfc[<span class="va">self</span>.target_col])</span>
<span id="cb98-167"><a href="#cb98-167" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">else</span>:</span>
<span id="cb98-168"><a href="#cb98-168" aria-hidden="true" tabindex="-1"></a>                        dfc[<span class="ss">f"</span><span class="sc">{</span>func<span class="sc">.</span><span class="va">__class__</span><span class="sc">.</span><span class="va">__name__</span><span class="sc">}</span><span class="ss">_</span><span class="sc">{</span>func<span class="sc">.</span>window_size<span class="sc">}</span><span class="ss">_shift_</span><span class="sc">{</span>func<span class="sc">.</span>shift<span class="sc">}</span><span class="ss">"</span>] <span class="op">=</span> func(dfc[<span class="va">self</span>.target_col])</span>
<span id="cb98-169"><a href="#cb98-169" aria-hidden="true" tabindex="-1"></a>                        </span>
<span id="cb98-170"><a href="#cb98-170" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.df <span class="op">=</span> dfc.dropna()</span>
<span id="cb98-171"><a href="#cb98-171" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.X <span class="op">=</span> <span class="va">self</span>.df.drop(columns<span class="op">=</span><span class="va">self</span>.target_col)</span>
<span id="cb98-172"><a href="#cb98-172" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.y <span class="op">=</span> <span class="va">self</span>.df[<span class="va">self</span>.target_col]</span>
<span id="cb98-173"><a href="#cb98-173" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="va">self</span>.cons:</span>
<span id="cb98-174"><a href="#cb98-174" aria-hidden="true" tabindex="-1"></a>                <span class="va">self</span>.X <span class="op">=</span> sm.add_constant(<span class="va">self</span>.X)</span>
<span id="cb98-175"><a href="#cb98-175" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.col_names <span class="op">=</span> <span class="va">self</span>.X.columns.tolist() <span class="cf">if</span> <span class="bu">hasattr</span>(<span class="va">self</span>.X, <span class="st">'columns'</span>) <span class="cf">else</span> [<span class="ss">f"x</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">"</span> <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="va">self</span>.X.shape[<span class="dv">1</span>])]</span>
<span id="cb98-176"><a href="#cb98-176" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.X <span class="op">=</span> np.array(<span class="va">self</span>.X)</span>
<span id="cb98-177"><a href="#cb98-177" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.y <span class="op">=</span> np.array(<span class="va">self</span>.y)</span>
<span id="cb98-178"><a href="#cb98-178" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.T <span class="op">=</span> <span class="bu">len</span>(<span class="va">self</span>.y)</span>
<span id="cb98-179"><a href="#cb98-179" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="va">self</span>.coeffs <span class="kw">is</span> <span class="va">None</span> <span class="kw">or</span> <span class="va">self</span>.stds <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb98-180"><a href="#cb98-180" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Initial fit: use unweighted least squares for all states</span></span>
<span id="cb98-181"><a href="#cb98-181" aria-hidden="true" tabindex="-1"></a>                coeffs <span class="op">=</span> []</span>
<span id="cb98-182"><a href="#cb98-182" aria-hidden="true" tabindex="-1"></a>                stds <span class="op">=</span> []</span>
<span id="cb98-183"><a href="#cb98-183" aria-hidden="true" tabindex="-1"></a>                <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="va">self</span>.N):</span>
<span id="cb98-184"><a href="#cb98-184" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># Least squares fit</span></span>
<span id="cb98-185"><a href="#cb98-185" aria-hidden="true" tabindex="-1"></a>                    coeff_i <span class="op">=</span> np.linalg.lstsq(<span class="va">self</span>.X, <span class="va">self</span>.y, rcond<span class="op">=</span><span class="va">None</span>)[<span class="dv">0</span>]</span>
<span id="cb98-186"><a href="#cb98-186" aria-hidden="true" tabindex="-1"></a>                    coeffs.append(coeff_i)</span>
<span id="cb98-187"><a href="#cb98-187" aria-hidden="true" tabindex="-1"></a>                    y_pred <span class="op">=</span> <span class="va">self</span>.X <span class="op">@</span> coeff_i</span>
<span id="cb98-188"><a href="#cb98-188" aria-hidden="true" tabindex="-1"></a>                    resid <span class="op">=</span> <span class="va">self</span>.y <span class="op">-</span> y_pred</span>
<span id="cb98-189"><a href="#cb98-189" aria-hidden="true" tabindex="-1"></a>                    var_i <span class="op">=</span> np.mean(resid <span class="op">**</span> <span class="dv">2</span>)</span>
<span id="cb98-190"><a href="#cb98-190" aria-hidden="true" tabindex="-1"></a>                    stds.append(np.sqrt(var_i))</span>
<span id="cb98-191"><a href="#cb98-191" aria-hidden="true" tabindex="-1"></a>                <span class="va">self</span>.coeffs <span class="op">=</span> np.row_stack(coeffs)</span>
<span id="cb98-192"><a href="#cb98-192" aria-hidden="true" tabindex="-1"></a>                <span class="va">self</span>.stds <span class="op">=</span> np.array(stds)</span>
<span id="cb98-193"><a href="#cb98-193" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-194"><a href="#cb98-194" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb98-195"><a href="#cb98-195" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> dfc.dropna()</span>
<span id="cb98-196"><a href="#cb98-196" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-197"><a href="#cb98-197" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-198"><a href="#cb98-198" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> compute_coeffs(<span class="va">self</span>, w_floor<span class="op">=</span><span class="fl">1e-5</span>):</span>
<span id="cb98-199"><a href="#cb98-199" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-200"><a href="#cb98-200" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Update regression coefficients and stds for each state</span></span>
<span id="cb98-201"><a href="#cb98-201" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-202"><a href="#cb98-202" aria-hidden="true" tabindex="-1"></a>        <span class="co"># If posterior probabilities are shorter than the number of observations, make self.X and self.y same length visa vis make posterier same as self.X and self.y length</span></span>
<span id="cb98-203"><a href="#cb98-203" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="va">self</span>.posterior.shape[<span class="dv">1</span>] <span class="op">&lt;</span> <span class="va">self</span>.X.shape[<span class="dv">0</span>]:</span>
<span id="cb98-204"><a href="#cb98-204" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Truncate self.X and self.y to match the length of self.posterior[i]</span></span>
<span id="cb98-205"><a href="#cb98-205" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.X <span class="op">=</span> <span class="va">self</span>.X[:<span class="va">self</span>.posterior.shape[<span class="dv">1</span>]]</span>
<span id="cb98-206"><a href="#cb98-206" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.y <span class="op">=</span> <span class="va">self</span>.y[:<span class="va">self</span>.posterior.shape[<span class="dv">1</span>]]</span>
<span id="cb98-207"><a href="#cb98-207" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="va">self</span>.posterior.shape[<span class="dv">1</span>] <span class="op">&gt;</span> <span class="va">self</span>.X.shape[<span class="dv">0</span>]:</span>
<span id="cb98-208"><a href="#cb98-208" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Truncate self.posterior to match the length of self.X and self.y</span></span>
<span id="cb98-209"><a href="#cb98-209" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.posterior <span class="op">=</span> <span class="va">self</span>.posterior[:, <span class="op">-</span><span class="va">self</span>.X.shape[<span class="dv">0</span>]:]</span>
<span id="cb98-210"><a href="#cb98-210" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-211"><a href="#cb98-211" aria-hidden="true" tabindex="-1"></a>        coeffs <span class="op">=</span> []</span>
<span id="cb98-212"><a href="#cb98-212" aria-hidden="true" tabindex="-1"></a>        stds <span class="op">=</span> []</span>
<span id="cb98-213"><a href="#cb98-213" aria-hidden="true" tabindex="-1"></a>        X <span class="op">=</span> <span class="va">self</span>.X</span>
<span id="cb98-214"><a href="#cb98-214" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> s <span class="kw">in</span> <span class="bu">range</span>(<span class="va">self</span>.N):</span>
<span id="cb98-215"><a href="#cb98-215" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Add floor so state isn’t “killed”</span></span>
<span id="cb98-216"><a href="#cb98-216" aria-hidden="true" tabindex="-1"></a>            w <span class="op">=</span> <span class="va">self</span>.posterior[s] <span class="op">+</span> w_floor</span>
<span id="cb98-217"><a href="#cb98-217" aria-hidden="true" tabindex="-1"></a>            w <span class="op">/=</span> w.<span class="bu">sum</span>()</span>
<span id="cb98-218"><a href="#cb98-218" aria-hidden="true" tabindex="-1"></a>            sw <span class="op">=</span> np.sqrt(w)</span>
<span id="cb98-219"><a href="#cb98-219" aria-hidden="true" tabindex="-1"></a>            Xw <span class="op">=</span> X <span class="op">*</span> sw[:, <span class="va">None</span>]</span>
<span id="cb98-220"><a href="#cb98-220" aria-hidden="true" tabindex="-1"></a>            yw <span class="op">=</span> <span class="va">self</span>.y <span class="op">*</span> sw</span>
<span id="cb98-221"><a href="#cb98-221" aria-hidden="true" tabindex="-1"></a>            XtX <span class="op">=</span> Xw.T <span class="op">@</span> Xw <span class="op">+</span> <span class="va">self</span>.ridge<span class="op">*</span>np.eye(X.shape[<span class="dv">1</span>])</span>
<span id="cb98-222"><a href="#cb98-222" aria-hidden="true" tabindex="-1"></a>            Xty <span class="op">=</span> Xw.T <span class="op">@</span> yw</span>
<span id="cb98-223"><a href="#cb98-223" aria-hidden="true" tabindex="-1"></a>            beta_s <span class="op">=</span> np.linalg.lstsq(XtX, Xty, rcond<span class="op">=</span><span class="va">None</span>)[<span class="dv">0</span>]</span>
<span id="cb98-224"><a href="#cb98-224" aria-hidden="true" tabindex="-1"></a>            coeffs.append(beta_s)</span>
<span id="cb98-225"><a href="#cb98-225" aria-hidden="true" tabindex="-1"></a>            resid <span class="op">=</span> <span class="va">self</span>.y <span class="op">-</span> X <span class="op">@</span> beta_s</span>
<span id="cb98-226"><a href="#cb98-226" aria-hidden="true" tabindex="-1"></a>            var_s <span class="op">=</span> (w <span class="op">*</span> resid<span class="op">**</span><span class="dv">2</span>).<span class="bu">sum</span>() <span class="op">/</span> <span class="bu">max</span>((w.<span class="bu">sum</span>()<span class="op">-</span>beta_s.shape[<span class="dv">0</span>]), <span class="fl">1.0</span>)</span>
<span id="cb98-227"><a href="#cb98-227" aria-hidden="true" tabindex="-1"></a>            stds.append(np.sqrt(<span class="bu">max</span>(var_s, <span class="va">self</span>.var_floor)))</span>
<span id="cb98-228"><a href="#cb98-228" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.coeffs <span class="op">=</span> np.row_stack(coeffs)</span>
<span id="cb98-229"><a href="#cb98-229" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.stds <span class="op">=</span> np.array(stds)</span>
<span id="cb98-230"><a href="#cb98-230" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-231"><a href="#cb98-231" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-232"><a href="#cb98-232" aria-hidden="true" tabindex="-1"></a><span class="co"># Hidden Markov Model with Vector Autoregressive (VAR)</span></span>
<span id="cb98-233"><a href="#cb98-233" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-234"><a href="#cb98-234" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _log_emissions(<span class="va">self</span>):</span>
<span id="cb98-235"><a href="#cb98-235" aria-hidden="true" tabindex="-1"></a>        <span class="co"># logB[s,t] = log p(y_t | state s)</span></span>
<span id="cb98-236"><a href="#cb98-236" aria-hidden="true" tabindex="-1"></a>        N, T <span class="op">=</span> <span class="va">self</span>.N, <span class="va">self</span>.T</span>
<span id="cb98-237"><a href="#cb98-237" aria-hidden="true" tabindex="-1"></a>        logB <span class="op">=</span> np.empty((N, T))</span>
<span id="cb98-238"><a href="#cb98-238" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.fitted <span class="op">=</span> np.empty((N, T))</span>
<span id="cb98-239"><a href="#cb98-239" aria-hidden="true" tabindex="-1"></a>        <span class="co"># self.compute_coeffs()</span></span>
<span id="cb98-240"><a href="#cb98-240" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> s <span class="kw">in</span> <span class="bu">range</span>(N):</span>
<span id="cb98-241"><a href="#cb98-241" aria-hidden="true" tabindex="-1"></a>            mu <span class="op">=</span> <span class="va">self</span>.X <span class="op">@</span> <span class="va">self</span>.coeffs[s]           <span class="co"># (T,)</span></span>
<span id="cb98-242"><a href="#cb98-242" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.fitted[s, :] <span class="op">=</span> mu</span>
<span id="cb98-243"><a href="#cb98-243" aria-hidden="true" tabindex="-1"></a>            logB[s, :] <span class="op">=</span> norm.logpdf(<span class="va">self</span>.y, loc<span class="op">=</span>mu, scale<span class="op">=</span><span class="va">self</span>.stds[s])</span>
<span id="cb98-244"><a href="#cb98-244" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> logB</span>
<span id="cb98-245"><a href="#cb98-245" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-246"><a href="#cb98-246" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _e_step_log(<span class="va">self</span>):</span>
<span id="cb98-247"><a href="#cb98-247" aria-hidden="true" tabindex="-1"></a>        N, T <span class="op">=</span> <span class="va">self</span>.N, <span class="va">self</span>.T</span>
<span id="cb98-248"><a href="#cb98-248" aria-hidden="true" tabindex="-1"></a>        logA  <span class="op">=</span> np.log(<span class="va">self</span>.A <span class="op">+</span> <span class="fl">1e-300</span>)</span>
<span id="cb98-249"><a href="#cb98-249" aria-hidden="true" tabindex="-1"></a>        logpi <span class="op">=</span> np.log(<span class="va">self</span>.pi <span class="op">+</span> <span class="fl">1e-300</span>)</span>
<span id="cb98-250"><a href="#cb98-250" aria-hidden="true" tabindex="-1"></a>        logB  <span class="op">=</span> <span class="va">self</span>._log_emissions()</span>
<span id="cb98-251"><a href="#cb98-251" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-252"><a href="#cb98-252" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Forward</span></span>
<span id="cb98-253"><a href="#cb98-253" aria-hidden="true" tabindex="-1"></a>        log_alpha <span class="op">=</span> np.empty((N, T))</span>
<span id="cb98-254"><a href="#cb98-254" aria-hidden="true" tabindex="-1"></a>        log_alpha[:, <span class="dv">0</span>] <span class="op">=</span> logpi <span class="op">+</span> logB[:, <span class="dv">0</span>]</span>
<span id="cb98-255"><a href="#cb98-255" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> t <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, T):</span>
<span id="cb98-256"><a href="#cb98-256" aria-hidden="true" tabindex="-1"></a>            <span class="co"># log_alpha[:,t] = logB[:,t] + logsumexp_i( log_alpha[i,t-1] + logA[i,:] )</span></span>
<span id="cb98-257"><a href="#cb98-257" aria-hidden="true" tabindex="-1"></a>            log_alpha[:, t] <span class="op">=</span> logB[:, t] <span class="op">+</span> logsumexp(log_alpha[:, t<span class="op">-</span><span class="dv">1</span>][:, <span class="va">None</span>] <span class="op">+</span> logA, axis<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb98-258"><a href="#cb98-258" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-259"><a href="#cb98-259" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Log-likelihood</span></span>
<span id="cb98-260"><a href="#cb98-260" aria-hidden="true" tabindex="-1"></a>        loglik <span class="op">=</span> logsumexp(log_alpha[:, <span class="op">-</span><span class="dv">1</span>])</span>
<span id="cb98-261"><a href="#cb98-261" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-262"><a href="#cb98-262" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Backward</span></span>
<span id="cb98-263"><a href="#cb98-263" aria-hidden="true" tabindex="-1"></a>        log_beta <span class="op">=</span> np.full((N, T), <span class="fl">0.0</span>)</span>
<span id="cb98-264"><a href="#cb98-264" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> t <span class="kw">in</span> <span class="bu">range</span>(T<span class="op">-</span><span class="dv">2</span>, <span class="op">-</span><span class="dv">1</span>, <span class="op">-</span><span class="dv">1</span>):</span>
<span id="cb98-265"><a href="#cb98-265" aria-hidden="true" tabindex="-1"></a>            <span class="co"># log_beta[:,t] = logsumexp_j( logA + logB[:,t+1] + log_beta[:,t+1] , axis=1 )</span></span>
<span id="cb98-266"><a href="#cb98-266" aria-hidden="true" tabindex="-1"></a>            log_beta[:, t] <span class="op">=</span> logsumexp(logA <span class="op">+</span> (logB[:, t<span class="op">+</span><span class="dv">1</span>] <span class="op">+</span> log_beta[:, t<span class="op">+</span><span class="dv">1</span>])[<span class="va">None</span>, :], axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb98-267"><a href="#cb98-267" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-268"><a href="#cb98-268" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Gamma</span></span>
<span id="cb98-269"><a href="#cb98-269" aria-hidden="true" tabindex="-1"></a>        log_gamma <span class="op">=</span> log_alpha <span class="op">+</span> log_beta <span class="op">-</span> loglik</span>
<span id="cb98-270"><a href="#cb98-270" aria-hidden="true" tabindex="-1"></a>        <span class="co"># normalize per time to kill rounding; columns sum to 1 after exp</span></span>
<span id="cb98-271"><a href="#cb98-271" aria-hidden="true" tabindex="-1"></a>        log_gamma <span class="op">-=</span> logsumexp(log_gamma, axis<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb98-272"><a href="#cb98-272" aria-hidden="true" tabindex="-1"></a>        gamma <span class="op">=</span> np.exp(log_gamma)</span>
<span id="cb98-273"><a href="#cb98-273" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-274"><a href="#cb98-274" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Xi</span></span>
<span id="cb98-275"><a href="#cb98-275" aria-hidden="true" tabindex="-1"></a>        log_xi <span class="op">=</span> np.empty((N, N, T<span class="op">-</span><span class="dv">1</span>))</span>
<span id="cb98-276"><a href="#cb98-276" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> t <span class="kw">in</span> <span class="bu">range</span>(T<span class="op">-</span><span class="dv">1</span>):</span>
<span id="cb98-277"><a href="#cb98-277" aria-hidden="true" tabindex="-1"></a>            tmp <span class="op">=</span> log_alpha[:, t][:, <span class="va">None</span>] <span class="op">+</span> logA <span class="op">+</span> (logB[:, t<span class="op">+</span><span class="dv">1</span>] <span class="op">+</span> log_beta[:, t<span class="op">+</span><span class="dv">1</span>])[<span class="va">None</span>, :]</span>
<span id="cb98-278"><a href="#cb98-278" aria-hidden="true" tabindex="-1"></a>            tmp <span class="op">-=</span> logsumexp(tmp)      <span class="co"># normalize this slice</span></span>
<span id="cb98-279"><a href="#cb98-279" aria-hidden="true" tabindex="-1"></a>            log_xi[:, :, t] <span class="op">=</span> tmp</span>
<span id="cb98-280"><a href="#cb98-280" aria-hidden="true" tabindex="-1"></a>        xi <span class="op">=</span> np.exp(log_xi)</span>
<span id="cb98-281"><a href="#cb98-281" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-282"><a href="#cb98-282" aria-hidden="true" tabindex="-1"></a>        <span class="co"># print("logB min/max:", np.min(logB), np.max(logB))</span></span>
<span id="cb98-283"><a href="#cb98-283" aria-hidden="true" tabindex="-1"></a>        <span class="co"># print("Any NaN in logB?", np.any(np.isnan(logB)))</span></span>
<span id="cb98-284"><a href="#cb98-284" aria-hidden="true" tabindex="-1"></a>        <span class="co"># print("Any Inf in logB?", np.any(np.isinf(logB)))</span></span>
<span id="cb98-285"><a href="#cb98-285" aria-hidden="true" tabindex="-1"></a>        <span class="co"># sanity checks (soft)</span></span>
<span id="cb98-286"><a href="#cb98-286" aria-hidden="true" tabindex="-1"></a>        <span class="cf">assert</span> np.allclose(gamma.<span class="bu">sum</span>(axis<span class="op">=</span><span class="dv">0</span>), <span class="fl">1.0</span>, atol<span class="op">=</span><span class="fl">1e-8</span>)</span>
<span id="cb98-287"><a href="#cb98-287" aria-hidden="true" tabindex="-1"></a>        <span class="cf">assert</span> np.allclose(xi.<span class="bu">sum</span>(axis<span class="op">=</span>(<span class="dv">0</span>,<span class="dv">1</span>)), <span class="fl">1.0</span>, atol<span class="op">=</span><span class="fl">1e-8</span>)</span>
<span id="cb98-288"><a href="#cb98-288" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-289"><a href="#cb98-289" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.log_forward  <span class="op">=</span> log_alpha</span>
<span id="cb98-290"><a href="#cb98-290" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.log_backward <span class="op">=</span> log_beta</span>
<span id="cb98-291"><a href="#cb98-291" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.posterior    <span class="op">=</span> gamma</span>
<span id="cb98-292"><a href="#cb98-292" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.loglik       <span class="op">=</span> loglik</span>
<span id="cb98-293"><a href="#cb98-293" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> loglik, gamma, xi</span>
<span id="cb98-294"><a href="#cb98-294" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-295"><a href="#cb98-295" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-296"><a href="#cb98-296" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _m_step(<span class="va">self</span>, gamma, xi):</span>
<span id="cb98-297"><a href="#cb98-297" aria-hidden="true" tabindex="-1"></a>        numer <span class="op">=</span> xi.<span class="bu">sum</span>(axis<span class="op">=</span><span class="dv">2</span>)                         <span class="co"># (N,N)</span></span>
<span id="cb98-298"><a href="#cb98-298" aria-hidden="true" tabindex="-1"></a>        denom <span class="op">=</span> gamma[:, :<span class="op">-</span><span class="dv">1</span>].<span class="bu">sum</span>(axis<span class="op">=</span><span class="dv">1</span>, keepdims<span class="op">=</span><span class="va">True</span>)  <span class="co"># (N,1)</span></span>
<span id="cb98-299"><a href="#cb98-299" aria-hidden="true" tabindex="-1"></a>        A <span class="op">=</span> numer <span class="op">/</span> (denom <span class="op">+</span> <span class="fl">1e-12</span>)</span>
<span id="cb98-300"><a href="#cb98-300" aria-hidden="true" tabindex="-1"></a>        A <span class="op">=</span> np.maximum(A, <span class="fl">1e-12</span>)</span>
<span id="cb98-301"><a href="#cb98-301" aria-hidden="true" tabindex="-1"></a>        A <span class="op">/=</span> A.<span class="bu">sum</span>(axis<span class="op">=</span><span class="dv">1</span>, keepdims<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb98-302"><a href="#cb98-302" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.A <span class="op">=</span> A</span>
<span id="cb98-303"><a href="#cb98-303" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.pi <span class="op">=</span> gamma[:, <span class="dv">0</span>] <span class="op">/</span> gamma[:, <span class="dv">0</span>].<span class="bu">sum</span>()</span>
<span id="cb98-304"><a href="#cb98-304" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.compute_coeffs() </span>
<span id="cb98-305"><a href="#cb98-305" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-306"><a href="#cb98-306" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-307"><a href="#cb98-307" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> EM(<span class="va">self</span>):</span>
<span id="cb98-308"><a href="#cb98-308" aria-hidden="true" tabindex="-1"></a>        loglik, gamma, xi <span class="op">=</span> <span class="va">self</span>._e_step_log()</span>
<span id="cb98-309"><a href="#cb98-309" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>._m_step(gamma, xi)</span>
<span id="cb98-310"><a href="#cb98-310" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.LL <span class="op">=</span> loglik</span>
<span id="cb98-311"><a href="#cb98-311" aria-hidden="true" tabindex="-1"></a>        <span class="co"># return loglik</span></span>
<span id="cb98-312"><a href="#cb98-312" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb98-313"><a href="#cb98-313" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> fit_em(<span class="va">self</span>, df_train):</span>
<span id="cb98-314"><a href="#cb98-314" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""</span></span>
<span id="cb98-315"><a href="#cb98-315" aria-hidden="true" tabindex="-1"></a><span class="co">        Run EM iterations until convergence (log-domain version).</span></span>
<span id="cb98-316"><a href="#cb98-316" aria-hidden="true" tabindex="-1"></a><span class="co">        """</span></span>
<span id="cb98-317"><a href="#cb98-317" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-318"><a href="#cb98-318" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Handle categorical variable encoding</span></span>
<span id="cb98-319"><a href="#cb98-319" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="va">self</span>.cat_variables <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb98-320"><a href="#cb98-320" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.cat_var <span class="op">=</span> {c: <span class="bu">sorted</span>(df_train[c].drop_duplicates().tolist(), key<span class="op">=</span><span class="kw">lambda</span> x: <span class="bu">str</span>(x))</span>
<span id="cb98-321"><a href="#cb98-321" aria-hidden="true" tabindex="-1"></a>                            <span class="cf">for</span> c <span class="kw">in</span> <span class="va">self</span>.cat_variables}</span>
<span id="cb98-322"><a href="#cb98-322" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.drop_categ <span class="op">=</span> [<span class="bu">sorted</span>(df_train[col].drop_duplicates().tolist(), key<span class="op">=</span><span class="kw">lambda</span> x: <span class="bu">str</span>(x))[<span class="dv">0</span>]</span>
<span id="cb98-323"><a href="#cb98-323" aria-hidden="true" tabindex="-1"></a>                               <span class="cf">for</span> col <span class="kw">in</span> <span class="va">self</span>.cat_variables]</span>
<span id="cb98-324"><a href="#cb98-324" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.data_prep(df_train)</span>
<span id="cb98-325"><a href="#cb98-325" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-326"><a href="#cb98-326" aria-hidden="true" tabindex="-1"></a>        prev_ll <span class="op">=</span> <span class="op">-</span>np.inf</span>
<span id="cb98-327"><a href="#cb98-327" aria-hidden="true" tabindex="-1"></a>        <span class="co"># store intermediate log-likelihoods</span></span>
<span id="cb98-328"><a href="#cb98-328" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.log_likelihoods <span class="op">=</span> []</span>
<span id="cb98-329"><a href="#cb98-329" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> it <span class="kw">in</span> <span class="bu">range</span>(<span class="va">self</span>.<span class="bu">iter</span>):</span>
<span id="cb98-330"><a href="#cb98-330" aria-hidden="true" tabindex="-1"></a>            <span class="co"># loglik, gamma, xi = self._e_step_log()</span></span>
<span id="cb98-331"><a href="#cb98-331" aria-hidden="true" tabindex="-1"></a>            <span class="co"># self._m_step(gamma, xi)</span></span>
<span id="cb98-332"><a href="#cb98-332" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.EM()</span>
<span id="cb98-333"><a href="#cb98-333" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="va">self</span>.verb:</span>
<span id="cb98-334"><a href="#cb98-334" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f"Iter </span><span class="sc">{</span>it<span class="sc">}</span><span class="ss">: loglik=</span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>LL<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb98-335"><a href="#cb98-335" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> it <span class="op">&gt;</span> <span class="dv">10</span>:</span>
<span id="cb98-336"><a href="#cb98-336" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="bu">abs</span>(<span class="va">self</span>.LL <span class="op">-</span> prev_ll) <span class="op">&lt;</span> <span class="va">self</span>.tol:</span>
<span id="cb98-337"><a href="#cb98-337" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> <span class="va">self</span>.verb:</span>
<span id="cb98-338"><a href="#cb98-338" aria-hidden="true" tabindex="-1"></a>                        <span class="bu">print</span>(<span class="st">"Converged."</span>)</span>
<span id="cb98-339"><a href="#cb98-339" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">break</span></span>
<span id="cb98-340"><a href="#cb98-340" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.log_likelihoods.append(<span class="va">self</span>.LL)</span>
<span id="cb98-341"><a href="#cb98-341" aria-hidden="true" tabindex="-1"></a>            prev_ll <span class="op">=</span> <span class="va">self</span>.LL</span>
<span id="cb98-342"><a href="#cb98-342" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>.LL</span>
<span id="cb98-343"><a href="#cb98-343" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-344"><a href="#cb98-344" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> fit(<span class="va">self</span>, df, n_iter<span class="op">=</span><span class="dv">1</span>):</span>
<span id="cb98-345"><a href="#cb98-345" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""</span></span>
<span id="cb98-346"><a href="#cb98-346" aria-hidden="true" tabindex="-1"></a><span class="co">        Refit the HMM regression model on new training data (log-domain version).</span></span>
<span id="cb98-347"><a href="#cb98-347" aria-hidden="true" tabindex="-1"></a><span class="co">        """</span></span>
<span id="cb98-348"><a href="#cb98-348" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> n_iter <span class="op">&lt;</span> <span class="dv">1</span>:</span>
<span id="cb98-349"><a href="#cb98-349" aria-hidden="true" tabindex="-1"></a>            <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="st">"n_iter must be at least 1."</span>)</span>
<span id="cb98-350"><a href="#cb98-350" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb98-351"><a href="#cb98-351" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.data_prep(df)</span>
<span id="cb98-352"><a href="#cb98-352" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> n_iter <span class="op">&gt;</span> <span class="dv">1</span>:</span>
<span id="cb98-353"><a href="#cb98-353" aria-hidden="true" tabindex="-1"></a>            prev_ll <span class="op">=</span> <span class="va">self</span>.LL</span>
<span id="cb98-354"><a href="#cb98-354" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> _ <span class="kw">in</span> <span class="bu">range</span>(n_iter):</span>
<span id="cb98-355"><a href="#cb98-355" aria-hidden="true" tabindex="-1"></a>                <span class="va">self</span>.EM()</span>
<span id="cb98-356"><a href="#cb98-356" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="bu">abs</span>(<span class="va">self</span>.LL <span class="op">-</span> prev_ll) <span class="op">&lt;</span> <span class="va">self</span>.tol:</span>
<span id="cb98-357"><a href="#cb98-357" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">break</span></span>
<span id="cb98-358"><a href="#cb98-358" aria-hidden="true" tabindex="-1"></a>                <span class="cf">else</span>:</span>
<span id="cb98-359"><a href="#cb98-359" aria-hidden="true" tabindex="-1"></a>                    prev_ll <span class="op">=</span> <span class="va">self</span>.LL</span>
<span id="cb98-360"><a href="#cb98-360" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb98-361"><a href="#cb98-361" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.EM()</span>
<span id="cb98-362"><a href="#cb98-362" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-363"><a href="#cb98-363" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>.LL</span>
<span id="cb98-364"><a href="#cb98-364" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb98-365"><a href="#cb98-365" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> predict_states(<span class="va">self</span>):</span>
<span id="cb98-366"><a href="#cb98-366" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> np.argmax(<span class="va">self</span>.posterior, axis<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb98-367"><a href="#cb98-367" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> predict_proba(<span class="va">self</span>):</span>
<span id="cb98-368"><a href="#cb98-368" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>.posterior</span>
<span id="cb98-369"><a href="#cb98-369" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb98-370"><a href="#cb98-370" aria-hidden="true" tabindex="-1"></a>    <span class="co"># AIC computation    </span></span>
<span id="cb98-371"><a href="#cb98-371" aria-hidden="true" tabindex="-1"></a>    <span class="at">@property</span></span>
<span id="cb98-372"><a href="#cb98-372" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> AIC(<span class="va">self</span>):</span>
<span id="cb98-373"><a href="#cb98-373" aria-hidden="true" tabindex="-1"></a>        k <span class="op">=</span> <span class="va">self</span>.N <span class="op">*</span> <span class="va">self</span>.X.shape[<span class="dv">1</span>] <span class="op">+</span> <span class="va">self</span>.N <span class="op">**</span> <span class="dv">2</span> <span class="op">+</span> <span class="va">self</span>.N <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb98-374"><a href="#cb98-374" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="dv">2</span> <span class="op">*</span> k <span class="op">-</span> <span class="dv">2</span> <span class="op">*</span> <span class="va">self</span>.LL</span>
<span id="cb98-375"><a href="#cb98-375" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-376"><a href="#cb98-376" aria-hidden="true" tabindex="-1"></a>    <span class="at">@property</span></span>
<span id="cb98-377"><a href="#cb98-377" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> BIC(<span class="va">self</span>):</span>
<span id="cb98-378"><a href="#cb98-378" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb98-379"><a href="#cb98-379" aria-hidden="true" tabindex="-1"></a>        k <span class="op">=</span> <span class="va">self</span>.N <span class="op">*</span> <span class="va">self</span>.X.shape[<span class="dv">1</span>] <span class="op">+</span> <span class="va">self</span>.N <span class="op">**</span> <span class="dv">2</span> <span class="op">+</span> <span class="va">self</span>.N <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb98-380"><a href="#cb98-380" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb98-381"><a href="#cb98-381" aria-hidden="true" tabindex="-1"></a>        n <span class="op">=</span> <span class="va">self</span>.T  <span class="co"># effective number of observations</span></span>
<span id="cb98-382"><a href="#cb98-382" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="op">-</span><span class="dv">2</span> <span class="op">*</span> <span class="va">self</span>.LL <span class="op">+</span> k <span class="op">*</span> np.log(n)</span>
<span id="cb98-383"><a href="#cb98-383" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-384"><a href="#cb98-384" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> copy(<span class="va">self</span>):</span>
<span id="cb98-385"><a href="#cb98-385" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> copy.deepcopy(<span class="va">self</span>)</span>
<span id="cb98-386"><a href="#cb98-386" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-387"><a href="#cb98-387" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> forecast(<span class="va">self</span>, H, exog<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb98-388"><a href="#cb98-388" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""</span></span>
<span id="cb98-389"><a href="#cb98-389" aria-hidden="true" tabindex="-1"></a><span class="co">        Forecast H periods ahead using fitted HMM regression (log-domain version), with advanced post-processing.</span></span>
<span id="cb98-390"><a href="#cb98-390" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-391"><a href="#cb98-391" aria-hidden="true" tabindex="-1"></a><span class="co">        Handles:</span></span>
<span id="cb98-392"><a href="#cb98-392" aria-hidden="true" tabindex="-1"></a><span class="co">        - Trend re-adjustment (linear/ETS)</span></span>
<span id="cb98-393"><a href="#cb98-393" aria-hidden="true" tabindex="-1"></a><span class="co">        - Seasonal differencing reversal</span></span>
<span id="cb98-394"><a href="#cb98-394" aria-hidden="true" tabindex="-1"></a><span class="co">        - Regular differencing reversal</span></span>
<span id="cb98-395"><a href="#cb98-395" aria-hidden="true" tabindex="-1"></a><span class="co">        - Box-Cox back-transform</span></span>
<span id="cb98-396"><a href="#cb98-396" aria-hidden="true" tabindex="-1"></a><span class="co">        - Exogenous variables</span></span>
<span id="cb98-397"><a href="#cb98-397" aria-hidden="true" tabindex="-1"></a><span class="co">        - Lag transformations</span></span>
<span id="cb98-398"><a href="#cb98-398" aria-hidden="true" tabindex="-1"></a><span class="co">        """</span></span>
<span id="cb98-399"><a href="#cb98-399" aria-hidden="true" tabindex="-1"></a>        y_list <span class="op">=</span> <span class="va">self</span>.y.tolist()</span>
<span id="cb98-400"><a href="#cb98-400" aria-hidden="true" tabindex="-1"></a>        forecasts_ <span class="op">=</span> []</span>
<span id="cb98-401"><a href="#cb98-401" aria-hidden="true" tabindex="-1"></a>        N <span class="op">=</span> <span class="va">self</span>.N</span>
<span id="cb98-402"><a href="#cb98-402" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-403"><a href="#cb98-403" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Prepare exogenous future regressors if provided</span></span>
<span id="cb98-404"><a href="#cb98-404" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> exog <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb98-405"><a href="#cb98-405" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="va">self</span>.cons:</span>
<span id="cb98-406"><a href="#cb98-406" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> exog.shape[<span class="dv">0</span>] <span class="op">==</span> <span class="dv">1</span>:</span>
<span id="cb98-407"><a href="#cb98-407" aria-hidden="true" tabindex="-1"></a>                    exog.insert(<span class="dv">0</span>, <span class="st">'const'</span>, <span class="dv">1</span>)</span>
<span id="cb98-408"><a href="#cb98-408" aria-hidden="true" tabindex="-1"></a>                <span class="cf">else</span>:</span>
<span id="cb98-409"><a href="#cb98-409" aria-hidden="true" tabindex="-1"></a>                    exog <span class="op">=</span> sm.add_constant(exog)</span>
<span id="cb98-410"><a href="#cb98-410" aria-hidden="true" tabindex="-1"></a>            exog <span class="op">=</span> np.array(<span class="va">self</span>.data_prep(exog))</span>
<span id="cb98-411"><a href="#cb98-411" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-412"><a href="#cb98-412" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-413"><a href="#cb98-413" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Init with last forward distribution (in log)</span></span>
<span id="cb98-414"><a href="#cb98-414" aria-hidden="true" tabindex="-1"></a>        log_forward_last <span class="op">=</span> <span class="va">self</span>.log_forward[:, <span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb98-415"><a href="#cb98-415" aria-hidden="true" tabindex="-1"></a>        logA <span class="op">=</span> np.log(<span class="va">self</span>.A <span class="op">+</span> <span class="fl">1e-300</span>)</span>
<span id="cb98-416"><a href="#cb98-416" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-417"><a href="#cb98-417" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Forward</span></span>
<span id="cb98-418"><a href="#cb98-418" aria-hidden="true" tabindex="-1"></a>        log_alpha <span class="op">=</span> np.empty((N, H))</span>
<span id="cb98-419"><a href="#cb98-419" aria-hidden="true" tabindex="-1"></a>        log_alpha[:, <span class="dv">0</span>] <span class="op">=</span> logsumexp(log_forward_last[:, <span class="va">None</span>] <span class="op">+</span> logA, axis<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb98-420"><a href="#cb98-420" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> t <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, H):</span>
<span id="cb98-421"><a href="#cb98-421" aria-hidden="true" tabindex="-1"></a>            <span class="co"># log_alpha[:,t] = logB[:,t] + logsumexp_i( log_alpha[i,t-1] + logA[i,:] )</span></span>
<span id="cb98-422"><a href="#cb98-422" aria-hidden="true" tabindex="-1"></a>            log_alpha[:, t] <span class="op">=</span> logsumexp(log_alpha[:, t<span class="op">-</span><span class="dv">1</span>][:, <span class="va">None</span>] <span class="op">+</span> logA, axis<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb98-423"><a href="#cb98-423" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-424"><a href="#cb98-424" aria-hidden="true" tabindex="-1"></a>        log_alpha <span class="op">-=</span> logsumexp(log_alpha, axis<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb98-425"><a href="#cb98-425" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.forecast_forward <span class="op">=</span> np.exp(log_alpha)</span>
<span id="cb98-426"><a href="#cb98-426" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.state_forecasts <span class="op">=</span> np.argmax(<span class="va">self</span>.forecast_forward, axis<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb98-427"><a href="#cb98-427" aria-hidden="true" tabindex="-1"></a>        <span class="co">#per state forecasts</span></span>
<span id="cb98-428"><a href="#cb98-428" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.forecast_ps <span class="op">=</span> np.zeros((N, H))</span>
<span id="cb98-429"><a href="#cb98-429" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-430"><a href="#cb98-430" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Prepare for trend adjustment</span></span>
<span id="cb98-431"><a href="#cb98-431" aria-hidden="true" tabindex="-1"></a>        <span class="co"># This assumes you stored original target (pre-trend removal) in self.target_orig</span></span>
<span id="cb98-432"><a href="#cb98-432" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">hasattr</span>(<span class="va">self</span>, <span class="st">'target_orig'</span>) <span class="kw">and</span> <span class="va">self</span>.trend <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb98-433"><a href="#cb98-433" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="va">self</span>.trend <span class="op">==</span> <span class="st">"linear"</span>:</span>
<span id="cb98-434"><a href="#cb98-434" aria-hidden="true" tabindex="-1"></a>                <span class="co"># future_time = np.arange(len(self.target_orig), len(self.target_orig) + H).reshape(-1, 1)</span></span>
<span id="cb98-435"><a href="#cb98-435" aria-hidden="true" tabindex="-1"></a>                <span class="co"># trend_forecast = np.array(self.lr_model.predict(future_time))</span></span>
<span id="cb98-436"><a href="#cb98-436" aria-hidden="true" tabindex="-1"></a>                trend_forecast<span class="op">=</span> forecast_trend(model <span class="op">=</span> <span class="va">self</span>.lr_model, H<span class="op">=</span>H, start<span class="op">=</span><span class="va">self</span>.<span class="bu">len</span>, breakpoints<span class="op">=</span><span class="va">self</span>.cps)</span>
<span id="cb98-437"><a href="#cb98-437" aria-hidden="true" tabindex="-1"></a>            <span class="cf">elif</span> <span class="va">self</span>.trend <span class="op">==</span> <span class="st">"ets"</span>:</span>
<span id="cb98-438"><a href="#cb98-438" aria-hidden="true" tabindex="-1"></a>                trend_forecast <span class="op">=</span> np.array(<span class="va">self</span>.ets_model_fit.forecast(H))</span>
<span id="cb98-439"><a href="#cb98-439" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-440"><a href="#cb98-440" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> t <span class="kw">in</span> <span class="bu">range</span>(H):</span>
<span id="cb98-441"><a href="#cb98-441" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> exog <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb98-442"><a href="#cb98-442" aria-hidden="true" tabindex="-1"></a>                exo_inp <span class="op">=</span> exog[t].tolist()</span>
<span id="cb98-443"><a href="#cb98-443" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb98-444"><a href="#cb98-444" aria-hidden="true" tabindex="-1"></a>                exo_inp <span class="op">=</span> [<span class="dv">1</span>] <span class="cf">if</span> <span class="va">self</span>.cons <span class="cf">else</span> []</span>
<span id="cb98-445"><a href="#cb98-445" aria-hidden="true" tabindex="-1"></a>            lags <span class="op">=</span> [y_list[<span class="op">-</span>l] <span class="cf">for</span> l <span class="kw">in</span> <span class="va">self</span>.lags]</span>
<span id="cb98-446"><a href="#cb98-446" aria-hidden="true" tabindex="-1"></a>            transform_lag <span class="op">=</span> []</span>
<span id="cb98-447"><a href="#cb98-447" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="va">self</span>.lag_transform <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb98-448"><a href="#cb98-448" aria-hidden="true" tabindex="-1"></a>                series_array <span class="op">=</span> np.array(y_list)</span>
<span id="cb98-449"><a href="#cb98-449" aria-hidden="true" tabindex="-1"></a>                <span class="cf">for</span> func <span class="kw">in</span> <span class="va">self</span>.lag_transform:</span>
<span id="cb98-450"><a href="#cb98-450" aria-hidden="true" tabindex="-1"></a>                    transform_lag.append(func(series_array, is_forecast<span class="op">=</span><span class="va">True</span>).to_numpy()[<span class="op">-</span><span class="dv">1</span>])</span>
<span id="cb98-451"><a href="#cb98-451" aria-hidden="true" tabindex="-1"></a>            inp <span class="op">=</span> np.array(exo_inp <span class="op">+</span> lags <span class="op">+</span> transform_lag)</span>
<span id="cb98-452"><a href="#cb98-452" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-453"><a href="#cb98-453" aria-hidden="true" tabindex="-1"></a>            state_preds <span class="op">=</span> np.zeros(N)</span>
<span id="cb98-454"><a href="#cb98-454" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> j <span class="kw">in</span> <span class="bu">range</span>(N):</span>
<span id="cb98-455"><a href="#cb98-455" aria-hidden="true" tabindex="-1"></a>                mu <span class="op">=</span> np.dot(<span class="va">self</span>.coeffs[j], inp)</span>
<span id="cb98-456"><a href="#cb98-456" aria-hidden="true" tabindex="-1"></a>                state_preds[j] <span class="op">=</span> mu</span>
<span id="cb98-457"><a href="#cb98-457" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.forecast_ps[:, t] <span class="op">=</span> state_preds</span>
<span id="cb98-458"><a href="#cb98-458" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-459"><a href="#cb98-459" aria-hidden="true" tabindex="-1"></a>            <span class="co"># normalize to probabilities</span></span>
<span id="cb98-460"><a href="#cb98-460" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-461"><a href="#cb98-461" aria-hidden="true" tabindex="-1"></a>            <span class="co"># normalize to probabilities</span></span>
<span id="cb98-462"><a href="#cb98-462" aria-hidden="true" tabindex="-1"></a>            pred_w <span class="op">=</span> np.<span class="bu">sum</span>(<span class="va">self</span>.forecast_forward[:, t] <span class="op">*</span> state_preds)</span>
<span id="cb98-463"><a href="#cb98-463" aria-hidden="true" tabindex="-1"></a>            forecasts_.append(pred_w)</span>
<span id="cb98-464"><a href="#cb98-464" aria-hidden="true" tabindex="-1"></a>            y_list.append(pred_w)</span>
<span id="cb98-465"><a href="#cb98-465" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-466"><a href="#cb98-466" aria-hidden="true" tabindex="-1"></a>            <span class="co"># log_forward_last = log_f_t.copy()</span></span>
<span id="cb98-467"><a href="#cb98-467" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-468"><a href="#cb98-468" aria-hidden="true" tabindex="-1"></a>        forecasts <span class="op">=</span> np.array(forecasts_)</span>
<span id="cb98-469"><a href="#cb98-469" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-470"><a href="#cb98-470" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="va">self</span>.trend <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb98-471"><a href="#cb98-471" aria-hidden="true" tabindex="-1"></a>            forecasts <span class="op">+=</span> trend_forecast</span>
<span id="cb98-472"><a href="#cb98-472" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.forecast_ps <span class="op">+=</span> trend_forecast</span>
<span id="cb98-473"><a href="#cb98-473" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-474"><a href="#cb98-474" aria-hidden="true" tabindex="-1"></a>        <span class="co"># --- Revert seasonal differencing if applied ---</span></span>
<span id="cb98-475"><a href="#cb98-475" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="va">self</span>.season_diff <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb98-476"><a href="#cb98-476" aria-hidden="true" tabindex="-1"></a>            forecasts <span class="op">=</span> invert_seasonal_diff(<span class="va">self</span>.orig_d, forecasts, <span class="va">self</span>.season_diff)</span>
<span id="cb98-477"><a href="#cb98-477" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Also revert seasonal differencing for per state forecasts</span></span>
<span id="cb98-478"><a href="#cb98-478" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> s <span class="kw">in</span> <span class="bu">range</span>(<span class="va">self</span>.N):</span>
<span id="cb98-479"><a href="#cb98-479" aria-hidden="true" tabindex="-1"></a>                <span class="va">self</span>.forecast_ps[s] <span class="op">=</span> invert_seasonal_diff(<span class="va">self</span>.orig_d, <span class="va">self</span>.forecast_ps[s], <span class="va">self</span>.season_diff)</span>
<span id="cb98-480"><a href="#cb98-480" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-481"><a href="#cb98-481" aria-hidden="true" tabindex="-1"></a>        <span class="co"># --- Revert regular differencing if applied ---</span></span>
<span id="cb98-482"><a href="#cb98-482" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="va">self</span>.diff <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb98-483"><a href="#cb98-483" aria-hidden="true" tabindex="-1"></a>            forecasts <span class="op">=</span> undiff_ts(<span class="va">self</span>.orig, forecasts, <span class="va">self</span>.diff)</span>
<span id="cb98-484"><a href="#cb98-484" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Also revert differencing for per state forecasts</span></span>
<span id="cb98-485"><a href="#cb98-485" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> s <span class="kw">in</span> <span class="bu">range</span>(<span class="va">self</span>.N):</span>
<span id="cb98-486"><a href="#cb98-486" aria-hidden="true" tabindex="-1"></a>                <span class="va">self</span>.forecast_ps[s] <span class="op">=</span> undiff_ts(<span class="va">self</span>.orig, <span class="va">self</span>.forecast_ps[s], <span class="va">self</span>.diff)</span>
<span id="cb98-487"><a href="#cb98-487" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-488"><a href="#cb98-488" aria-hidden="true" tabindex="-1"></a>        <span class="co"># --- Box-Cox back-transform if applied ---</span></span>
<span id="cb98-489"><a href="#cb98-489" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="va">self</span>.box_cox:</span>
<span id="cb98-490"><a href="#cb98-490" aria-hidden="true" tabindex="-1"></a>            forecasts <span class="op">=</span> back_box_cox_transform(</span>
<span id="cb98-491"><a href="#cb98-491" aria-hidden="true" tabindex="-1"></a>                y_pred<span class="op">=</span>forecasts, lmda<span class="op">=</span><span class="va">self</span>.lamda,</span>
<span id="cb98-492"><a href="#cb98-492" aria-hidden="true" tabindex="-1"></a>                shift<span class="op">=</span><span class="va">self</span>.is_zero, box_cox_biasadj<span class="op">=</span><span class="va">self</span>.biasadj</span>
<span id="cb98-493"><a href="#cb98-493" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb98-494"><a href="#cb98-494" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> s <span class="kw">in</span> <span class="bu">range</span>(<span class="va">self</span>.N):</span>
<span id="cb98-495"><a href="#cb98-495" aria-hidden="true" tabindex="-1"></a>                <span class="va">self</span>.forecast_ps[s] <span class="op">=</span> back_box_cox_transform(</span>
<span id="cb98-496"><a href="#cb98-496" aria-hidden="true" tabindex="-1"></a>                    y_pred<span class="op">=</span><span class="va">self</span>.forecast_ps[s], lmda<span class="op">=</span><span class="va">self</span>.lamda,</span>
<span id="cb98-497"><a href="#cb98-497" aria-hidden="true" tabindex="-1"></a>                    shift<span class="op">=</span><span class="va">self</span>.is_zero, box_cox_biasadj<span class="op">=</span><span class="va">self</span>.biasadj</span>
<span id="cb98-498"><a href="#cb98-498" aria-hidden="true" tabindex="-1"></a>                )</span>
<span id="cb98-499"><a href="#cb98-499" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-500"><a href="#cb98-500" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> forecasts</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="ec380e4f" class="cell" data-execution_count="100">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb99"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a>k <span class="op">=</span> best_ward_ets_forecastk[<span class="st">'ward_0'</span>][<span class="dv">1</span>]</span>
<span id="cb99-2"><a href="#cb99-2" aria-hidden="true" tabindex="-1"></a>ets_paramshmm <span class="op">=</span> best_ward_ets_forecastk[<span class="st">'ward_0'</span>][<span class="dv">0</span>]</span>
<span id="cb99-3"><a href="#cb99-3" aria-hidden="true" tabindex="-1"></a>hmm_lags <span class="op">=</span> <span class="bu">sorted</span>(hmm_best_forward_lags[<span class="st">'ward_0'</span>][<span class="dv">0</span>][<span class="st">"best_lags"</span>])</span>
<span id="cb99-4"><a href="#cb99-4" aria-hidden="true" tabindex="-1"></a>s <span class="op">=</span> best_hmm_ets_tks[<span class="st">'ward_0'</span>][<span class="dv">2</span>]</span>
<span id="cb99-5"><a href="#cb99-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-6"><a href="#cb99-6" aria-hidden="true" tabindex="-1"></a>df_ <span class="op">=</span> data_prep_f(ward<span class="op">=</span><span class="st">'ward_0'</span>, fourier_k<span class="op">=</span>k)</span>
<span id="cb99-7"><a href="#cb99-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-8"><a href="#cb99-8" aria-hidden="true" tabindex="-1"></a>train_size <span class="op">=</span> <span class="bu">len</span>(occup_train_clean)</span>
<span id="cb99-9"><a href="#cb99-9" aria-hidden="true" tabindex="-1"></a>fit_df <span class="op">=</span> df_[:train_size] <span class="co"># fit on train data only to avoid data leakage</span></span>
<span id="cb99-10"><a href="#cb99-10" aria-hidden="true" tabindex="-1"></a>test_df <span class="op">=</span> df_[train_size:train_size<span class="op">+</span><span class="dv">30</span>]</span>
<span id="cb99-11"><a href="#cb99-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-12"><a href="#cb99-12" aria-hidden="true" tabindex="-1"></a>hm_model <span class="op">=</span> MsHmmRegression(n_components<span class="op">=</span>s, target_col<span class="op">=</span><span class="st">"ward_0"</span>, cat_variables<span class="op">=</span>cat_col_f, lags<span class="op">=</span>hmm_lags,</span>
<span id="cb99-13"><a href="#cb99-13" aria-hidden="true" tabindex="-1"></a>                    trend<span class="op">=</span><span class="st">"ets"</span>, ets_params<span class="op">=</span>ets_paramshmm, random_state<span class="op">=</span><span class="dv">42</span>, var_floor<span class="op">=</span><span class="fl">1e-1</span>,</span>
<span id="cb99-14"><a href="#cb99-14" aria-hidden="true" tabindex="-1"></a>                      n_iter<span class="op">=</span><span class="dv">300</span>, tol<span class="op">=</span><span class="fl">1e-3</span>)</span>
<span id="cb99-15"><a href="#cb99-15" aria-hidden="true" tabindex="-1"></a>hm_model.fit_em(fit_df)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="100">
<pre><code>np.float64(-2944.4438506327806)</code></pre>
</div>
</div>
<div id="3879e9af" class="cell" data-execution_count="85">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb101"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb101-1"><a href="#cb101-1" aria-hidden="true" tabindex="-1"></a>hmm_cross_validate(model<span class="op">=</span>hm_model, df<span class="op">=</span>df_, cv_split<span class="op">=</span><span class="dv">30</span>, test_size<span class="op">=</span><span class="dv">30</span>, step_size<span class="op">=</span><span class="dv">13</span>, n_iter<span class="op">=</span><span class="dv">100</span>, metrics<span class="op">=</span>[SRMSE, MAE, RMSE, MASE])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="85">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">eval_metric</th>
<th data-quarto-table-cell-role="th">score</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>SRMSE</td>
<td>0.270739</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>MAE</td>
<td>2.757161</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>RMSE</td>
<td>3.208337</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">3</th>
<td>MASE</td>
<td>3.311781</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div id="dfd699dc" class="cell" data-execution_count="101">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb102"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a>hmm_cross_validate(model<span class="op">=</span>hm_model, df<span class="op">=</span>df_, cv_split<span class="op">=</span><span class="dv">30</span>, test_size<span class="op">=</span><span class="dv">30</span>, step_size<span class="op">=</span><span class="dv">13</span>, n_iter<span class="op">=</span><span class="dv">100</span>, metrics<span class="op">=</span>[SRMSE, MAE, RMSE, MASE])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="101">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">eval_metric</th>
<th data-quarto-table-cell-role="th">score</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>SRMSE</td>
<td>0.271404</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>MAE</td>
<td>2.766366</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>RMSE</td>
<td>3.215240</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">3</th>
<td>MASE</td>
<td>3.323389</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div id="fb504e98" class="cell" data-execution_count="99">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb103"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a>hm_model.stds</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="99">
<pre><code>array([1.39380279, 0.1       ])</code></pre>
</div>
</div>
<div id="c848ae83" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb105"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb105-1"><a href="#cb105-1" aria-hidden="true" tabindex="-1"></a><span class="co"># perf_results = {"avg": [], "state_0": [], "state_1": []}</span></span>
<span id="cb105-2"><a href="#cb105-2" aria-hidden="true" tabindex="-1"></a><span class="co"># for i in range(1, 120):</span></span>
<span id="cb105-3"><a href="#cb105-3" aria-hidden="true" tabindex="-1"></a><span class="co">#     dft = df_[:train_size+i] # fit on train data only to avoid data leakage</span></span>
<span id="cb105-4"><a href="#cb105-4" aria-hidden="true" tabindex="-1"></a><span class="co">#     test_dft = df_[train_size+i:train_size+i+30]</span></span>
<span id="cb105-5"><a href="#cb105-5" aria-hidden="true" tabindex="-1"></a><span class="co">#     hm_model.fit(dft, n_iter=100)</span></span>
<span id="cb105-6"><a href="#cb105-6" aria-hidden="true" tabindex="-1"></a><span class="co">#     avg_forecast = hm_model.forecast(30, test_dft.drop(columns=["ward_0"]))</span></span>
<span id="cb105-7"><a href="#cb105-7" aria-hidden="true" tabindex="-1"></a><span class="co">#     s0_forecast = hm_model.forecast_ps[0]</span></span>
<span id="cb105-8"><a href="#cb105-8" aria-hidden="true" tabindex="-1"></a><span class="co">#     s1_forecast = hm_model.forecast_ps[1]</span></span>
<span id="cb105-9"><a href="#cb105-9" aria-hidden="true" tabindex="-1"></a><span class="co">#     SRMSE_avg = SRMSE(np.array(test_dft["ward_0"]), avg_forecast, np.array(dft["ward_0"]))</span></span>
<span id="cb105-10"><a href="#cb105-10" aria-hidden="true" tabindex="-1"></a><span class="co">#     SRMSE_s0 = SRMSE(np.array(test_dft["ward_0"]), s0_forecast, np.array(dft["ward_0"]))</span></span>
<span id="cb105-11"><a href="#cb105-11" aria-hidden="true" tabindex="-1"></a><span class="co">#     SRMSE_s1 = SRMSE(np.array(test_dft["ward_0"]), s1_forecast, np.array(dft["ward_0"]))</span></span>
<span id="cb105-12"><a href="#cb105-12" aria-hidden="true" tabindex="-1"></a><span class="co">#     perf_results["avg"].append(SRMSE_avg)</span></span>
<span id="cb105-13"><a href="#cb105-13" aria-hidden="true" tabindex="-1"></a><span class="co">#     perf_results["state_0"].append(SRMSE_s0)</span></span>
<span id="cb105-14"><a href="#cb105-14" aria-hidden="true" tabindex="-1"></a><span class="co">#     perf_results["state_1"].append(SRMSE_s1)</span></span>
<span id="cb105-15"><a href="#cb105-15" aria-hidden="true" tabindex="-1"></a><span class="co">#     # print(f"Completed rolling forecast and evaluation for rol {i}")</span></span>
<span id="cb105-16"><a href="#cb105-16" aria-hidden="true" tabindex="-1"></a><span class="co"># pd.DataFrame(perf_results).mean()</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="ef6f7fa4" class="cell" data-execution_count="77">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb106"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb106-1"><a href="#cb106-1" aria-hidden="true" tabindex="-1"></a><span class="co"># fit_df["ward_0"][-700:].hist(bins=15, figsize=(10, 5))</span></span>
<span id="cb106-2"><a href="#cb106-2" aria-hidden="true" tabindex="-1"></a><span class="co"># plt.title("Distribution of ward_0 occupancy - last 700 days in training data")</span></span>
<span id="cb106-3"><a href="#cb106-3" aria-hidden="true" tabindex="-1"></a><span class="co"># plt.xlabel("Occupancy")</span></span>
<span id="cb106-4"><a href="#cb106-4" aria-hidden="true" tabindex="-1"></a><span class="co"># plt.ylabel("Frequency")</span></span>
<span id="cb106-5"><a href="#cb106-5" aria-hidden="true" tabindex="-1"></a><span class="co"># plt.show()</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="1e1135e7" class="cell" data-execution_count="36">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb107"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb107-1"><a href="#cb107-1" aria-hidden="true" tabindex="-1"></a><span class="co"># with open('quarto_result/ward_0_hmm_model.pkl', 'wb') as f:</span></span>
<span id="cb107-2"><a href="#cb107-2" aria-hidden="true" tabindex="-1"></a><span class="co">#     pickle.dump(ward_0_hmm_model, f)</span></span>
<span id="cb107-3"><a href="#cb107-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-4"><a href="#cb107-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Load from file</span></span>
<span id="cb107-5"><a href="#cb107-5" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(<span class="st">'quarto_result/ward_0_hmm_model.pkl'</span>, <span class="st">'rb'</span>) <span class="im">as</span> f:</span>
<span id="cb107-6"><a href="#cb107-6" aria-hidden="true" tabindex="-1"></a>    ward_0_hmm_model <span class="op">=</span> pickle.load(f)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="a8851879" class="cell" data-execution_count="31">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb108"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb108-1"><a href="#cb108-1" aria-hidden="true" tabindex="-1"></a>tp <span class="op">=</span> pd.DataFrame(hm_model.A).<span class="bu">round</span>(<span class="dv">3</span>)</span>
<span id="cb108-2"><a href="#cb108-2" aria-hidden="true" tabindex="-1"></a>tp.index <span class="op">=</span> [<span class="ss">f"State </span><span class="sc">{</span>i<span class="op">+</span><span class="dv">1</span><span class="sc">}</span><span class="ss">"</span> <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(tp.shape[<span class="dv">0</span>])]</span>
<span id="cb108-3"><a href="#cb108-3" aria-hidden="true" tabindex="-1"></a>tp.columns <span class="op">=</span> [<span class="ss">f"State </span><span class="sc">{</span>i<span class="op">+</span><span class="dv">1</span><span class="sc">}</span><span class="ss">"</span> <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(tp.shape[<span class="dv">1</span>])]</span>
<span id="cb108-4"><a href="#cb108-4" aria-hidden="true" tabindex="-1"></a>tp</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="31">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">State 1</th>
<th data-quarto-table-cell-role="th">State 2</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">State 1</th>
<td>0.666</td>
<td>0.334</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">State 2</th>
<td>0.487</td>
<td>0.513</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div id="ce83a196" class="cell" data-execution_count="34">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb109"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb109-1"><a href="#cb109-1" aria-hidden="true" tabindex="-1"></a>tp.reset_index()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="34">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">index</th>
<th data-quarto-table-cell-role="th">State 1</th>
<th data-quarto-table-cell-role="th">State 2</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>State 1</td>
<td>0.666</td>
<td>0.334</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>State 2</td>
<td>0.487</td>
<td>0.513</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div id="6ad9817f" class="cell" data-execution_count="56">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb110"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb110-1"><a href="#cb110-1" aria-hidden="true" tabindex="-1"></a>stds <span class="op">=</span> pd.DataFrame(hm_model.stds).<span class="bu">round</span>(<span class="dv">2</span>).T</span>
<span id="cb110-2"><a href="#cb110-2" aria-hidden="true" tabindex="-1"></a><span class="co"># change row name to standard deviation</span></span>
<span id="cb110-3"><a href="#cb110-3" aria-hidden="true" tabindex="-1"></a>stds <span class="op">=</span> stds.rename(index<span class="op">=</span>{<span class="dv">0</span>: <span class="st">"standard deviations"</span>})</span>
<span id="cb110-4"><a href="#cb110-4" aria-hidden="true" tabindex="-1"></a>stds.columns <span class="op">=</span> [<span class="st">"State 0"</span>, <span class="st">"State 1"</span>]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="b4584d76" class="cell" data-execution_count="30">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb111"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb111-1"><a href="#cb111-1" aria-hidden="true" tabindex="-1"></a>stds</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-error">
<div class="ansi-escaped-output">
<pre><span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">NameError</span>                                 Traceback (most recent call last)
<span class="ansi-cyan-fg">Cell</span><span class="ansi-cyan-fg"> </span><span class="ansi-green-fg">In[30]</span><span class="ansi-green-fg">, line 1</span>
<span class="ansi-green-fg">----&gt; </span><span class="ansi-green-fg">1</span> <span class="ansi-yellow-bg">stds</span>

<span class="ansi-red-fg">NameError</span>: name 'stds' is not defined</pre>
</div>
</div>
</div>
<div id="7b73a4f4" class="cell" data-execution_count="40">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb112"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb112-1"><a href="#cb112-1" aria-hidden="true" tabindex="-1"></a>state_probs_train <span class="op">=</span> hm_model.predict_proba()</span>
<span id="cb112-2"><a href="#cb112-2" aria-hidden="true" tabindex="-1"></a>state_predict_train <span class="op">=</span> hm_model.predict_states()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="8fe931fa" class="cell" data-execution_count="60">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb113"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb113-1"><a href="#cb113-1" aria-hidden="true" tabindex="-1"></a>pd.Series(state_predict_train[<span class="op">-</span><span class="dv">365</span>:]).value_counts(normalize<span class="op">=</span><span class="va">True</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="60">
<pre><code>0    0.578082
1    0.421918
Name: proportion, dtype: float64</code></pre>
</div>
</div>
<div id="4201c9b2" class="cell" data-execution_count="63">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb115"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb115-1"><a href="#cb115-1" aria-hidden="true" tabindex="-1"></a>state_predict_train[<span class="op">-</span><span class="dv">10</span>:]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="63">
<pre><code>array([0, 1, 0, 1, 0, 1, 1, 1, 0, 1])</code></pre>
</div>
</div>
<div id="8fe9e094" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb117"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb117-1"><a href="#cb117-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load from file</span></span>
<span id="cb117-2"><a href="#cb117-2" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(<span class="st">'quarto_result/ward_0_hmm_model.pkl'</span>, <span class="st">'rb'</span>) <span class="im">as</span> f:</span>
<span id="cb117-3"><a href="#cb117-3" aria-hidden="true" tabindex="-1"></a>    ward_0_hmm_model <span class="op">=</span> pickle.load(f)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="7f8ee40c" class="cell" data-execution_count="36">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb118"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb118-1"><a href="#cb118-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb118-2"><a href="#cb118-2" aria-hidden="true" tabindex="-1"></a>my_series <span class="op">=</span> fit_df[<span class="op">-</span><span class="dv">2074</span>:][<span class="st">"ward_0"</span>]</span>
<span id="cb118-3"><a href="#cb118-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-4"><a href="#cb118-4" aria-hidden="true" tabindex="-1"></a>fig, ax1 <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">14</span>, <span class="dv">6</span>))</span>
<span id="cb118-5"><a href="#cb118-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-6"><a href="#cb118-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the time series</span></span>
<span id="cb118-7"><a href="#cb118-7" aria-hidden="true" tabindex="-1"></a>ax1.plot(my_series.index[<span class="op">-</span><span class="dv">60</span>:], my_series.values[<span class="op">-</span><span class="dv">60</span>:], label<span class="op">=</span><span class="st">"Occupancy"</span>, color<span class="op">=</span><span class="st">"C0"</span>)</span>
<span id="cb118-8"><a href="#cb118-8" aria-hidden="true" tabindex="-1"></a><span class="co"># ax1.plot(fit_df.index, fit_df["forecast"], label="Occupancy", color="C3", linestyle='--')</span></span>
<span id="cb118-9"><a href="#cb118-9" aria-hidden="true" tabindex="-1"></a><span class="co"># ax1.plot(vis_data.index, vis_data["Discharges"], label="Discharges", color="C1")</span></span>
<span id="cb118-10"><a href="#cb118-10" aria-hidden="true" tabindex="-1"></a>ax1.set_ylabel(<span class="st">"Occupancy level"</span>)</span>
<span id="cb118-11"><a href="#cb118-11" aria-hidden="true" tabindex="-1"></a>ax1.set_xlabel(<span class="st">"Date"</span>)</span>
<span id="cb118-12"><a href="#cb118-12" aria-hidden="true" tabindex="-1"></a>ax1.legend(loc<span class="op">=</span><span class="st">"upper left"</span>)</span>
<span id="cb118-13"><a href="#cb118-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-14"><a href="#cb118-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Overlay probabilities as stacked area</span></span>
<span id="cb118-15"><a href="#cb118-15" aria-hidden="true" tabindex="-1"></a>ax2 <span class="op">=</span> ax1.twinx()</span>
<span id="cb118-16"><a href="#cb118-16" aria-hidden="true" tabindex="-1"></a>ax2.stackplot(my_series.index[<span class="op">-</span><span class="dv">60</span>:],</span>
<span id="cb118-17"><a href="#cb118-17" aria-hidden="true" tabindex="-1"></a>              state_probs_train[<span class="dv">0</span>][<span class="op">-</span><span class="dv">60</span>:], </span>
<span id="cb118-18"><a href="#cb118-18" aria-hidden="true" tabindex="-1"></a>              state_probs_train[<span class="dv">1</span>][<span class="op">-</span><span class="dv">60</span>:],</span>
<span id="cb118-19"><a href="#cb118-19" aria-hidden="true" tabindex="-1"></a>              labels<span class="op">=</span>[<span class="st">'State 0'</span>, <span class="st">'State 1'</span>, <span class="st">'State 2'</span>], </span>
<span id="cb118-20"><a href="#cb118-20" aria-hidden="true" tabindex="-1"></a>              alpha<span class="op">=</span><span class="fl">0.25</span>, colors<span class="op">=</span>[<span class="st">'C2'</span>,<span class="st">'C3'</span>, <span class="st">'C4'</span>])</span>
<span id="cb118-21"><a href="#cb118-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-22"><a href="#cb118-22" aria-hidden="true" tabindex="-1"></a>ax2.set_ylabel(<span class="st">"State Probability"</span>)</span>
<span id="cb118-23"><a href="#cb118-23" aria-hidden="true" tabindex="-1"></a>ax2.set_ylim(<span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb118-24"><a href="#cb118-24" aria-hidden="true" tabindex="-1"></a>ax2.legend(loc<span class="op">=</span><span class="st">"upper right"</span>)</span>
<span id="cb118-25"><a href="#cb118-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-26"><a href="#cb118-26" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Occupancy with Hidden State Probabilities"</span>)</span>
<span id="cb118-27"><a href="#cb118-27" aria-hidden="true" tabindex="-1"></a>plt.setp(ax1.get_xticklabels(), rotation<span class="op">=</span><span class="dv">30</span>, ha<span class="op">=</span><span class="st">"right"</span>)  <span class="co"># &lt;--- Add this line</span></span>
<span id="cb118-28"><a href="#cb118-28" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="occupancy_nb_files/figure-html/cell-102-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="901293c3" class="cell" data-execution_count="37">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb119"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb119-1"><a href="#cb119-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load from file</span></span>
<span id="cb119-2"><a href="#cb119-2" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(<span class="st">'results/hmm_conforms.pkl'</span>, <span class="st">'rb'</span>) <span class="im">as</span> f:</span>
<span id="cb119-3"><a href="#cb119-3" aria-hidden="true" tabindex="-1"></a>    hmm_conforms <span class="op">=</span> pickle.load(f)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="99f63ff4" class="cell" data-execution_count="39">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb120"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb120-1"><a href="#cb120-1" aria-hidden="true" tabindex="-1"></a>df_ <span class="op">=</span> data_prep_f(<span class="st">'ward_0'</span>, best_hmm_ets_tks[<span class="st">"ward_0"</span>][<span class="dv">1</span>])</span>
<span id="cb120-2"><a href="#cb120-2" aria-hidden="true" tabindex="-1"></a>dfml <span class="op">=</span> data_prep(<span class="st">'ward_0'</span>)</span>
<span id="cb120-3"><a href="#cb120-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb120-4"><a href="#cb120-4" aria-hidden="true" tabindex="-1"></a>train_size <span class="op">=</span> <span class="bu">len</span>(occup_train_clean)</span>
<span id="cb120-5"><a href="#cb120-5" aria-hidden="true" tabindex="-1"></a>train_df <span class="op">=</span> df_[:train_size] <span class="co"># fit on train data only to avoid data leakage</span></span>
<span id="cb120-6"><a href="#cb120-6" aria-hidden="true" tabindex="-1"></a>test_df <span class="op">=</span> df_[train_size:train_size<span class="op">+</span><span class="dv">30</span>]</span>
<span id="cb120-7"><a href="#cb120-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb120-8"><a href="#cb120-8" aria-hidden="true" tabindex="-1"></a>train_dfml <span class="op">=</span> dfml[:train_size] <span class="co"># fit on train data only to avoid data leakage</span></span>
<span id="cb120-9"><a href="#cb120-9" aria-hidden="true" tabindex="-1"></a>test_dfml <span class="op">=</span> dfml[train_size:train_size<span class="op">+</span><span class="dv">30</span>]</span>
<span id="cb120-10"><a href="#cb120-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb120-11"><a href="#cb120-11" aria-hidden="true" tabindex="-1"></a>pi_hmm <span class="op">=</span> hmm_conforms[<span class="st">"ward_0"</span>].generate_prediction_intervals(train_df, test_df.drop(columns<span class="op">=</span>[<span class="st">"ward_0"</span>]))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="1770081e" class="cell" data-execution_count="40">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb121"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb121-1"><a href="#cb121-1" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">6</span>))</span>
<span id="cb121-2"><a href="#cb121-2" aria-hidden="true" tabindex="-1"></a>hmm_conforms[<span class="st">"ward_0"</span>].dist[[<span class="st">'h_1'</span>, <span class="st">'h_5'</span>, <span class="st">'h_10'</span>, <span class="st">'h_15'</span>, <span class="st">'h_30'</span>]].boxplot()</span>
<span id="cb121-3"><a href="#cb121-3" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Forecast Distribution for ward_0 HMM"</span>)</span>
<span id="cb121-4"><a href="#cb121-4" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Value"</span>)</span>
<span id="cb121-5"><a href="#cb121-5" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="occupancy_nb_files/figure-html/cell-105-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="9622d91a" class="cell" data-execution_count="47">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb122"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb122-1"><a href="#cb122-1" aria-hidden="true" tabindex="-1"></a>conf_cols <span class="op">=</span>[hmm_conforms[<span class="st">"ward_0"</span>].dist.columns[<span class="op">-</span>i] <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, <span class="dv">31</span>)]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="d9875306" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb123"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb123-1"><a href="#cb123-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> joypy <span class="im">import</span> joyplot</span>
<span id="cb123-2"><a href="#cb123-2" aria-hidden="true" tabindex="-1"></a>dfj <span class="op">=</span> hmm_conforms[<span class="st">"ward_0"</span>].dist</span>
<span id="cb123-3"><a href="#cb123-3" aria-hidden="true" tabindex="-1"></a>conf_cols <span class="op">=</span>[hmm_conforms[<span class="st">"ward_0"</span>].dist.columns[<span class="op">-</span>i] <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, <span class="dv">31</span>)]</span>
<span id="cb123-4"><a href="#cb123-4" aria-hidden="true" tabindex="-1"></a>joyplot(</span>
<span id="cb123-5"><a href="#cb123-5" aria-hidden="true" tabindex="-1"></a>    data<span class="op">=</span>dfj, </span>
<span id="cb123-6"><a href="#cb123-6" aria-hidden="true" tabindex="-1"></a>    column<span class="op">=</span>conf_cols,  <span class="co"># columns to plot</span></span>
<span id="cb123-7"><a href="#cb123-7" aria-hidden="true" tabindex="-1"></a>    overlap<span class="op">=</span><span class="fl">0.6</span>,  <span class="co"># overlap between plots</span></span>
<span id="cb123-8"><a href="#cb123-8" aria-hidden="true" tabindex="-1"></a>    figsize<span class="op">=</span>(<span class="dv">13</span>, <span class="dv">10</span>),</span>
<span id="cb123-9"><a href="#cb123-9" aria-hidden="true" tabindex="-1"></a>    fade <span class="op">=</span> <span class="va">True</span>,</span>
<span id="cb123-10"><a href="#cb123-10" aria-hidden="true" tabindex="-1"></a>    linecolor <span class="op">=</span> <span class="st">"white"</span></span>
<span id="cb123-11"><a href="#cb123-11" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb123-12"><a href="#cb123-12" aria-hidden="true" tabindex="-1"></a>plt.yticks(fontsize<span class="op">=</span><span class="dv">8</span>)</span>
<span id="cb123-13"><a href="#cb123-13" aria-hidden="true" tabindex="-1"></a>plt.xticks(fontsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb123-14"><a href="#cb123-14" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Forecast Distribution for ward_0 HMM"</span>, fontsize<span class="op">=</span><span class="dv">20</span>)</span>
<span id="cb123-15"><a href="#cb123-15" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Forecast Value"</span>)</span>
<span id="cb123-16"><a href="#cb123-16" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Horizon"</span>)</span>
<span id="cb123-17"><a href="#cb123-17" aria-hidden="true" tabindex="-1"></a>plt.show()<span class="op">;</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="occupancy_nb_files/figure-html/cell-107-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="6c76a4ed" class="cell" data-execution_count="82">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb124"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb124-1"><a href="#cb124-1" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">22</span>, <span class="dv">11</span>))</span>
<span id="cb124-2"><a href="#cb124-2" aria-hidden="true" tabindex="-1"></a>palette <span class="op">=</span> sns.color_palette(<span class="st">"Blues_r"</span>, n_colors<span class="op">=</span><span class="bu">len</span>(hmm_conforms[<span class="st">"ward_0"</span>].dist.columns))</span>
<span id="cb124-3"><a href="#cb124-3" aria-hidden="true" tabindex="-1"></a>sns.swarmplot(data<span class="op">=</span>hmm_conforms[<span class="st">"ward_0"</span>].dist, color <span class="op">=</span> <span class="st">"C0"</span>)</span>
<span id="cb124-4"><a href="#cb124-4" aria-hidden="true" tabindex="-1"></a>plt.xticks(rotation<span class="op">=</span><span class="dv">90</span>, fontsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb124-5"><a href="#cb124-5" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Forecast Distribution for ward_0 HMM"</span>)</span>
<span id="cb124-6"><a href="#cb124-6" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Value"</span>)</span>
<span id="cb124-7"><a href="#cb124-7" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="occupancy_nb_files/figure-html/cell-108-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="75e96413" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb125"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb125-1"><a href="#cb125-1" aria-hidden="true" tabindex="-1"></a>train_size <span class="op">=</span> <span class="bu">len</span>(occup_train_clean)</span>
<span id="cb125-2"><a href="#cb125-2" aria-hidden="true" tabindex="-1"></a>occup_test</span>
<span id="cb125-3"><a href="#cb125-3" aria-hidden="true" tabindex="-1"></a>forecasts <span class="op">=</span> []</span>
<span id="cb125-4"><a href="#cb125-4" aria-hidden="true" tabindex="-1"></a>state_probs_list <span class="op">=</span> []</span>
<span id="cb125-5"><a href="#cb125-5" aria-hidden="true" tabindex="-1"></a>state_forecasts <span class="op">=</span> []</span>
<span id="cb125-6"><a href="#cb125-6" aria-hidden="true" tabindex="-1"></a>fit_df <span class="op">=</span> df_[:train_size]</span>
<span id="cb125-7"><a href="#cb125-7" aria-hidden="true" tabindex="-1"></a>test_target <span class="op">=</span> df_[<span class="st">"ward_0"</span>][train_size:].to_frame()</span>
<span id="cb125-8"><a href="#cb125-8" aria-hidden="true" tabindex="-1"></a>test_df <span class="op">=</span> df_[train_size:train_size<span class="op">+</span><span class="dv">30</span>].drop(columns<span class="op">=</span>[<span class="st">"ward_0"</span>])</span>
<span id="cb125-9"><a href="#cb125-9" aria-hidden="true" tabindex="-1"></a>hm_model.fit(fit_df, n_iter<span class="op">=</span><span class="dv">100</span>)</span>
<span id="cb125-10"><a href="#cb125-10" aria-hidden="true" tabindex="-1"></a>y_forecast <span class="op">=</span> hm_model.forecast(<span class="dv">30</span>, test_df).tolist()</span>
<span id="cb125-11"><a href="#cb125-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-12"><a href="#cb125-12" aria-hidden="true" tabindex="-1"></a>forecasts.extend(y_forecast)</span>
<span id="cb125-13"><a href="#cb125-13" aria-hidden="true" tabindex="-1"></a>state_seq <span class="op">=</span> hm_model.state_forecasts.tolist()</span>
<span id="cb125-14"><a href="#cb125-14" aria-hidden="true" tabindex="-1"></a>state_forecasts.extend(state_seq)</span>
<span id="cb125-15"><a href="#cb125-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-16"><a href="#cb125-16" aria-hidden="true" tabindex="-1"></a>log_alpha <span class="op">=</span> hm_model.forecast_forward</span>
<span id="cb125-17"><a href="#cb125-17" aria-hidden="true" tabindex="-1"></a>state_probs_list.append(log_alpha)</span>
<span id="cb125-18"><a href="#cb125-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-19"><a href="#cb125-19" aria-hidden="true" tabindex="-1"></a>H <span class="op">=</span> <span class="dv">30</span></span>
<span id="cb125-20"><a href="#cb125-20" aria-hidden="true" tabindex="-1"></a>train_size <span class="op">+=</span> H</span>
<span id="cb125-21"><a href="#cb125-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-22"><a href="#cb125-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-23"><a href="#cb125-23" aria-hidden="true" tabindex="-1"></a><span class="cf">while</span> train_size <span class="op">&lt;</span> <span class="bu">len</span>(df_):</span>
<span id="cb125-24"><a href="#cb125-24" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Prepare fit (training) data</span></span>
<span id="cb125-25"><a href="#cb125-25" aria-hidden="true" tabindex="-1"></a>    fit_df <span class="op">=</span> df_[:train_size]</span>
<span id="cb125-26"><a href="#cb125-26" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb125-27"><a href="#cb125-27" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Determine test (forecast) window, handle edge case for final window</span></span>
<span id="cb125-28"><a href="#cb125-28" aria-hidden="true" tabindex="-1"></a>    end_idx <span class="op">=</span> <span class="bu">min</span>(train_size <span class="op">+</span> H, <span class="bu">len</span>(df_))</span>
<span id="cb125-29"><a href="#cb125-29" aria-hidden="true" tabindex="-1"></a>    test_df <span class="op">=</span> df_[train_size:end_idx].drop(columns<span class="op">=</span>[<span class="st">"ward_0"</span>])</span>
<span id="cb125-30"><a href="#cb125-30" aria-hidden="true" tabindex="-1"></a>    current_H <span class="op">=</span> end_idx <span class="op">-</span> train_size  <span class="co"># May be less than 30 at the end</span></span>
<span id="cb125-31"><a href="#cb125-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-32"><a href="#cb125-32" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Fit and forecast</span></span>
<span id="cb125-33"><a href="#cb125-33" aria-hidden="true" tabindex="-1"></a>    hm_model.fit(fit_df, n_iter<span class="op">=</span><span class="dv">100</span>)</span>
<span id="cb125-34"><a href="#cb125-34" aria-hidden="true" tabindex="-1"></a>    y_forecast <span class="op">=</span> hm_model.forecast(current_H, test_df).tolist()</span>
<span id="cb125-35"><a href="#cb125-35" aria-hidden="true" tabindex="-1"></a>    forecasts.extend(y_forecast)</span>
<span id="cb125-36"><a href="#cb125-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-37"><a href="#cb125-37" aria-hidden="true" tabindex="-1"></a>    state_seq <span class="op">=</span> hm_model.state_forecasts.tolist()</span>
<span id="cb125-38"><a href="#cb125-38" aria-hidden="true" tabindex="-1"></a>    state_forecasts.extend(state_seq)</span>
<span id="cb125-39"><a href="#cb125-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-40"><a href="#cb125-40" aria-hidden="true" tabindex="-1"></a>    log_alpha <span class="op">=</span> hm_model.forecast_forward</span>
<span id="cb125-41"><a href="#cb125-41" aria-hidden="true" tabindex="-1"></a>    state_probs_list.append(log_alpha)</span>
<span id="cb125-42"><a href="#cb125-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-43"><a href="#cb125-43" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Advance the training window</span></span>
<span id="cb125-44"><a href="#cb125-44" aria-hidden="true" tabindex="-1"></a>    train_size <span class="op">+=</span> H</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="8ef5cb4a" class="cell" data-execution_count="89">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb126"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb126-1"><a href="#cb126-1" aria-hidden="true" tabindex="-1"></a>state_probs <span class="op">=</span> np.concatenate(state_probs_list, axis<span class="op">=</span><span class="dv">1</span>) </span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="e6db248e" class="cell" data-execution_count="39">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb127"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb127-1"><a href="#cb127-1" aria-hidden="true" tabindex="-1"></a>point <span class="op">=</span> hm_model.forecast(<span class="dv">30</span>, test_df.drop(columns<span class="op">=</span>[<span class="st">"ward_0"</span>]))</span>
<span id="cb127-2"><a href="#cb127-2" aria-hidden="true" tabindex="-1"></a>hm_model.forecast_ps[<span class="dv">0</span>]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="39">
<pre><code>array([12.7747301 , 12.42390154, 12.08441653, 11.58121551, 11.28040762,
       11.91556   , 12.42665751, 11.88207655, 11.81470847, 11.49832214,
       11.24935295, 11.02136809, 11.65642169, 12.26621221, 11.68740357,
       11.4643657 , 11.30317984, 10.82195942, 10.74693816, 11.26028151,
       11.95867959, 11.31297098, 11.05599206, 11.20779446, 10.7636878 ,
       10.47003598, 11.21341562, 11.64605447, 11.04578202, 10.8698587 ])</code></pre>
</div>
</div>
<div id="894519e0" class="cell" data-execution_count="42">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb129"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb129-1"><a href="#cb129-1" aria-hidden="true" tabindex="-1"></a>fs <span class="op">=</span> hm_model.forecast_forward</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="82dde3f0" class="cell" data-execution_count="45">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb130"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb130-1"><a href="#cb130-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb130-2"><a href="#cb130-2" aria-hidden="true" tabindex="-1"></a>my_series <span class="op">=</span> test_df[<span class="st">"ward_0"</span>]</span>
<span id="cb130-3"><a href="#cb130-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-4"><a href="#cb130-4" aria-hidden="true" tabindex="-1"></a>fig, ax1 <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">14</span>, <span class="dv">6</span>))</span>
<span id="cb130-5"><a href="#cb130-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-6"><a href="#cb130-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the time series</span></span>
<span id="cb130-7"><a href="#cb130-7" aria-hidden="true" tabindex="-1"></a>ax1.plot(test_df.index, my_series.values, label<span class="op">=</span><span class="st">"Occupancy"</span>, color<span class="op">=</span><span class="st">"C0"</span>)</span>
<span id="cb130-8"><a href="#cb130-8" aria-hidden="true" tabindex="-1"></a>ax1.plot(test_df.index, point, label<span class="op">=</span><span class="st">"mean"</span>, color<span class="op">=</span><span class="st">"C1"</span>, linestyle<span class="op">=</span><span class="st">'--'</span>)</span>
<span id="cb130-9"><a href="#cb130-9" aria-hidden="true" tabindex="-1"></a>ax1.plot(test_df.index, hm_model.forecast_ps[<span class="dv">0</span>], label<span class="op">=</span><span class="st">"forecast_s0"</span>, color<span class="op">=</span><span class="st">"C2"</span>, linestyle<span class="op">=</span><span class="st">'--'</span>)</span>
<span id="cb130-10"><a href="#cb130-10" aria-hidden="true" tabindex="-1"></a>ax1.plot(test_df.index, hm_model.forecast_ps[<span class="dv">1</span>], label<span class="op">=</span><span class="st">"forecast_s1"</span>, color<span class="op">=</span><span class="st">"C3"</span>, linestyle<span class="op">=</span><span class="st">'--'</span>)</span>
<span id="cb130-11"><a href="#cb130-11" aria-hidden="true" tabindex="-1"></a><span class="co"># ax1.plot(vis_data.index, vis_data["Discharges"], label="Discharges", color="C1")</span></span>
<span id="cb130-12"><a href="#cb130-12" aria-hidden="true" tabindex="-1"></a>ax1.set_ylabel(<span class="st">"Occupancy"</span>)</span>
<span id="cb130-13"><a href="#cb130-13" aria-hidden="true" tabindex="-1"></a>ax1.set_xlabel(<span class="st">"Date"</span>)</span>
<span id="cb130-14"><a href="#cb130-14" aria-hidden="true" tabindex="-1"></a>ax1.legend(loc<span class="op">=</span><span class="st">"upper left"</span>)</span>
<span id="cb130-15"><a href="#cb130-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-16"><a href="#cb130-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Overlay probabilities as stacked area</span></span>
<span id="cb130-17"><a href="#cb130-17" aria-hidden="true" tabindex="-1"></a>ax2 <span class="op">=</span> ax1.twinx()</span>
<span id="cb130-18"><a href="#cb130-18" aria-hidden="true" tabindex="-1"></a>ax2.stackplot(my_series.index,</span>
<span id="cb130-19"><a href="#cb130-19" aria-hidden="true" tabindex="-1"></a>              fs[<span class="dv">0</span>], </span>
<span id="cb130-20"><a href="#cb130-20" aria-hidden="true" tabindex="-1"></a>              fs[<span class="dv">1</span>],</span>
<span id="cb130-21"><a href="#cb130-21" aria-hidden="true" tabindex="-1"></a>              labels<span class="op">=</span>[<span class="st">'State 0'</span>, <span class="st">'State 1'</span>], </span>
<span id="cb130-22"><a href="#cb130-22" aria-hidden="true" tabindex="-1"></a>              alpha<span class="op">=</span><span class="fl">0.25</span>, colors<span class="op">=</span>[<span class="st">'C4'</span>,<span class="st">'C5'</span>])</span>
<span id="cb130-23"><a href="#cb130-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-24"><a href="#cb130-24" aria-hidden="true" tabindex="-1"></a>ax2.set_ylabel(<span class="st">"State Probability"</span>)</span>
<span id="cb130-25"><a href="#cb130-25" aria-hidden="true" tabindex="-1"></a>ax2.set_ylim(<span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb130-26"><a href="#cb130-26" aria-hidden="true" tabindex="-1"></a>ax2.legend(loc<span class="op">=</span><span class="st">"upper right"</span>)</span>
<span id="cb130-27"><a href="#cb130-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-28"><a href="#cb130-28" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"occupancy with Hidden State Probabilities"</span>)</span>
<span id="cb130-29"><a href="#cb130-29" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="occupancy_nb_files/figure-html/cell-113-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="905cf03d" class="cell" data-execution_count="99">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb131"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb131-1"><a href="#cb131-1" aria-hidden="true" tabindex="-1"></a>test_target[<span class="st">"forecast"</span>] <span class="op">=</span> forecasts</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="0e8a300b" class="cell" data-execution_count="98">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb132"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb132-1"><a href="#cb132-1" aria-hidden="true" tabindex="-1"></a>test_target</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="98">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">ward_0</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">Date</th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">2024-04-30</th>
<td>14.0</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">2024-05-01</th>
<td>12.0</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2024-05-02</th>
<td>11.0</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">2024-05-03</th>
<td>11.0</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2024-05-04</th>
<td>11.0</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">...</th>
<td>...</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2025-04-20</th>
<td>19.0</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">2025-04-21</th>
<td>20.0</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2025-04-22</th>
<td>18.0</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">2025-04-23</th>
<td>18.0</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2025-04-24</th>
<td>18.0</td>
</tr>
</tbody>
</table>

<p>360 rows × 1 columns</p>
</div>
</div>
</div>
<div id="f8e57da2" class="cell" data-execution_count="80">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb133"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb133-1"><a href="#cb133-1" aria-hidden="true" tabindex="-1"></a>test_target.plot(figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">6</span>))</span>
<span id="cb133-2"><a href="#cb133-2" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"HMM Forecast vs Actual for ward_0"</span>)</span>
<span id="cb133-3"><a href="#cb133-3" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Date"</span>)</span>
<span id="cb133-4"><a href="#cb133-4" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Occupancy"</span>)</span>
<span id="cb133-5"><a href="#cb133-5" aria-hidden="true" tabindex="-1"></a>plt.legend([<span class="st">"Actual"</span>, <span class="st">"HMM Forecast"</span>])</span>
<span id="cb133-6"><a href="#cb133-6" aria-hidden="true" tabindex="-1"></a>plt.show()  </span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="occupancy_nb_files/figure-html/cell-116-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="5214978d" class="cell" data-execution_count="82">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb134"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb134-1"><a href="#cb134-1" aria-hidden="true" tabindex="-1"></a>test_target.mean()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="82">
<pre><code>ward_0      16.041667
forecast    15.542527
dtype: float64</code></pre>
</div>
</div>
</section>
<section id="decomposition" class="level2">
<h2 class="anchored" data-anchor-id="decomposition">Decomposition</h2>
<div id="305e5ad9" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb136"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb136-1"><a href="#cb136-1" aria-hidden="true" tabindex="-1"></a>occup_train_clean</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="3fbac5ce" class="cell" data-execution_count="35">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb137"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb137-1"><a href="#cb137-1" aria-hidden="true" tabindex="-1"></a>decomposition <span class="op">=</span> MSTL(occup_train_clean[<span class="st">"ward_1"</span>], periods<span class="op">=</span>[<span class="dv">7</span>, <span class="dv">365</span>]).fit()  <span class="co"># 7=day, 365=year</span></span>
<span id="cb137-2"><a href="#cb137-2" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">5</span>, <span class="dv">1</span>, figsize<span class="op">=</span>(<span class="dv">30</span>, <span class="dv">20</span>))</span>
<span id="cb137-3"><a href="#cb137-3" aria-hidden="true" tabindex="-1"></a>decomposition.resid[<span class="st">'2024'</span>:].plot(title<span class="op">=</span><span class="st">'Residuals of MSTL Decomposition for ward_0'</span>, ax<span class="op">=</span>ax[<span class="dv">0</span>])</span>
<span id="cb137-4"><a href="#cb137-4" aria-hidden="true" tabindex="-1"></a>decomposition.trend[<span class="st">'2024'</span>:].plot(title<span class="op">=</span><span class="st">'Trend of MSTL Decomposition for ward_0'</span>, ax<span class="op">=</span>ax[<span class="dv">1</span>])</span>
<span id="cb137-5"><a href="#cb137-5" aria-hidden="true" tabindex="-1"></a>decomposition.seasonal[<span class="st">'2024'</span>:].iloc[:, <span class="dv">0</span>].plot(title<span class="op">=</span><span class="st">'Seasonal 1 of MSTL Decomposition for ward_0'</span>, ax<span class="op">=</span>ax[<span class="dv">2</span>])</span>
<span id="cb137-6"><a href="#cb137-6" aria-hidden="true" tabindex="-1"></a>decomposition.seasonal[<span class="st">'2024'</span>:].iloc[:, <span class="dv">1</span>].plot(title<span class="op">=</span><span class="st">'Seasonal 2 of MSTL Decomposition for ward_0'</span>, ax<span class="op">=</span>ax[<span class="dv">3</span>])</span>
<span id="cb137-7"><a href="#cb137-7" aria-hidden="true" tabindex="-1"></a>decomposition.observed[<span class="st">'2024'</span>:].plot(title<span class="op">=</span><span class="st">'Observed of MSTL Decomposition for ward_0'</span>, ax<span class="op">=</span>ax[<span class="dv">4</span>])</span>
<span id="cb137-8"><a href="#cb137-8" aria-hidden="true" tabindex="-1"></a><span class="co"># increase distance between subplots</span></span>
<span id="cb137-9"><a href="#cb137-9" aria-hidden="true" tabindex="-1"></a>plt.subplots_adjust(hspace<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb137-10"><a href="#cb137-10" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="occupancy_nb_files/figure-html/cell-119-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/mustafaslanCoto\.github\.io\/");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
      &nbsp;
    </div>   
    <div class="nav-footer-center">
<p>Made with ❤️ and Quarto</p>
</div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>




</body></html>